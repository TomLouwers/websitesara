let quizData=null,currentQuestionIndex=0,score=0,currentItem=null,hasAnswered=!1,isPlayingAudio=!1,wrongAnswers=[],tagStats={};async function loadQuizData(){try{const e=localStorage.getItem("selectedGroep")||"groep4",t=localStorage.getItem("selectedMoment")||"m4",n=e.replace("groep",""),o=t.charAt(0).toUpperCase();document.getElementById("breadcrumbLevel").textContent=`Groep ${n} (${o}${n})`;const a=CONFIG.subjectFilePaths?.werkwoordspelling?.[e]?.[t];if(!a)throw new Error(`Geen data beschikbaar voor ${e} ${t}`);const r=await fetch(a);if(!r.ok)throw new Error(`Could not load ${a}`);if(quizData=await r.json(),!quizData.set||!quizData.items||0===quizData.items.length)throw new Error("Ongeldige data structuur");console.log("Quiz data geladen:",quizData),showQuestion(0)}catch(e){console.error("Error loading quiz data:",e),alert("Kon de spelling data niet laden. "+e.message),window.location.href="index.html"}}function showQuestion(e){e>=quizData.items.length?showResults():(currentQuestionIndex=e,currentItem=quizData.items[e],hasAnswered=!1,isPlayingAudio=!1,updateProgress(),resetUI(),updateVerbTenseInstruction(),document.getElementById("spellingInput").focus())}function updateProgress(){const e=document.getElementById("progressLabel"),t=document.getElementById("progressBarFill"),n=quizData.items.length,o=currentQuestionIndex+1,a=o/n*100;e.textContent=`Vraag ${o} van ${n}`,t.style.width=`${a}%`}function updateScore(){document.getElementById("totalCorrect").textContent=score}function updateVerbTenseInstruction(){const e=document.getElementById("verbTenseInstruction");currentItem&&currentItem.tags&&0!==currentItem.tags.length?currentItem.tags.includes("werkwoord_vt")?e.textContent=" in verleden tijd":currentItem.tags.includes("werkwoord_ttt")?e.textContent=" in tegenwoordige tijd":currentItem.tags.includes("voltooid_deelwoord")?e.textContent=" voltooid deelwoord":e.textContent="":e.textContent=""}function resetUI(){const e=document.getElementById("spellingInput");e.value="",e.className="spelling-input",e.disabled=!1;const t=document.getElementById("checkButton");t.disabled=!1,t.classList.remove("hidden");document.getElementById("feedbackSection").classList.add("hidden");document.getElementById("nextButton").classList.add("hidden");const n=document.getElementById("audioPlayButton");n.classList.remove("playing"),n.disabled=!1;document.getElementById("playIcon").textContent="volume_up"}async function playAudio(){if(isPlayingAudio)return;isPlayingAudio=!0;const e=document.getElementById("audioPlayButton"),t=document.getElementById("playIcon");e.disabled=!0,e.classList.add("playing"),t.textContent="volume_up";try{await playAudioFile(currentItem.audio.sentence,currentItem.prompt.sentence);await sleep(300);const e=currentItem.prompt.instruction.replace("{answer}",currentItem.target.answer);await playAudioFile(currentItem.audio.instruction,e)}catch(e){console.error("Error playing audio:",e)}finally{isPlayingAudio=!1,e.disabled=!1,e.classList.remove("playing")}}function playAudioFile(e,t){return new Promise((n,o)=>{const a=new Audio;a.src="exercises/sp/"+e;let r=!1;a.oncanplaythrough=function(){r=!0},a.onended=function(){n(!0)},a.onerror=function(){console.log("Audio file failed, using TTS for:",t),playTextToSpeech(t).then(n).catch(o)},a.play().catch(e=>{console.log("Audio play failed, using TTS for:",t),playTextToSpeech(t).then(n).catch(o)}),setTimeout(()=>{r||(a.pause(),a.src="",console.log("Audio timeout, using TTS for:",t),playTextToSpeech(t).then(n).catch(o))},2e3)})}function playTextToSpeech(e){return new Promise((t,n)=>{if(!("speechSynthesis"in window))return console.error("Speech synthesis not supported"),void t(!1);const o=new SpeechSynthesisUtterance(e);o.lang="nl-NL",o.rate=.9,o.onend=function(){t(!0)},o.onerror=function(e){console.error("Speech synthesis error:",e),t(!1)},window.speechSynthesis.speak(o)})}function sleep(e){return new Promise(t=>setTimeout(t,e))}function checkAnswer(){if(hasAnswered)return;const e=document.getElementById("spellingInput").value;if(!e||""===e.trim())return void alert("Vul eerst een antwoord in!");hasAnswered=!0;const t=quizData.set.flags,n=normalizeAnswer(e,t);(currentItem.target.accept||[currentItem.target.answer]).map(e=>normalizeAnswer(e,t)).includes(n)?handleCorrectAnswer():handleIncorrectAnswer()}function normalizeAnswer(e,t){let n=e;return t.trim&&(n=n.trim()),t.case_sensitive||(n=n.toLowerCase()),n}function handleCorrectAnswer(){score++,updateScore(),currentItem.tags&&currentItem.tags.forEach(e=>{tagStats[e]||(tagStats[e]={correct:0,total:0}),tagStats[e].correct++,tagStats[e].total++});const e=document.getElementById("spellingInput");e.classList.add("correct"),e.disabled=!0,document.getElementById("checkButton").classList.add("hidden");const t=document.getElementById("feedbackSection"),n=document.getElementById("feedbackIcon"),o=document.getElementById("feedbackTitle"),a=document.getElementById("correctAnswerDisplay"),r=document.getElementById("nextButton");t.className="feedback-card correct",n.textContent="ðŸŽ‰",o.textContent=quizData.set.feedback_templates.correct||"Goed gedaan!",a.textContent="Het juiste antwoord is: "+currentItem.target.answer,document.getElementById("extraInfoSection").style.display="none",r.classList.remove("hidden")}function handleIncorrectAnswer(){wrongAnswers.push({index:currentQuestionIndex,item:currentItem,userAnswer:document.getElementById("spellingInput").value}),currentItem.tags&&currentItem.tags.forEach(e=>{tagStats[e]||(tagStats[e]={correct:0,total:0}),tagStats[e].total++});const e=document.getElementById("spellingInput");e.classList.add("incorrect"),e.disabled=!0,e.style.animation="shake 0.4s",setTimeout(()=>{e.style.animation=""},400),document.getElementById("checkButton").classList.add("hidden");const t=document.getElementById("feedbackSection"),n=document.getElementById("feedbackIcon"),o=document.getElementById("feedbackTitle"),a=document.getElementById("correctAnswerDisplay"),r=document.getElementById("nextButton");t.className="feedback-card incorrect",n.textContent="ðŸ’¡",o.textContent=quizData.set.feedback_templates.incorrect||"Nog niet helemaal! Hier is het juiste antwoord:",a.textContent="Het juiste antwoord is: "+currentItem.target.answer;const s=document.getElementById("extraInfoSection"),i=document.getElementById("ruleSection"),c=document.getElementById("tipSection"),l=document.getElementById("examplesSection");if(currentItem.extra_info){let e=!1;if(currentItem.extra_info.rule?(i.style.display="block",document.getElementById("ruleContent").textContent=currentItem.extra_info.rule,e=!0):i.style.display="none",currentItem.extra_info.tip?(c.style.display="block",document.getElementById("tipContent").textContent=currentItem.extra_info.tip,e=!0):c.style.display="none",currentItem.extra_info.examples&&currentItem.extra_info.examples.length>0){l.style.display="block";const t=currentItem.extra_info.examples.map(e=>`<div style="margin: 4px 0;">â€¢ ${e}</div>`).join("");document.getElementById("examplesContent").innerHTML=t,e=!0}else l.style.display="none";s.style.display=e?"block":"none"}else s.style.display="none";r.classList.remove("hidden")}function nextQuestion(){showQuestion(currentQuestionIndex+1)}function pauseQuiz(){confirm("Wil je de quiz pauzeren?")&&(window.location.href="index.html")}function stopQuiz(){showResults()}function showResults(){document.getElementById("quizContainer").style.display="none",document.getElementById("resultsPage").style.display="block",window.scrollTo(0,0);const e=quizData.items.length,t=score,n=wrongAnswers.length;populateHeroBlock(e>0?Math.round(t/e*100):0,t,n),populateSkillsOverview(),populateQuestionAccordion()}function populateHeroBlock(e,t,n){const o=document.getElementById("resultEmoji"),a=document.getElementById("resultHeadline"),r=document.getElementById("resultSummary"),s=document.getElementById("resultGrowthBadge"),i=document.getElementById("growthText");let c,l;e>=90?(c="ðŸŽ‰",l="Wauw! Geweldig gedaan!"):e>=70?(c="ðŸŒŸ",l="Knap gewerkt!"):e>=50?(c="ðŸ’ª",l="Goed bezig!"):(c="ðŸš€",l="Elke vraag maakt je sterker!"),o.textContent=c,a.textContent=l;let d="";if(d=1===t?"Je hebt 1 vraag goed beantwoord!":t>1?`Je hebt ${t} vragen goed beantwoord!`:"Elke vraag is een leerkans!",n>0&&(d+=1===n?" En 1 vraag maakt je weer een beetje sterker!":` En ${n} vragen maken je weer een beetje sterker!`),r.textContent=d,n>0){s.style.display="flex";const e=1===n?"1 leerpunt":`${n} leerpunten`;i.textContent=`Je hebt ${e} verdiend!`}else s.style.display="none"}function populateSkillsOverview(){const e=document.getElementById("skillsChips"),t=document.getElementById("skillsOverview"),n=Object.keys(tagStats);0!==n.length?(t.style.display="block",e.innerHTML="",n.forEach(t=>{const n=tagStats[t],o=Math.round(n.correct/n.total*100),a=document.createElement("div");a.className="skill-chip";let r="";r=o>=80?'<span class="status-icon">âœ…</span>':'<span class="status-icon grow">ðŸ’¡</span><span class="grow-text">Hier kun je nog sterker in worden</span>';const s=formatTagName(t);a.innerHTML=`\n            <div class="skill-info">\n                <div class="skill-name">ðŸ“š ${s}</div>\n                ${r}\n            </div>\n        `,e.appendChild(a)})):t.style.display="none"}function formatTagName(e){return{werkwoord_vt:"Verleden tijd",werkwoord_ttt:"Tegenwoordige tijd",voltooid_deelwoord:"Voltooid deelwoord",verlengingsregel:"Verlengingsregel",open_lettergreep:"Open lettergreep",gesloten_lettergreep:"Gesloten lettergreep",tweetekenklank_ui:"Tweeklank ui",tweetekenklank_ou:"Tweeklank ou",lange_klank_aa:"Lange klank aa",cluster_ng:"Lettercluster ng",cluster_nk:"Lettercluster nk",cluster_sch:"Lettercluster sch",cluster_ch:"Lettercluster ch",ei_ij:"ei of ij",au_ou:"au of ou"}[e]||e}function populateQuestionAccordion(){const e=document.getElementById("questionAccordion"),t=document.getElementById("questionReviewSection");0!==wrongAnswers.length?(t.style.display="block",e.innerHTML="",wrongAnswers.forEach((t,n)=>{const o=t.item,a=t.index+1,r=document.createElement("div");r.className="accordion-item";const s=document.createElement("div");s.className="accordion-header",s.innerHTML=`\n            <div class="accordion-label">\n                <span class="grow-icon">ðŸ’¡</span>\n                <span>Hier kun je nog groeien</span>\n            </div>\n            <div class="accordion-question">Vraag ${a}</div>\n            <i class="material-icons accordion-icon">expand_more</i>\n        `;const i=document.createElement("div");i.className="accordion-content",i.style.display="none";let c="";if(o.extra_info&&(o.extra_info.rule&&(c+=`\n                    <div class="feedback-section-wrapper">\n                        <div class="feedback-section-title">ðŸ“– Spellingregel</div>\n                        <div class="feedback-section-content">${o.extra_info.rule}</div>\n                    </div>\n                `),o.extra_info.tip&&(c+=`\n                    <div class="feedback-tip">\n                        <div class="feedback-tip-title">\n                            <span>ðŸ’¡</span>\n                            <span>Tip</span>\n                        </div>\n                        <div class="feedback-tip-content">${o.extra_info.tip}</div>\n                    </div>\n                `),o.extra_info.examples&&o.extra_info.examples.length>0)){c+=`\n                    <div class="feedback-section-wrapper">\n                        <div class="feedback-section-title">âœ¨ Voorbeelden</div>\n                        <div class="feedback-section-content">${o.extra_info.examples.map(e=>`<div style="margin: 4px 0;">â€¢ ${e}</div>`).join("")}</div>\n                    </div>\n                `}i.innerHTML=`\n            <div class="accordion-answer incorrect">\n                <strong>Jouw antwoord:</strong> ${t.userAnswer||"(geen antwoord)"}\n            </div>\n            <div class="accordion-answer correct">\n                <strong>Juiste antwoord:</strong> ${o.target.answer}\n            </div>\n            ${c}\n        `,s.addEventListener("click",()=>{const e="block"===i.style.display;i.style.display=e?"none":"block",s.querySelector(".accordion-icon").textContent=e?"expand_more":"expand_less"}),r.appendChild(s),r.appendChild(i),e.appendChild(r)})):t.style.display="none"}function restartQuiz(){localStorage.removeItem("autoStartSubject"),localStorage.removeItem("selectedGroep"),localStorage.removeItem("selectedMoment"),window.location.reload()}function goToLanding(){localStorage.removeItem("autoStartSubject"),localStorage.removeItem("selectedGroep"),localStorage.removeItem("selectedMoment"),window.location.href="index.html"}document.addEventListener("DOMContentLoaded",function(){loadQuizData();const e=document.getElementById("spellingInput");e&&e.addEventListener("keypress",function(e){"Enter"!==e.key||hasAnswered||checkAnswer()})});