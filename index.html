<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Website</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* General Styles */
        :root {
            /* Neuroscience-Optimized Color Palette for Enhanced Focus & Reduced Cognitive Load */

            /* Primary: Soft blue - proven to enhance focus, reduce stress, improve cognitive performance */
            --primary-color: #4A7BA7; /* Calm, professional blue */
            --primary-light: #6B9BC3; /* Lighter blue for hover states */
            --primary-dark: #3A5F7D; /* Deeper blue for emphasis */

            /* Secondary: Muted teal - visual interest without overstimulation */
            --secondary-color: #5DADE2; /* Soft cyan-blue */
            --secondary-dark: #4A8FB5; /* Muted teal */

            /* Background: Neutral cool tones reduce eye strain and cognitive load */
            --background-gradient-start: #F4F6F8; /* Very light cool gray */
            --background-gradient-end: #E8EEF2;   /* Slightly cooler light gray */

            --surface-color: #FDFBF7; /* Warm off-white - reduces glare for dyslexic readers */
            --on-surface-color: #2C3E50; /* Dark slate - softer than pure black, reduces harshness */
            --on-background-color: #2C3E50; /* Dark slate for readability on light backgrounds */

            /* Text Hierarchy: Optimized contrast ratios for WCAG AAA compliance */
            --text-color-dark: var(--on-surface-color); /* Primary text - dark slate */
            --text-color-medium: #5A6C7D; /* Secondary text - medium cool gray */
            --text-color-light: #95A5B8; /* Tertiary text - soft gray */

            /* Semantic Colors: Softer saturation reduces stress while maintaining clarity */
            --color-correct: #52C788; /* Softer green - positive feedback without intensity */
            --color-incorrect: #E07A5F; /* Softer coral - signals error without inducing stress */
            --color-info: #5DADE2; /* Soft blue - informational, non-threatening */

            /* Shadow Elevations */
            --shadow-elevation-1: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-elevation-2: 0 4px 8px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
            --shadow-elevation-3: 0 6px 12px rgba(0, 0, 0, 0.2), 0 3px 8px rgba(0, 0, 0, 0.15);

            /* Border Radii */
            --border-radius-card: 12px;
            --border-radius-button: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%);
            min-height: 100vh;
            color: var(--on-background-color); /* Changed to on-background-color for body text */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            letter-spacing: 0.01em; /* Slight increase for better dyslexia readability */
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-card);
            backdrop-filter: blur(5px);
            box-shadow: var(--shadow-elevation-2);
        }

        .header h1 {
            color: var(--on-background-color); /* Dark slate for high contrast */
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(255,255,255,0.8); /* Subtle light shadow for depth */
            font-weight: 700;
        }

        .header p {
            color: var(--text-color-medium); /* Dark gray for readability - no more white on white! */
            font-size: 1.2em;
            font-weight: 300;
        }

        /* Subject Grid Styles */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            justify-content: center;
            padding: 20px;
        }

        .subject-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius-card);
            box-shadow: var(--shadow-elevation-1);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--text-color-dark); /* Default text color for card */
        }

        .subject-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-elevation-2);
        }

        .subject-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .subject-card h3 {
            font-size: 1.6em;
            margin-bottom: 12px;
            color: var(--text-color-dark);
            font-weight: 500;
        }

        .subject-card p {
            font-size: 1em;
            color: var(--text-color-medium);
            line-height: 1.5;
            font-weight: 300;
        }

        /* Quiz Container Styles */
        .quiz-container, .results-container {
            background-color: var(--surface-color);
            border-radius: var(--border-radius-card);
            box-shadow: var(--shadow-elevation-2);
            padding: 40px;
            margin-top: 20px;
            color: var(--text-color-dark); /* Default text color for quiz container */
        }

        .quiz-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .quiz-header h2 {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .quiz-progress {
            background-color: #e0e0e0; /* Light grey for empty part of progress bar */
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .quiz-progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--secondary-color);
            border-radius: 10px;
            transition: width 0.4s ease-in-out;
        }

        #questionCounter {
            font-size: 1em;
            color: var(--text-color-medium);
            font-weight: 400;
        }

        .question-container {
            margin-bottom: 30px;
            text-align: center;
        }

        .reading-content {
            background-color: #f5f5f5; /* Very light grey */
            border: 1px solid #eeeeee; /* Lighter border */
            border-radius: var(--border-radius-card);
            padding: 25px;
            margin-bottom: 30px;
            text-align: left;
            line-height: 1.7;
            font-size: 1.05em;
            color: var(--text-color-dark);
            max-height: 350px;
            overflow-y: auto;
            overflow-x: auto; /* Allow horizontal scroll for wide content */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            word-wrap: break-word;
        }

        /* Responsive table container for mobile */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .table-container table {
            min-width: 100%;
            width: max-content; /* Allow table to be as wide as needed */
        }

        .question-text {
            font-size: 1.5em;
            color: var(--text-color-dark);
            margin-bottom: 30px;
            line-height: 1.6;
            font-weight: 400;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
        }

        .option {
            background-color: #f8f8f8; /* Off-white for options */
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius-button);
            padding: 18px 25px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-size: 1.15em;
            color: var(--text-color-dark);
            box-shadow: var(--shadow-elevation-1);
        }

        .option:hover {
            background-color: #eff0f0;
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-elevation-1);
        }

        .option.selected {
            background-color: #e3f2fd; /* Light blue (Blue 50) for selection */
            border-color: var(--primary-color);
            color: var(--text-color-dark);
            box-shadow: var(--shadow-elevation-1);
            transform: translateY(0);
        }

        .option.correct {
            background-color: #e8f5e9; /* Light green (Green 50) */
            border-color: var(--color-correct);
            color: var(--color-correct);
            font-weight: bold;
            box-shadow: var(--shadow-elevation-1);
        }

        .option.incorrect {
            background-color: #ffebee; /* Light red (Red 50) */
            border-color: var(--color-incorrect);
            color: var(--color-incorrect);
            font-weight: bold;
            box-shadow: var(--shadow-elevation-1);
        }

        .textarea-answer {
            width: 100%;
            min-height: 150px;
            padding: 18px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius-button);
            font-size: 1.15em;
            font-family: 'Lexend', sans-serif;
            resize: vertical;
            margin-top: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            color: var(--text-color-dark); /* Ensure text in textarea is dark */
            letter-spacing: 0.01em; /* Better readability for dyslexic users */
            line-height: 1.6; /* Increased line height for better readability */
        }
        .textarea-answer:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.2);
        }

        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: var(--border-radius-button);
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            box-shadow: var(--shadow-elevation-1);
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: var(--shadow-elevation-2);
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: var(--text-color-medium);
            box-shadow: var(--shadow-elevation-1);
        }

        .btn-secondary:hover {
            background-color: #c0c0c0;
            color: var(--text-color-dark);
            transform: translateY(-3px);
            box-shadow: var(--shadow-elevation-2);
        }

        .hidden {
            display: none !important;
        }

        /* Results Page Styles */
        .results-container {
            padding: 50px;
            text-align: center;
            margin-top: 20px;
        }

        .results-score {
            font-size: 3.5em;
            color: var(--secondary-color);
            margin-bottom: 25px;
            font-weight: 700;
        }

        .results-message {
            font-size: 1.6em;
            color: var(--text-color-dark);
            margin-bottom: 40px;
            font-weight: 400;
        }

        /* Specific text color for highscore in theme cards */
        .subject-card p[style*="color: var(--primary-color)"] {
            color: var(--primary-color) !important; /* Ensure primary color for highscore text */
        }

        /* NEW: Styles for the feedback and tooltip section */
        #feedbackSection {
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--border-radius-card);
            text-align: left;
            box-shadow: var(--shadow-elevation-1);
        }

        #feedbackSection.correct {
            background-color: #e8f5e9; /* Light green */
            border-left: 5px solid var(--color-correct);
            color: var(--text-color-dark);
        }

        #feedbackSection.incorrect {
            background-color: #ffebee; /* Light red */
            border-left: 5px solid var(--color-incorrect);
            color: var(--text-color-dark);
        }

        #feedbackSection h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }

        #feedbackSection p {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        #feedbackSection ul {
            list-style: disc;
            margin-left: 20px;
            margin-top: 10px;
        }

        #feedbackSection ul li {
            margin-bottom: 5px;
        }

        /* Progress Tracker Styles */
        .progress-tracker {
            background-color: rgba(98, 0, 238, 0.05);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius-card);
            padding: 20px;
            margin-bottom: 25px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .progress-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 15px;
        }

        .progress-tracker-header:hover {
            opacity: 0.8;
        }

        .progress-tracker-title {
            font-size: 1.3em;
            color: var(--primary-color);
            font-weight: 500;
            margin: 0;
        }

        .progress-summary {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .summary-stat.correct {
            color: var(--color-correct);
        }

        .summary-stat.incorrect {
            color: var(--color-incorrect);
        }

        .toggle-icon {
            font-size: 1.5em;
            color: var(--primary-color);
            transition: transform 0.3s ease;
        }

        .progress-tracker.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .category-progress-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .progress-tracker.collapsed .category-progress-container {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .category-item {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius-button);
            padding: 15px;
            box-shadow: var(--shadow-elevation-1);
        }

        .category-name {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-color-dark);
            margin-bottom: 10px;
            text-align: center;
            text-transform: capitalize;
        }

        .category-stats {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-color-medium);
            font-weight: 400;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .stat-value.correct {
            color: var(--color-correct);
        }

        .stat-value.incorrect {
            color: var(--color-incorrect);
        }

        /* L.O.V.A. Mode Styles */
        .lova-mode-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            padding: 10px;
            background-color: rgba(74, 123, 167, 0.05);
            border-radius: var(--border-radius-card);
        }

        .btn-mode {
            background-color: white;
            color: var(--text-color-dark);
            border: 2px solid #e0e0e0;
            padding: 12px 25px;
            border-radius: var(--border-radius-button);
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: 'Lexend', sans-serif;
            font-weight: 500;
        }

        .btn-mode:hover {
            background-color: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-mode.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-elevation-2);
        }

        /* L.O.V.A. Step Progress */
        .lova-progress {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(90deg, #E8EEF2 0%, #F4F6F8 100%);
            border-radius: 12px;
            gap: 10px;
        }

        .lova-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            opacity: 0.4;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .lova-step.active {
            opacity: 1;
            transform: scale(1.05);
            background-color: rgba(74, 123, 167, 0.1);
        }

        .lova-step.completed {
            opacity: 0.7;
            background-color: rgba(82, 199, 136, 0.1);
        }

        .step-icon {
            font-size: 2em;
            display: block;
            margin-bottom: 5px;
        }

        .step-name {
            font-size: 0.9em;
            color: var(--text-color-dark);
            font-weight: 500;
        }

        /* L.O.V.A. Step Container */
        .lova-step-container {
            margin-top: 20px;
        }

        .lova-step-content {
            background-color: #f8f8f8;
            border-radius: var(--border-radius-card);
            padding: 25px;
            margin-bottom: 20px;
        }

        .lova-step-title {
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .lova-instruction {
            font-size: 1.1em;
            color: var(--text-color-medium);
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(93, 173, 226, 0.1);
            border-left: 4px solid var(--secondary-color);
            border-radius: 8px;
        }

        .lova-section {
            margin-bottom: 25px;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius-button);
            box-shadow: var(--shadow-elevation-1);
        }

        .lova-section h4 {
            font-size: 1.2em;
            color: var(--primary-dark);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .lova-answer {
            font-size: 1.15em;
            color: var(--text-color-dark);
            font-weight: 500;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 6px;
        }

        .lova-list {
            list-style: none;
            padding: 0;
        }

        .lova-list li {
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #f5f5f5;
            border-left: 3px solid var(--secondary-color);
            border-radius: 4px;
        }

        /* Highlighting Tool */
        .highlight-content {
            font-size: 1.1em;
            line-height: 1.8;
            padding: 15px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .highlightable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
            display: inline-block;
        }

        .highlightable:hover {
            background-color: rgba(74, 123, 167, 0.1);
        }

        .highlightable.marked-ruis {
            background-color: #ffebee;
            text-decoration: line-through;
            color: var(--color-incorrect);
        }

        .highlightable.marked-relevant {
            background-color: #e8f5e9;
            font-weight: bold;
            color: var(--color-correct);
        }

        /* Number Input Grid */
        .number-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .number-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .number-input-group label {
            font-size: 0.95em;
            color: var(--text-color-medium);
            font-weight: 500;
        }

        .number-input-group input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
            font-family: 'Lexend', sans-serif;
            transition: border-color 0.2s;
        }

        .number-input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .number-input-group input.correct {
            border-color: var(--color-correct);
            background-color: #e8f5e9;
        }

        .number-input-group input.incorrect {
            border-color: var(--color-incorrect);
            background-color: #ffebee;
        }

        .btn-check {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius-button);
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-check:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-elevation-2);
        }

        /* L.O.V.A. Tool Options */
        .lova-tool-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .tool-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
        }

        .tool-option:hover {
            border-color: var(--primary-light);
            background-color: #f5f5f5;
        }

        .tool-option.selected {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
        }

        .tool-option.correct {
            border-color: var(--color-correct);
            background-color: #e8f5e9;
        }

        .tool-option.incorrect {
            border-color: var(--color-incorrect);
            background-color: #ffebee;
        }

        /* Calculation Steps */
        .calculation-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .berekening-stap {
            background-color: white;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-elevation-1);
        }

        .stap-beschrijving {
            font-size: 1.1em;
            color: var(--text-color-dark);
            font-weight: 500;
            margin-bottom: 10px;
        }

        .stap-uitleg {
            font-size: 0.95em;
            color: var(--text-color-medium);
            margin-bottom: 15px;
            font-style: italic;
        }

        .berekening-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .berekening-input input {
            flex: 1;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Lexend', sans-serif;
        }

        .berekening-input input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .berekening-input input.correct {
            border-color: var(--color-correct);
            background-color: #e8f5e9;
        }

        .berekening-input input.incorrect {
            border-color: var(--color-incorrect);
            background-color: #ffebee;
        }

        .stap-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .stap-feedback.correct {
            color: var(--color-correct);
            background-color: #e8f5e9;
        }

        .stap-feedback.incorrect {
            color: var(--color-incorrect);
            background-color: #ffebee;
        }

        /* Validation Checklist */
        .validation-checklist {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.05em;
        }

        .validation-item:hover {
            background-color: #eff0f0;
        }

        .validation-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .expected-unit {
            color: var(--primary-color);
            font-weight: bold;
        }

        .logic-hint {
            color: var(--text-color-medium);
            font-size: 0.95em;
            font-style: italic;
        }

        .lova-calculated-result {
            font-size: 1.5em;
            color: var(--primary-color);
            font-weight: bold;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            text-align: center;
        }

        /* L.O.V.A. Feedback */
        .lova-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .lova-feedback.correct {
            background-color: #e8f5e9;
            border-left: 4px solid var(--color-correct);
            color: var(--color-correct);
        }

        .lova-feedback.incorrect {
            background-color: #ffebee;
            border-left: 4px solid var(--color-incorrect);
            color: var(--color-incorrect);
        }

        /* L.O.V.A. Navigation Buttons */
        .lova-step-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .lova-next-btn {
            background-color: var(--color-correct);
        }

        .lova-next-btn:hover {
            background-color: #3fa76e;
        }

        .lova-next-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.9em; /* Reduced from 2.2em for better mobile fit */
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }

            .subject-grid {
                grid-template-columns: 1fr;
            }

            .subject-card {
                padding: 25px;
                min-height: 180px;
            }

            .subject-card h3 {
                font-size: 1.3em; /* Reduced from 1.6em for mobile */
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .quiz-container, .results-container {
                padding: 25px;
            }

            .question-text {
                font-size: 1.2em; /* Reduced from 1.3em for better fit */
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }

            .option {
                padding: 15px 20px;
                font-size: 1.05em;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .btn {
                padding: 12px 25px;
                font-size: 1em;
                width: 100%; /* Full width buttons for easier tapping */
            }
            .quiz-controls {
                flex-direction: column;
                gap: 15px;
            }

            /* Progress tracker responsive - optimized for mobile */
            .progress-tracker {
                padding: 12px;
                margin-bottom: 15px;
            }

            .progress-tracker-header {
                margin-bottom: 10px;
            }

            .progress-tracker-title {
                font-size: 1em;
            }

            .progress-summary {
                gap: 12px;
            }

            .summary-stat {
                font-size: 0.95em;
            }

            .toggle-icon {
                font-size: 1.2em;
            }

            .category-progress-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .category-item {
                padding: 10px;
            }

            .category-name {
                font-size: 0.95em;
                margin-bottom: 8px;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .stat-value {
                font-size: 1.2em;
            }

            /* Start collapsed on mobile for better UX */
            .progress-tracker {
                /* Will be controlled by JS */
            }

            /* Mobile-optimized table styles */
            .reading-content {
                padding: 15px; /* Reduce padding on mobile */
                font-size: 0.95em; /* Slightly smaller text */
            }

            .table-container table {
                font-size: 0.85em; /* Smaller font for tables on mobile */
            }

            .table-container th,
            .table-container td {
                padding: 8px !important; /* Reduce padding in table cells */
                min-width: 80px; /* Minimum width for readability */
            }

            /* Add scroll hint for tables */
            .table-container::after {
                content: "‚Üê Scroll horizontaal voor meer ‚Üí";
                display: block;
                text-align: center;
                font-size: 0.75em;
                color: var(--text-color-medium);
                padding: 5px;
                background-color: rgba(74, 123, 167, 0.1);
                border-radius: 0 0 8px 8px;
            }

            /* L.O.V.A. Mobile Styles */
            .lova-mode-toggle {
                flex-direction: column;
                gap: 8px;
            }

            .btn-mode {
                padding: 10px 20px;
                font-size: 0.95em;
            }

            .lova-progress {
                padding: 10px;
                gap: 5px;
            }

            .step-icon {
                font-size: 1.5em;
            }

            .step-name {
                font-size: 0.75em;
            }

            .lova-step-content {
                padding: 15px;
            }

            .lova-step-title {
                font-size: 1.4em;
            }

            .lova-instruction {
                font-size: 0.95em;
                padding: 12px;
            }

            .lova-section {
                padding: 15px;
            }

            .number-inputs {
                grid-template-columns: 1fr;
            }

            .lova-step-nav {
                flex-direction: column;
            }

            .berekening-input {
                flex-direction: column;
            }

            .berekening-input button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Sara's Quiz Website</h1>
            <p>Kies een onderwerp en test je kennis!</p>
        </div>

        <div id="landingPage">
            <div class="subject-grid">
                <div class="subject-card" onclick="loadSubject('begrijpendlezen')">
                    <div class="subject-icon">üìñ</div>
                    <h3>Begrijpend Lezen</h3>
                    <p>Test je begrip van teksten en verhalen</p>
                </div>
                <div class="subject-card" onclick="loadSubject('brandaan')">
                    <div class="subject-icon">üèõÔ∏è</div>
                    <h3>Geschiedenis</h3>
                    <p>Ontdek de Nederlandse geschiedenis</p>
                </div>
                <div class="subject-card" onclick="loadSubject('samenvatten')">
                    <div class="subject-icon">‚úçÔ∏è</div>
                    <h3>Samenvatten</h3>
                    <p>Leer teksten kort en bondig samen te vatten</p>
                </div>
                <div class="subject-card" onclick="loadSubject('wereldorientatie')">
                    <div class="subject-icon">üåç</div>
                    <h3>Wereldori√´ntatie</h3>
                    <p>Algemene kennis over de wereld</p>
                </div>
                <div class="subject-card" onclick="loadSubject('woordenschat')">
                    <div class="subject-icon">üìö</div>
                    <h3>Woordenschat</h3>
                    <p>Vergroot je vocabulaire</p>
                </div>
                <div class="subject-card" onclick="loadSubject('verhaaltjessommen')">
                    <div class="subject-icon">üî¢</div>
                    <h3>Verhaaltjessommen</h3>
                    <p>Reken mee met CITO-niveau verhaaltjes</p>
                </div>
                <div class="subject-card" onclick="loadSubject('basisvaardigheden')">
                    <div class="subject-icon">üßÆ</div>
                    <h3>Basisvaardigheden</h3>
                    <p>Oefen de rekenkundige basisvaardigheden</p>
                </div>
               <a href="modules/leesstrategie√´n/leesstrategie√´n.html" class="subject-card module-card">
                    <div class="subject-icon">üéØ</div>
                    <h3>Leesstrategie√´n</h3>
                    <p>Oefen en versterk je leesstrategie√´n</p>
                </a>
            </div>
        </div>

        <div id="themePage" style="display: none;">
            <div class="quiz-container">
                <h2 id="subjectTitle">Kies een thema</h2>
                <div id="themeGrid" class="subject-grid"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goToLanding()">
                        <i class="material-icons">arrow_back</i> Terug naar onderwerpen
                    </button>
                </div>
            </div>
        </div>

        <div id="quizPage" class="quiz-container" style="display: none;">
            <!-- Progress Tracker Section -->
            <div id="progressTracker" class="progress-tracker">
                <div class="progress-tracker-header" onclick="toggleProgressTracker()">
                    <h3 class="progress-tracker-title">üìä Voortgang</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="progress-summary">
                            <span class="summary-stat correct">‚úì <span id="totalCorrect">0</span></span>
                            <span class="summary-stat incorrect">‚úó <span id="totalIncorrect">0</span></span>
                        </div>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                </div>
                <div id="categoryProgress" class="category-progress-container"></div>
            </div>

            <div class="quiz-header">
                <h2 id="quizTitle">Quiz</h2>

                <!-- L.O.V.A. Mode Toggle (only shown for verhaaltjessommen) -->
                <div id="lovaModeToggle" class="lova-mode-toggle hidden">
                    <button class="btn-mode active" data-mode="lova" onclick="setLovaMode('lova')">
                        üìã L.O.V.A. Stappenplan
                    </button>
                    <button class="btn-mode" data-mode="practice" onclick="setLovaMode('practice')">
                        ‚ö° Snelle Oefening
                    </button>
                </div>

                <!-- L.O.V.A. Step Progress Indicator -->
                <div id="lovaProgress" class="lova-progress hidden">
                    <div class="lova-step active" data-step="1">
                        <span class="step-icon">üìñ</span>
                        <span class="step-name">Lezen</span>
                    </div>
                    <div class="lova-step" data-step="2">
                        <span class="step-icon">üóÉÔ∏è</span>
                        <span class="step-name">Ordenen</span>
                    </div>
                    <div class="lova-step" data-step="3">
                        <span class="step-icon">‚úçÔ∏è</span>
                        <span class="step-name">Vormen</span>
                    </div>
                    <div class="lova-step" data-step="4">
                        <span class="step-icon">‚úÖ</span>
                        <span class="step-name">Antwoorden</span>
                    </div>
                </div>

                <div class="quiz-progress">
                    <div class="quiz-progress-bar" id="progressBar"></div>
                </div>
                <div id="questionCounter">Vraag 1 van 1</div>
            </div>

            <div class="question-container">
                <div id="readingContent" class="reading-content hidden"></div>
                <div class="question-text" id="questionText"></div>

                <!-- L.O.V.A. Step Containers -->
                <div id="lovaStepContainer" class="lova-step-container hidden">
                    <!-- Stap 1: Lezen -->
                    <div id="lovaStap1" class="lova-step-content hidden">
                        <h3 class="lova-step-title">üìñ Stap 1: Lezen</h3>
                        <p class="lova-instruction">Lees de som twee keer: eerst voor de context, dan voor de precieze vraag.</p>

                        <div class="lova-section">
                            <h4>Wat wordt er gevraagd?</h4>
                            <p id="lovaHoofdvraag" class="lova-answer"></p>
                        </div>

                        <div class="lova-section">
                            <h4>Onderstreep de ruis (onnodige informatie):</h4>
                            <div id="lovaHighlightContent" class="highlight-content"></div>
                            <div id="lovaRuisFeedback" class="lova-feedback hidden"></div>
                        </div>

                        <div class="lova-section">
                            <h4>Welke tussenstappen zijn nodig?</h4>
                            <ul id="lovaTussenstappen" class="lova-list"></ul>
                        </div>

                        <button class="btn lova-next-btn" onclick="goToLovaStep(2)">
                            Volgende Stap: Ordenen ‚Üí
                        </button>
                    </div>

                    <!-- Stap 2: Ordenen -->
                    <div id="lovaStap2" class="lova-step-content hidden">
                        <h3 class="lova-step-title">üóÉÔ∏è Stap 2: Ordenen</h3>
                        <p class="lova-instruction">Verzamel de relevante getallen en kies de juiste wiskundige tool.</p>

                        <div class="lova-section">
                            <h4>Vul de relevante getallen in:</h4>
                            <div id="lovaNumberInputs" class="number-inputs"></div>
                            <button class="btn-check" onclick="checkLovaNumbers()">Controleer getallen</button>
                            <div id="lovaNumberFeedback" class="lova-feedback hidden"></div>
                        </div>

                        <div class="lova-section">
                            <h4>Welke wiskundige tool ga je gebruiken?</h4>
                            <div id="lovaToolOptions" class="lova-tool-options"></div>
                            <div id="lovaToolFeedback" class="lova-feedback hidden"></div>
                        </div>

                        <div class="lova-step-nav">
                            <button class="btn btn-secondary" onclick="goToLovaStep(1)">
                                ‚Üê Terug naar Lezen
                            </button>
                            <button class="btn lova-next-btn" onclick="goToLovaStep(3)">
                                Volgende Stap: Vormen ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Stap 3: Vormen -->
                    <div id="lovaStap3" class="lova-step-content hidden">
                        <h3 class="lova-step-title">‚úçÔ∏è Stap 3: Vormen</h3>
                        <p class="lova-instruction">Voer de berekening stap voor stap uit.</p>

                        <div id="lovaCalculationSteps" class="calculation-steps"></div>

                        <div class="lova-step-nav">
                            <button class="btn btn-secondary" onclick="goToLovaStep(2)">
                                ‚Üê Terug naar Ordenen
                            </button>
                            <button class="btn lova-next-btn" id="lovaStap3NextBtn" onclick="goToLovaStep(4)" disabled>
                                Volgende Stap: Antwoorden ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Stap 4: Antwoorden -->
                    <div id="lovaStap4" class="lova-step-content hidden">
                        <h3 class="lova-step-title">‚úÖ Stap 4: Antwoorden</h3>
                        <p class="lova-instruction">Controleer je antwoord en kies het juiste antwoord uit de opties.</p>

                        <div class="lova-section">
                            <h4>Je hebt berekend:</h4>
                            <p id="lovaCalculatedAnswer" class="lova-calculated-result"></p>
                        </div>

                        <div class="lova-section">
                            <h4>Controleer:</h4>
                            <div class="validation-checklist">
                                <label class="validation-item">
                                    <input type="checkbox" id="lovaCheckUnit" onchange="updateLovaValidation()">
                                    <span>Klopt de eenheid? <span id="lovaExpectedUnit" class="expected-unit"></span></span>
                                </label>
                                <label class="validation-item">
                                    <input type="checkbox" id="lovaCheckLogic" onchange="updateLovaValidation()">
                                    <span>Is het antwoord logisch? <span id="lovaLogicCheck" class="logic-hint"></span></span>
                                </label>
                            </div>
                        </div>

                        <div class="lova-section">
                            <h4>Kies nu het juiste antwoord:</h4>
                            <div id="lovaFinalOptions" class="options-container"></div>
                        </div>

                        <div class="lova-step-nav">
                            <button class="btn btn-secondary" onclick="goToLovaStep(3)">
                                ‚Üê Terug naar Vormen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Regular quiz content (for non-L.O.V.A. mode) -->
                <div id="regularQuizContent">
                    <div id="optionsContainer" class="options-container"></div>
                    <textarea id="textareaAnswer" class="textarea-answer hidden" placeholder="Typ hier je antwoord..."></textarea>
                </div>
            </div>

            <div id="feedbackSection" class="hidden">
                <h4 id="feedbackTitle"></h4>
                <p id="feedbackMessage"></p>
                <p id="correctAnswerDisplay" class="hidden"></p>
                <p id="extraInfoDisplay" class="hidden"></p> <div id="strategyAndTips" class="hidden">
                    <h4>Strategie</h4>
                    <p id="strategyText"></p>
                    <h4>Tips</h4>
                    <ul id="tipsList"></ul>
                </div>
            </div>

            <div class="quiz-controls">
                <button class="btn btn-secondary" onclick="goToLanding()">
                    <i class="material-icons">arrow_back</i> Terug
                </button>
                <div>
                    <button class="btn" id="submitBtn" onclick="submitAnswer()">
                        <i class="material-icons">check_circle_outline</i> Controleer Antwoord
                    </button>
                    <button class="btn hidden" id="nextBtn" onclick="nextQuestion()">
                        Volgende Vraag <i class="material-icons">arrow_forward</i>
                    </button>
                </div>
            </div>
        </div>

        <div id="resultsPage" class="results-container" style="display: none;">
            <div class="results-score" id="finalScore">0/0</div>
            <div class="results-message" id="resultsMessage">Goed gedaan!</div>
            <button class="btn" onclick="goToLanding()">
                <i class="material-icons">refresh</i> Nieuwe Quiz
            </button>
        </div>
    </div>

    <script>
        // Quiz data will be loaded from JSON files
        let quizData = {};
        const jsonPath = './'; // Assuming JSON files are in the same directory

        // Quiz state
        let currentQuiz = null;
        let randomizedQuestions = []; // Array to hold randomized questions
        let currentSubject = null;
        let currentTheme = null; // Track current theme for highscore
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let selectedAnswer = null;
        let hasAnswered = false;

        // Progress tracker by category
        let categoryProgress = {};
        let isProgressTrackerCollapsed = false;

        // Toggle progress tracker visibility
        function toggleProgressTracker() {
            const tracker = document.getElementById('progressTracker');
            isProgressTrackerCollapsed = !isProgressTrackerCollapsed;

            if (isProgressTrackerCollapsed) {
                tracker.classList.add('collapsed');
            } else {
                tracker.classList.remove('collapsed');
            }
        }

        // Check if mobile device
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }

        // Highscore management
        function getHighscoreKey(subject, theme) {
            return `highscore_${subject}_${theme || 'all'}`;
        }

        function getHighscore(subject, theme) {
            const key = getHighscoreKey(subject, theme);
            const stored = localStorage.getItem(key);
            return stored ? parseInt(stored) : 0;
        }

        function saveHighscore(subject, theme, score) {
            const key = getHighscoreKey(subject, theme);
            const currentHighscore = getHighscore(subject, theme);
            if (score > currentHighscore) {
                localStorage.setItem(key, score.toString());
                return true; // New highscore achieved
            }
            return false; // No new highscore
        }

        // Get user name (you can modify this to get from a form or prompt)
        function getUserName() {
            let name = localStorage.getItem('userName');
            if (!name) {
                name = prompt('Wat is je naam?') || 'Speler';
                localStorage.setItem('userName', name);
            }
            return name;
        }

        // Initialize category progress tracker
        function initializeCategoryProgress(questions) {
            categoryProgress = {};

            // Extract all unique categories from the questions
            const categories = [...new Set(questions.map(q => q.theme).filter(theme => theme))];

            // Initialize counters for each category
            categories.forEach(category => {
                categoryProgress[category] = {
                    correct: 0,
                    incorrect: 0
                };
            });

            // Update the display
            updateProgressTrackerDisplay();
        }

        // Update category progress after answering
        function updateCategoryProgress(theme, isCorrect) {
            if (!theme || !categoryProgress[theme]) return;

            if (isCorrect) {
                categoryProgress[theme].correct++;
            } else {
                categoryProgress[theme].incorrect++;
            }

            // Update the display
            updateProgressTrackerDisplay();
        }

        // Display the progress tracker
        function updateProgressTrackerDisplay() {
            const container = document.getElementById('categoryProgress');
            container.innerHTML = '';

            // Calculate totals
            let totalCorrect = 0;
            let totalIncorrect = 0;

            // Sort categories alphabetically for consistent display
            const sortedCategories = Object.keys(categoryProgress).sort();

            sortedCategories.forEach(category => {
                const stats = categoryProgress[category];
                totalCorrect += stats.correct;
                totalIncorrect += stats.incorrect;

                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-item';

                categoryElement.innerHTML = `
                    <div class="category-name">${category}</div>
                    <div class="category-stats">
                        <div class="stat-item">
                            <span class="stat-label">Goed</span>
                            <span class="stat-value correct">${stats.correct}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Fout</span>
                            <span class="stat-value incorrect">${stats.incorrect}</span>
                        </div>
                    </div>
                `;

                container.appendChild(categoryElement);
            });

            // Update summary totals
            document.getElementById('totalCorrect').textContent = totalCorrect;
            document.getElementById('totalIncorrect').textContent = totalIncorrect;
        }

        // Shuffle array function (Fisher-Yates algorithm)
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy to avoid modifying original
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Create flattened and randomized question list
        function createRandomizedQuestions(data) {
            const flatQuestions = [];
            
            data.forEach(item => {
                if (item.questions && Array.isArray(item.questions)) {
                    // For items with multiple sub-questions
                    item.questions.forEach(question => {
                        flatQuestions.push({
                            content: item.content,
                            visual: item.visual, // Add visual data
                            question: question.question,
                            options: question.options,
                            correct: question.correct,
                            originalId: item.id,
                            theme: item.theme,
                            title: item.title,
                            // Add strategy and tips here if they are directly on the sub-question object
                            strategy: question.strategy,
                            tips: question.tips,
                            possible_answer: question.possible_answer, // Add possible_answer for open questions
                            extra_info: question.extra_info // NIEUW: extra_info toevoegen
                        });
                    });
                } else if (item.question) {
                    // For items with single question (like samenvatten)
                    flatQuestions.push({
                        content: item.content,
                        visual: item.visual, // Add visual data
                        question: item.question,
                        options: item.options,
                        correct: item.correct, // For multiple choice, this is the index. For open, this might be the answer text.
                        originalId: item.id,
                        theme: item.theme,
                        title: item.title,
                        // Add strategy and tips here if they are directly on the main item object
                        strategy: item.strategy,
                        tips: item.tips,
                        possible_answer: item.possible_answer, // Add possible_answer for open questions
                        extra_info: item.extra_info // NIEUW: extra_info toevoegen
                    });
                }
            });
            
            return shuffleArray(flatQuestions);
        }

        // Load JSON file
        async function loadJsonFile(filename) {
            try {
                // Add cache-busting parameter to prevent browser from using cached version
                const cacheBuster = new Date().getTime();
                const response = await fetch(jsonPath + filename + '?v=' + cacheBuster);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error loading JSON file:', error);
                alert('Fout bij het laden van het bestand. Controleer of de bestanden beschikbaar zijn.');
                return null;
            }
        }

        // Load subject and show themes
        async function loadSubject(subject) {
            const filename = subject + ' - Template.json';
            const data = await loadJsonFile(filename);
        
            if (!data) return;
        
            quizData[subject] = data; // Store the full data for the subject
            currentSubject = subject;
        
            // Extract themes. Ensure 'theme' property exists for all items if you expect them to be categorized.
            const themes = [...new Set(data.map(item => item.theme).filter(theme => theme))];
			console.log("Loaded themes for subject:", subject, themes);
			
            // Transition to theme selection page
            showThemeSelection(subject, themes, data);
        }

		// Show theme selection page
		function showThemeSelection(subject, themes, data) {
			document.getElementById('landingPage').style.display = 'none';
			document.getElementById('themePage').style.display = 'block';
		
			const titles = {
				begrijpendlezen: 'Begrijpend Lezen',
				brandaan: 'Geschiedenis',
				samenvatten: 'Samenvatten',
				wereldorientatie: 'Wereldori√´ntatie',
				woordenschat: 'Woordenschat',
				verhaaltjessommen: 'Verhaaltjessommen',
				basisvaardigheden: 'Basisvaardigheden'
			};
		
			document.getElementById('subjectTitle').textContent = titles[subject] + ' - Kies een thema';
		
			const themeGrid = document.getElementById('themeGrid');
			themeGrid.innerHTML = '';
			
			const userName = getUserName();
		
			// Calculate total questions for "all themes"
			let totalAllQuestions = 0;
			data.forEach(item => {
				if (Array.isArray(item.questions)) {
					totalAllQuestions += item.questions.length;
				} else if (item.question) {
					totalAllQuestions += 1;
				}
			});
		
			// Option to select all themes
			const allThemeCard = document.createElement('div');
			allThemeCard.className = 'subject-card';
			allThemeCard.onclick = () => startQuizWithTheme(subject, null); // Pass null for all themes
			const allHighscore = getHighscore(subject, null);
			allThemeCard.innerHTML = `
				<div class="subject-icon">üéØ</div>
				<h3>Alle thema's</h3>
				<p>${totalAllQuestions} vragen beschikbaar</p>
				<p style="color: var(--primary-color); font-weight: bold; margin-top: 5px;">${userName}, je huidige highscore: ${allHighscore}</p>
			`;
			themeGrid.appendChild(allThemeCard);
		
			themes.forEach(theme => {
				const filteredItems = data.filter(item => item.theme === theme);
				let questionCount = 0;
		
				filteredItems.forEach(item => {
					if (Array.isArray(item.questions)) {
						questionCount += item.questions.length;
					} else if (item.question) { // Check for single question items
						questionCount += 1;
					}
				});
		
				const themeCard = document.createElement('div');
				themeCard.className = 'subject-card';
				themeCard.onclick = () => startQuizWithTheme(subject, theme);
				const themeHighscore = getHighscore(subject, theme);
				themeCard.innerHTML = `
					<div class="subject-icon">üìù</div>
					<h3>${theme}</h3>
					<p>${questionCount} vragen beschikbaar</p>
					<p style="color: var(--primary-color); font-weight: bold; margin-top: 5px;">${userName}, je huidige highscore: ${themeHighscore}</p>
				`;
				themeGrid.appendChild(themeCard);
			});
		}

        // Start quiz with specific theme
        function startQuizWithTheme(subject, theme) {
            // Store current theme for highscore tracking
            currentTheme = theme;
            
            // currentQuiz should be set from the globally available quizData[subject]
            let dataToUse = quizData[subject]; 
            
            if (theme) {
                // Filter data by theme
                currentQuiz = dataToUse.filter(item => item.theme === theme);
            } else {
                // Use all data for the subject if no theme is selected
                currentQuiz = dataToUse;
            }
            
            startQuizWithData(subject); // Proceed to start the quiz with the filtered/full data
        }

        function startQuizWithData(subject) {
            currentQuestionIndex = 0;
            score = 0;
            hasAnswered = false;

            // Create randomized questions from the current quiz data
            randomizedQuestions = createRandomizedQuestions(currentQuiz);
            totalQuestions = randomizedQuestions.length;

            // Initialize category progress tracker (reset to 0)
            initializeCategoryProgress(randomizedQuestions);

            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('themePage').style.display = 'none';
            document.getElementById('quizPage').style.display = 'block';
            document.getElementById('resultsPage').style.display = 'none';

            // Set quiz title
            const titles = {
                begrijpendlezen: 'Begrijpend Lezen',
                brandaan: 'Geschiedenis',
                samenvatten: 'Samenvatten',
                wereldorientatie: 'Wereldori√´ntatie',
                woordenschat: 'Woordenschat',
                verhaaltjessommen: 'Verhaaltjessommen',
                basisvaardigheden: 'Basisvaardigheden'
            };
            document.getElementById('quizTitle').textContent = titles[subject] || 'Quiz';

            // Show L.O.V.A. mode toggle only for verhaaltjessommen
            const lovaModeToggle = document.getElementById('lovaModeToggle');
            if (subject === 'verhaaltjessommen') {
                lovaModeToggle.classList.remove('hidden');
                // Check if any question has L.O.V.A. data
                const hasAnyLovaData = randomizedQuestions.some(q => q.lova && q.lova.stap1_lezen);
                if (hasAnyLovaData) {
                    // Enable L.O.V.A. mode by default
                    lovaMode = 'lova';
                    document.querySelectorAll('.btn-mode').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.mode === 'lova') {
                            btn.classList.add('active');
                        }
                    });
                }
            } else {
                lovaModeToggle.classList.add('hidden');
                lovaMode = 'practice';
            }

            // Start collapsed on mobile for better UX
            const tracker = document.getElementById('progressTracker');
            if (isMobileDevice()) {
                isProgressTrackerCollapsed = true;
                tracker.classList.add('collapsed');
            } else {
                isProgressTrackerCollapsed = false;
                tracker.classList.remove('collapsed');
            }

            loadCurrentQuestion();
        }

        // Render visual data (tables) as HTML with mobile-responsive wrapper
        function renderVisualData(visualData) {
            if (!visualData || visualData.type !== 'table') {
                return '';
            }

            // Wrap table in responsive container for mobile scrolling
            let html = '<div class="table-container">';
            html += '<table style="width: 100%; border-collapse: collapse; background-color: white;">';

            // Add headers
            html += '<thead><tr>';
            visualData.headers.forEach(header => {
                html += `<th style="border: 2px solid #4A7BA7; padding: 12px; background-color: #4A7BA7; color: white; font-weight: 500; text-align: left; white-space: nowrap;">${header}</th>`;
            });
            html += '</tr></thead>';

            // Add rows
            html += '<tbody>';
            visualData.rows.forEach((row, rowIndex) => {
                const bgColor = rowIndex % 2 === 0 ? '#f8f8f8' : '#ffffff';
                html += `<tr style="background-color: ${bgColor};">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #e0e0e0; padding: 10px; color: #2C3E50; word-wrap: break-word;">${cell}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            html += '</div>'; // Close responsive container

            return html;
        }

        function loadCurrentQuestion() {
            if (currentQuestionIndex >= randomizedQuestions.length) {
                showResults();
                return;
            }

            const currentQuestion = randomizedQuestions[currentQuestionIndex];

            // Update progress
            const progress = (currentQuestionIndex / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionCounter').textContent = `Vraag ${currentQuestionIndex + 1} van ${totalQuestions}`;

            // Show reading content if available
            const readingContent = document.getElementById('readingContent');
            if (currentQuestion.content || currentQuestion.visual) {
                let contentHtml = '';

                // Add text content if available
                if (currentQuestion.content) {
                    contentHtml += currentQuestion.content;
                }

                // Add visual table if available
                if (currentQuestion.visual) {
                    contentHtml += renderVisualData(currentQuestion.visual);
                }

                readingContent.innerHTML = contentHtml;
                readingContent.classList.remove('hidden');
            } else {
                readingContent.classList.add('hidden');
            }

            // Load question
            document.getElementById('questionText').textContent = currentQuestion.question;

            // Check if L.O.V.A. mode is active and question has L.O.V.A. data
            const hasLovaData = currentQuestion.lova && currentQuestion.lova.stap1_lezen;
            const lovaContainer = document.getElementById('lovaStepContainer');
            const regularContainer = document.getElementById('regularQuizContent');

            if (lovaMode === 'lova' && hasLovaData) {
                // Show L.O.V.A. mode
                lovaContainer.classList.remove('hidden');
                regularContainer.classList.add('hidden');

                // Reset L.O.V.A. state for new question
                currentLovaStep = 1;
                lovaCalculatedResult = null;

                // Show L.O.V.A. progress
                document.getElementById('lovaProgress').classList.remove('hidden');

                // Load first L.O.V.A. step
                goToLovaStep(1);

                // Hide regular submit/next buttons
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('nextBtn').classList.add('hidden');
            } else {
                // Show regular quiz mode
                lovaContainer.classList.add('hidden');
                regularContainer.classList.remove('hidden');

                // Hide L.O.V.A. progress
                document.getElementById('lovaProgress').classList.add('hidden');

                // Handle different question types
                const optionsContainer = document.getElementById('optionsContainer');
                const textareaAnswer = document.getElementById('textareaAnswer');
                const feedbackSection = document.getElementById('feedbackSection');

                // Hide feedback section and reset classes for new question
                feedbackSection.classList.add('hidden');
                feedbackSection.classList.remove('correct', 'incorrect');
                document.getElementById('correctAnswerDisplay').classList.add('hidden');
                document.getElementById('extraInfoDisplay').classList.add('hidden');
                document.getElementById('strategyAndTips').classList.add('hidden');

                if (currentQuestion.options) {
                    // Multiple choice question
                    optionsContainer.classList.remove('hidden');
                    textareaAnswer.classList.add('hidden');

                    optionsContainer.innerHTML = '';
                    currentQuestion.options.forEach((option, index) => {
                        const optionElement = document.createElement('div');
                        optionElement.className = 'option';
                        optionElement.textContent = typeof option === 'string' ? option : option.text;
                        optionElement.onclick = () => selectOption(index);
                        optionsContainer.appendChild(optionElement);
                    });
                } else {
                    // Open question
                    optionsContainer.classList.add('hidden');
                    textareaAnswer.classList.remove('hidden');
                    textareaAnswer.value = '';
                }

                // Reset UI state
                selectedAnswer = null;
                hasAnswered = false;
                document.getElementById('submitBtn').classList.remove('hidden');
                document.getElementById('nextBtn').classList.add('hidden');
            }
        }

        function selectOption(index) {
            if (hasAnswered) return;

            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect'); // Also remove feedback classes
            });

            // Select new option
            document.querySelectorAll('.option')[index].classList.add('selected');
            selectedAnswer = index;
        }

        function submitAnswer() {
            if (hasAnswered) return;

            const currentQuestion = randomizedQuestions[currentQuestionIndex];
            const feedbackSection = document.getElementById('feedbackSection');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
            const extraInfoDisplay = document.getElementById('extraInfoDisplay'); // NIEUW: extraInfoDisplay element
            const strategyAndTips = document.getElementById('strategyAndTips');
            const strategyText = document.getElementById('strategyText');
            const tipsList = document.getElementById('tipsList');

            feedbackSection.classList.remove('hidden'); // Show feedback section

            if (currentQuestion.options) {
                // Multiple choice
                if (selectedAnswer === null) {
                    alert('Selecteer eerst een antwoord!');
                    feedbackSection.classList.add('hidden'); // Hide if no answer selected
                    return;
                }

                const options = document.querySelectorAll('.option');
                const correctIndex = currentQuestion.correct; // Assuming `correct` stores the index for MC

                if (selectedAnswer === correctIndex) {
                    options[selectedAnswer].classList.add('correct');
                    score++;
                    feedbackSection.classList.add('correct');
                    feedbackTitle.textContent = 'Correct!';
                    feedbackMessage.textContent = 'Dat is helemaal juist!';
                    correctAnswerDisplay.classList.add('hidden');
                    extraInfoDisplay.classList.add('hidden'); // NIEUW: extraInfo verbergen bij correct
                    strategyAndTips.classList.add('hidden');

                    // Update category progress tracker
                    updateCategoryProgress(currentQuestion.theme, true);
                } else {
                    options[selectedAnswer].classList.add('incorrect');
                    // Highlight correct answer if an incorrect one was selected
                    if (options[correctIndex]) {
                        options[correctIndex].classList.add('correct');
                    }
                    feedbackSection.classList.add('incorrect');
                    feedbackTitle.textContent = 'Niet correct!';

                    // Update category progress tracker
                    updateCategoryProgress(currentQuestion.theme, false);

                    // Show error analysis if available for the selected wrong answer
                    const selectedOption = currentQuestion.options[selectedAnswer];
                    const errorAnalysis = (typeof selectedOption === 'object' && selectedOption.foutanalyse) ? selectedOption.foutanalyse : '';

                    if (errorAnalysis) {
                        feedbackMessage.textContent = errorAnalysis;
                    } else {
                        feedbackMessage.textContent = 'Helaas, dat is niet helemaal correct.';
                    }

                    // Show correct answer - handle both string and object format
                    const correctAnswerText = typeof currentQuestion.options[correctIndex] === 'string'
                        ? currentQuestion.options[correctIndex]
                        : currentQuestion.options[correctIndex].text;
                    correctAnswerDisplay.textContent = `Het juiste antwoord was: "${correctAnswerText}"`;
                    correctAnswerDisplay.classList.remove('hidden');
                    strategyAndTips.classList.add('hidden'); // No strategy/tips for MC by default

                    // NIEUW: Toon extra_info bij incorrect antwoord (meerkeuze)
                    if (currentQuestion.extra_info) {
                        if (typeof currentQuestion.extra_info === 'string') {
                            // Simple string format (like brandaan)
                            extraInfoDisplay.innerHTML = `<h4>Achtergrondinfo:</h4><p>${currentQuestion.extra_info}</p>`;
                            extraInfoDisplay.classList.remove('hidden');
                        } else if (currentQuestion.extra_info.concept || currentQuestion.extra_info.berekening) {
                            // New format with concept and berekening
                            let infoHtml = '';
                            if (currentQuestion.extra_info.concept) {
                                infoHtml += `<h4>Concept:</h4><p>${currentQuestion.extra_info.concept}</p>`;
                            }
                            if (currentQuestion.extra_info.berekening && currentQuestion.extra_info.berekening.length > 0) {
                                infoHtml += '<h4>Berekening:</h4><ul>';
                                currentQuestion.extra_info.berekening.forEach(step => {
                                    infoHtml += `<li>${step}</li>`;
                                });
                                infoHtml += '</ul>';
                            }
                            extraInfoDisplay.innerHTML = infoHtml;
                            extraInfoDisplay.classList.remove('hidden');
                        } else if (currentQuestion.extra_info.tips) {
                            // Old format with tips array (like begrijpendlezen)
                            let tipsHtml = '<h4>Extra Tips:</h4><ul>';
                            currentQuestion.extra_info.tips.forEach(tip => {
                                tipsHtml += `<li>${tip}</li>`;
                            });
                            tipsHtml += '</ul>';
                            extraInfoDisplay.innerHTML = tipsHtml;
                            extraInfoDisplay.classList.remove('hidden');
                        } else {
                            extraInfoDisplay.classList.add('hidden');
                        }
                    } else {
                        extraInfoDisplay.classList.add('hidden');
                    }
                }
            } else {
                // Open question (e.g., Samenvatten)
                const userAnswer = document.getElementById('textareaAnswer').value.trim();
                if (!userAnswer) {
                    alert('Vul eerst een antwoord in!');
                    feedbackSection.classList.add('hidden'); // Hide if no answer entered
                    return;
                }
                
                // Compare user answer with possible_answer from JSON (case-insensitive, trimmed)
                const possibleAnswer = currentQuestion.possible_answer ? currentQuestion.possible_answer.toLowerCase().trim() : '';
                const isCorrect = (userAnswer.toLowerCase() === possibleAnswer);

                if (isCorrect) {
                    score++;
                    feedbackSection.classList.add('correct');
                    feedbackTitle.textContent = 'Correct!';
                    feedbackMessage.textContent = 'Je antwoord is helemaal juist!';
                    correctAnswerDisplay.classList.add('hidden');
                    extraInfoDisplay.classList.add('hidden'); // NIEUW: extraInfo verbergen bij correct
                    strategyAndTips.classList.add('hidden');

                    // Update category progress tracker
                    updateCategoryProgress(currentQuestion.theme, true);
                } else {
                    feedbackSection.classList.add('incorrect');
                    feedbackTitle.textContent = 'Niet correct!';
                    feedbackMessage.textContent = 'Helaas, dat is niet helemaal correct. Hier is een voorbeeld van een goed antwoord en wat tips:';

                    // Update category progress tracker
                    updateCategoryProgress(currentQuestion.theme, false);
                    
                    correctAnswerDisplay.textContent = `Voorbeeld antwoord: "${currentQuestion.possible_answer}"`;
                    correctAnswerDisplay.classList.remove('hidden');
                    
                    // Display strategy and tips if available
                    if (currentQuestion.strategy || (currentQuestion.tips && currentQuestion.tips.length > 0)) {
                        strategyAndTips.classList.remove('hidden');
                        strategyText.textContent = currentQuestion.strategy || 'Geen specifieke strategie beschikbaar.';
                        tipsList.innerHTML = '';
                        if (currentQuestion.tips && currentQuestion.tips.length > 0) {
                            currentQuestion.tips.forEach(tip => {
                                const li = document.createElement('li');
                                li.textContent = tip;
                                tipsList.appendChild(li);
                            });
                        } else {
                            tipsList.innerHTML = '<li>Geen specifieke tips beschikbaar.</li>';
                        }
                    } else {
                        strategyAndTips.classList.add('hidden');
                    }

                    // NIEUW: Toon extra_info bij incorrect antwoord (open vraag)
                    if (currentQuestion.extra_info) {
                        extraInfoDisplay.textContent = `Achtergrondinfo: ${currentQuestion.extra_info}`;
                        extraInfoDisplay.classList.remove('hidden');
                    } else {
                        extraInfoDisplay.classList.add('hidden');
                    }
                }
            }

            hasAnswered = true;
            document.getElementById('submitBtn').classList.add('hidden');
            document.getElementById('nextBtn').classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= randomizedQuestions.length) {
                showResults();
            } else {
                loadCurrentQuestion();
            }
        }

        function showResults() {
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('resultsPage').style.display = 'block';
            
            // Check for new highscore
            const isNewHighscore = saveHighscore(currentSubject, currentTheme, score);
            
            // Ensure totalQuestions is not zero to avoid division by zero
            const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
            document.getElementById('finalScore').textContent = `${score}/${totalQuestions}`;
            
            let message = '';
            if (isNewHighscore) {
                message = 'üéâ NIEUWE HIGHSCORE! ';
            }
            
            if (percentage >= 90) {
                message += 'üèÜ Uitstekend! Je bent een echte expert!';
            } else if (percentage >= 70) {
                message += 'üëè Goed gedaan! Je hebt het goed onder de knie!';
            } else if (percentage >= 50) {
                message += 'üëç Niet slecht! Met wat oefening wordt het nog beter!';
            } else {
                message += 'üí™ Blijf oefenen, je kunt het!';
            }
            
            document.getElementById('resultsMessage').textContent = message;
        }

        function goToLanding() {
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('themePage').style.display = 'none';
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('resultsPage').style.display = 'none';
            // Reset quiz state when returning to landing page
            currentQuiz = null;
            randomizedQuestions = [];
            currentSubject = null;
            currentTheme = null;
            currentQuestionIndex = 0;
            score = 0;
            totalQuestions = 0;
            selectedAnswer = null;
            hasAnswered = false;
            // Reset L.O.V.A. state
            lovaMode = 'lova';
            currentLovaStep = 1;
        }

        // ========================================
        // L.O.V.A. Mode Implementation
        // ========================================

        let lovaMode = 'lova'; // 'lova' or 'practice'
        let currentLovaStep = 1; // 1-4
        let lovaUserInputs = {}; // Store user inputs for validation
        let lovaCalculatedResult = null;

        // Set L.O.V.A. mode
        function setLovaMode(mode) {
            lovaMode = mode;

            // Update button states
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // Show/hide L.O.V.A. progress indicator
            const lovaProgress = document.getElementById('lovaProgress');
            if (mode === 'lova') {
                lovaProgress.classList.remove('hidden');
            } else {
                lovaProgress.classList.add('hidden');
            }

            // Reload current question with new mode
            loadCurrentQuestion();
        }

        // Go to specific L.O.V.A. step
        function goToLovaStep(step) {
            currentLovaStep = step;

            // Update step progress indicator
            document.querySelectorAll('.lova-step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 === step) {
                    stepEl.classList.add('active');
                } else if (index + 1 < step) {
                    stepEl.classList.add('completed');
                }
            });

            // Hide all step contents
            document.querySelectorAll('.lova-step-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show current step content
            document.getElementById(`lovaStap${step}`).classList.remove('hidden');

            // Load content for the current step
            const currentQuestion = randomizedQuestions[currentQuestionIndex];
            if (currentQuestion && currentQuestion.lova) {
                switch(step) {
                    case 1:
                        renderLovaStap1(currentQuestion);
                        break;
                    case 2:
                        renderLovaStap2(currentQuestion);
                        break;
                    case 3:
                        renderLovaStap3(currentQuestion);
                        break;
                    case 4:
                        renderLovaStap4(currentQuestion);
                        break;
                }
            }
        }

        // Render Stap 1: Lezen
        function renderLovaStap1(question) {
            const lova = question.lova.stap1_lezen;

            // Show hoofdvraag
            document.getElementById('lovaHoofdvraag').textContent = lova.hoofdvraag;

            // Show tussenstappen
            const tussenstappenList = document.getElementById('lovaTussenstappen');
            tussenstappenList.innerHTML = '';
            lova.tussenstappen.forEach(stap => {
                const li = document.createElement('li');
                li.textContent = stap;
                tussenstappenList.appendChild(li);
            });

            // Create highlightable content
            const content = question.content;
            const highlightContent = document.getElementById('lovaHighlightContent');

            // Split content into sentences
            const sentences = content.split(/\.\s+/);
            let html = '';

            sentences.forEach((sentence, index) => {
                if (sentence.trim()) {
                    const isRuis = lova.ruis.some(r => sentence.includes(r.replace(/\.$/, '')));
                    html += `<span class="highlightable ${isRuis ? 'marked-ruis' : ''}" data-sentence="${index}">${sentence}.</span> `;
                }
            });

            highlightContent.innerHTML = html;

            // Show feedback about identifying ruis
            const feedback = document.getElementById('lovaRuisFeedback');
            feedback.classList.remove('hidden');
            feedback.className = 'lova-feedback correct';
            feedback.textContent = 'üí° Ruis (onnodige informatie) is al gemarkeerd met een rode streep door.';
        }

        // Render Stap 2: Ordenen
        function renderLovaStap2(question) {
            const lova = question.lova.stap2_ordenen;

            // Render number inputs
            const numberInputsContainer = document.getElementById('lovaNumberInputs');
            numberInputsContainer.innerHTML = '';

            Object.entries(lova.relevante_getallen).forEach(([label, value]) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'number-input-group';
                inputGroup.innerHTML = `
                    <label>${label}:</label>
                    <input type="text" data-label="${label}" data-expected="${value}" placeholder="Vul het getal in...">
                `;
                numberInputsContainer.appendChild(inputGroup);
            });

            // Render tool options
            const toolOptionsContainer = document.getElementById('lovaToolOptions');
            toolOptionsContainer.innerHTML = '';

            const toolOptions = [
                'Verhoudingstabel',
                'Optellen/Aftrekken',
                'Vermenigvuldigen/Delen',
                'Formule (Snelheid/Afstand/Tijd)',
                'Combinatoriek'
            ];

            toolOptions.forEach(tool => {
                const option = document.createElement('div');
                option.className = 'tool-option';
                option.textContent = tool;
                option.dataset.tool = tool;
                option.onclick = () => selectTool(option, lova.tool);
                toolOptionsContainer.appendChild(option);
            });
        }

        // Check L.O.V.A. numbers
        function checkLovaNumbers() {
            const inputs = document.querySelectorAll('#lovaNumberInputs input');
            let allCorrect = true;

            inputs.forEach(input => {
                const userValue = input.value.trim();
                const expected = input.dataset.expected;

                if (userValue === expected) {
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                } else {
                    input.classList.remove('correct');
                    input.classList.add('incorrect');
                    allCorrect = false;
                }
            });

            const feedback = document.getElementById('lovaNumberFeedback');
            feedback.classList.remove('hidden');

            if (allCorrect) {
                feedback.className = 'lova-feedback correct';
                feedback.textContent = '‚úì Perfect! Alle getallen zijn correct verzameld.';
            } else {
                feedback.className = 'lova-feedback incorrect';
                feedback.textContent = '‚úó Controleer de rode velden nog eens. Gebruik dezelfde notatie als in de tekst (bijv. ‚Ç¨15,50).';
            }
        }

        // Select tool
        function selectTool(optionElement, expectedTool) {
            // Remove previous selection
            document.querySelectorAll('.tool-option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });

            // Mark as selected
            optionElement.classList.add('selected');

            // Check if correct (flexible matching)
            const feedback = document.getElementById('lovaToolFeedback');
            feedback.classList.remove('hidden');

            const userTool = optionElement.dataset.tool.toLowerCase();
            const expected = expectedTool.toLowerCase();

            if (expected.includes(userTool) || userTool.includes(expected)) {
                optionElement.classList.add('correct');
                feedback.className = 'lova-feedback correct';
                feedback.textContent = '‚úì Goede keuze! Dit is de juiste wiskundige tool voor deze som.';
            } else {
                optionElement.classList.add('incorrect');
                feedback.className = 'lova-feedback incorrect';
                feedback.textContent = `üí° Hint: Bij deze som moet je gebruikmaken van "${expectedTool}".`;
            }
        }

        // Render Stap 3: Vormen
        function renderLovaStap3(question) {
            const lova = question.lova.stap3_vormen;
            const calculationStepsContainer = document.getElementById('lovaCalculationSteps');
            calculationStepsContainer.innerHTML = '';

            lova.bewerkingen.forEach((bewerking, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'berekening-stap';
                stepDiv.innerHTML = `
                    <p class="stap-beschrijving">${bewerking.stap}</p>
                    <p class="stap-uitleg">${bewerking.uitleg}</p>
                    <p><strong>Berekening:</strong> ${bewerking.berekening}</p>
                    <div class="berekening-input">
                        <input type="text"
                               id="lovaCalcStep${index}"
                               data-expected="${bewerking.resultaat}"
                               placeholder="Vul het resultaat in...">
                        <button class="btn-check" onclick="checkCalculationStep(${index}, '${bewerking.resultaat}')">
                            Controleer
                        </button>
                    </div>
                    <div id="lovaCalcFeedback${index}" class="stap-feedback hidden"></div>
                `;
                calculationStepsContainer.appendChild(stepDiv);
            });

            // Check if all steps are complete to enable next button
            updateStap3NextButton();
        }

        // Check calculation step
        function checkCalculationStep(stepIndex, expectedResult) {
            const input = document.getElementById(`lovaCalcStep${stepIndex}`);
            const feedback = document.getElementById(`lovaCalcFeedback${stepIndex}`);
            const userValue = input.value.trim();

            feedback.classList.remove('hidden');

            if (userValue === expectedResult) {
                input.classList.remove('incorrect');
                input.classList.add('correct');
                feedback.className = 'stap-feedback correct';
                feedback.textContent = '‚úì Correct! Je berekening klopt.';

                // Store the result if this is the last step
                const currentQuestion = randomizedQuestions[currentQuestionIndex];
                const totalSteps = currentQuestion.lova.stap3_vormen.bewerkingen.length;
                if (stepIndex === totalSteps - 1) {
                    lovaCalculatedResult = expectedResult;
                }
            } else {
                input.classList.remove('correct');
                input.classList.add('incorrect');
                feedback.className = 'stap-feedback incorrect';
                feedback.textContent = `‚úó Niet helemaal. Het juiste antwoord is ${expectedResult}. Probeer de berekening nog eens stap voor stap.`;
            }

            // Update next button status
            updateStap3NextButton();
        }

        // Update Stap 3 next button status
        function updateStap3NextButton() {
            const nextBtn = document.getElementById('lovaStap3NextBtn');
            const currentQuestion = randomizedQuestions[currentQuestionIndex];

            if (!currentQuestion || !currentQuestion.lova) {
                return;
            }

            const totalSteps = currentQuestion.lova.stap3_vormen.bewerkingen.length;
            let allComplete = true;

            for (let i = 0; i < totalSteps; i++) {
                const input = document.getElementById(`lovaCalcStep${i}`);
                if (!input || !input.classList.contains('correct')) {
                    allComplete = false;
                    break;
                }
            }

            nextBtn.disabled = !allComplete;
        }

        // Render Stap 4: Antwoorden
        function renderLovaStap4(question) {
            const lova = question.lova.stap4_antwoorden;

            // Show calculated answer
            document.getElementById('lovaCalculatedAnswer').textContent = lovaCalculatedResult || lova.antwoord;

            // Show expected unit and logic check
            document.getElementById('lovaExpectedUnit').textContent = `(verwacht: ${lova.verwachte_eenheid})`;
            document.getElementById('lovaLogicCheck').textContent = `(${lova.logica_check})`;

            // Reset checkboxes
            document.getElementById('lovaCheckUnit').checked = false;
            document.getElementById('lovaCheckLogic').checked = false;

            // Render final options
            const optionsContainer = document.getElementById('lovaFinalOptions');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = typeof option === 'string' ? option : option.text;
                optionElement.onclick = () => selectLovaFinalAnswer(index, question.correct);
                optionsContainer.appendChild(optionElement);
            });
        }

        // Update L.O.V.A. validation
        function updateLovaValidation() {
            const unitChecked = document.getElementById('lovaCheckUnit').checked;
            const logicChecked = document.getElementById('lovaCheckLogic').checked;

            // Could add visual feedback here
            if (unitChecked && logicChecked) {
                // User has validated their answer
            }
        }

        // Select final L.O.V.A. answer
        function selectLovaFinalAnswer(selectedIndex, correctIndex) {
            const options = document.querySelectorAll('#lovaFinalOptions .option');

            // Remove previous selection
            options.forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });

            // Mark selection
            options[selectedIndex].classList.add('selected');

            if (selectedIndex === correctIndex) {
                options[selectedIndex].classList.add('correct');
                score++;

                // Update category progress
                const currentQuestion = randomizedQuestions[currentQuestionIndex];
                updateCategoryProgress(currentQuestion.theme, true);

                // Show success message
                setTimeout(() => {
                    alert('üéâ Correct! Je hebt de L.O.V.A.-methode goed toegepast!');
                    nextQuestion();
                }, 500);
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[correctIndex].classList.add('correct');

                // Update category progress
                const currentQuestion = randomizedQuestions[currentQuestionIndex];
                updateCategoryProgress(currentQuestion.theme, false);

                // Show feedback
                const selectedOption = currentQuestion.options[selectedIndex];
                const foutanalyse = (typeof selectedOption === 'object' && selectedOption.foutanalyse) ?
                    selectedOption.foutanalyse : 'Helaas, dat is niet correct.';

                setTimeout(() => {
                    alert(`‚ùå ${foutanalyse}\n\nHet juiste antwoord was: ${typeof currentQuestion.options[correctIndex] === 'string' ? currentQuestion.options[correctIndex] : currentQuestion.options[correctIndex].text}`);
                    nextQuestion();
                }, 500);
            }

            hasAnswered = true;
        }
    </script>
</body>
</html>