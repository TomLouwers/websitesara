class SpellingDictee extends BaseQuizModule{constructor(){super({storagePrefix:"spelling_dictee_",enableProgressTracking:!0}),this.quizData=null,this.tagStats={},this.isPlayingAudio=!1}async init(){try{this.cacheElements({spellingInput:"spellingInput",checkButton:"checkButton",audioPlayButton:"audioPlayButton",playIcon:"playIcon",nextButton:"nextButton",feedbackSection:"feedbackSection",feedbackIcon:"feedbackIcon",feedbackTitle:"feedbackTitle",correctAnswerDisplay:"correctAnswerDisplay",extraInfoSection:"extraInfoSection",ruleSection:"ruleSection",ruleContent:"ruleContent",tipSection:"tipSection",tipContent:"tipContent",examplesSection:"examplesSection",examplesContent:"examplesContent",progressLabel:"progressLabel",progressBarFill:"progressBarFill",totalCorrect:"totalCorrect",breadcrumbLevel:"breadcrumbLevel",verbTenseInstruction:"verbTenseInstruction",quizContainer:"quizContainer",resultsPage:"resultsPage"}),await this.loadQuizData(),this.attachEventListeners(),this.showQuestion(0)}catch(e){console.error("Error initializing spelling dictee:",e),this.showError("Kon de spelling data niet laden. "+e.message)}}async loadQuizData(){try{const e=storage.get("selectedGroep","groep4"),t=storage.get("selectedMoment","m4");if(this.elements.breadcrumbLevel){const n=e.replace("groep",""),s=t.charAt(0).toUpperCase();this.elements.breadcrumbLevel.textContent=`Groep ${n} (${s}${n})`}const n=CONFIG.subjectFilePaths?.werkwoordspelling?.[e]?.[t];if(!n)throw new Error(`Geen data beschikbaar voor ${e} ${t}`);const s=await fetch(n);if(!s.ok)throw new Error(`Could not load ${n}`);if(this.quizData=await s.json(),!this.quizData.set||!this.quizData.items||0===this.quizData.items.length)throw new Error("Ongeldige data structuur");this.initialize(this.quizData.items)}catch(e){throw console.error("Error loading quiz data:",e),e}}attachEventListeners(){const{spellingInput:e,checkButton:t,audioPlayButton:n,nextButton:s}=this.elements;t&&t.addEventListener("click",()=>this.checkAnswer()),e&&e.addEventListener("keypress",e=>{"Enter"!==e.key||this.state.hasAnswered||this.checkAnswer()}),n&&n.addEventListener("click",()=>this.playAudio()),s&&s.addEventListener("click",()=>this.nextQuestion())}showQuestion(e){e>=this.state.totalQuestions?this.showResults():(this.state.currentIndex=e,this.loadCurrentItem(),this.updateProgress(),this.updateScore(),this.resetUI(),this.updateVerbTenseInstruction(),this.elements.spellingInput?.focus())}updateProgress(){const{progressLabel:e,progressBarFill:t}=this.elements,n=this.state.totalQuestions,s=this.state.currentIndex+1,i=s/n*100;e&&(e.textContent=`Vraag ${s} van ${n}`),t&&(t.style.width=`${i}%`)}updateScore(){this.elements.totalCorrect&&(this.elements.totalCorrect.textContent=this.state.score)}updateVerbTenseInstruction(){const{verbTenseInstruction:e}=this.elements;if(!e)return;const t=this.state.currentItem;t&&t.tags&&0!==t.tags.length?t.tags.includes("werkwoord_vt")?e.textContent=" in verleden tijd":t.tags.includes("werkwoord_ttt")?e.textContent=" in tegenwoordige tijd":t.tags.includes("voltooid_deelwoord")?e.textContent=" voltooid deelwoord":e.textContent="":e.textContent=""}resetUI(){const{spellingInput:e,checkButton:t,feedbackSection:n,nextButton:s,audioPlayButton:i,playIcon:a}=this.elements;e&&(e.value="",e.className="spelling-input",e.disabled=!1),t&&(t.disabled=!1,t.classList.remove("hidden")),n&&n.classList.add("hidden"),s&&s.classList.add("hidden"),i&&(i.classList.remove("playing"),i.disabled=!1),a&&(a.textContent="volume_up")}async playAudio(){if(this.isPlayingAudio)return;this.isPlayingAudio=!0;const{audioPlayButton:e,playIcon:t}=this.elements,n=this.state.currentItem;e&&(e.disabled=!0,e.classList.add("playing")),t&&(t.textContent="volume_up");try{const e="data/exercises/sp/"+n.audio.sentence;await this.playAudioFile(e,n.prompt.sentence),await this.sleep(300);const t=n.prompt.instruction.replace("{answer}",n.target.answer),s="data/exercises/sp/"+n.audio.instruction;await this.playAudioFile(s,t)}catch(e){console.error("Error playing audio:",e)}finally{this.isPlayingAudio=!1,e&&(e.disabled=!1,e.classList.remove("playing"))}}async playAudioFile(e,t){try{await audioManager.playAudio(e,t,{timeout:2e3})}catch(e){console.warn("Audio playback failed:",e)}}sleep(e){return new Promise(t=>setTimeout(t,e))}checkAnswer(){if(this.state.hasAnswered)return;const{spellingInput:e}=this.elements,t=e?.value;if(!t||""===t.trim())return void alert("Vul eerst een antwoord in!");this.state.hasAnswered=!0;const n=this.quizData.set.flags,s=this.normalizeAnswer(t,n),i=this.state.currentItem;(i.target.accept||[i.target.answer]).map(e=>this.normalizeAnswer(e,n)).includes(s)?this.handleCorrectAnswer():this.handleIncorrectAnswer(t)}normalizeAnswer(e,t){let n=e;return t.trim&&(n=n.trim()),t.case_sensitive||(n=n.toLowerCase()),n}handleCorrectAnswer(){this.state.score++,this.updateScore();const e=this.state.currentItem;e.tags&&e.tags.forEach(e=>{this.tagStats[e]||(this.tagStats[e]={correct:0,total:0}),this.tagStats[e].correct++,this.tagStats[e].total++});const{spellingInput:t,checkButton:n,feedbackSection:s,feedbackIcon:i,feedbackTitle:a,correctAnswerDisplay:o,extraInfoSection:r,nextButton:l}=this.elements;t&&(t.classList.add("correct"),t.disabled=!0),n&&n.classList.add("hidden"),s&&(s.className="feedback-card correct"),i&&(i.textContent="ðŸŽ‰"),a&&(a.textContent=this.quizData.set.feedback_templates.correct||"Goed gedaan!"),o&&(o.textContent="Het juiste antwoord is: "+e.target.answer),r&&(r.style.display="none"),s&&s.classList.remove("hidden"),l&&l.classList.remove("hidden")}handleIncorrectAnswer(e){const t=this.state.currentItem;this.state.wrongAnswers.push({index:this.state.currentIndex,item:t,userAnswer:e}),t.tags&&t.tags.forEach(e=>{this.tagStats[e]||(this.tagStats[e]={correct:0,total:0}),this.tagStats[e].total++});const{spellingInput:n,checkButton:s,feedbackSection:i,feedbackIcon:a,feedbackTitle:o,correctAnswerDisplay:r,extraInfoSection:l,ruleSection:c,ruleContent:d,tipSection:u,tipContent:p,examplesSection:h,examplesContent:g,nextButton:w}=this.elements;if(n&&(n.classList.add("incorrect"),n.disabled=!0,n.style.animation="shake 0.4s",setTimeout(()=>{n.style.animation=""},400)),s&&s.classList.add("hidden"),i&&(i.className="feedback-card incorrect"),a&&(a.textContent="ðŸ’¡"),o&&(o.textContent=this.quizData.set.feedback_templates.incorrect||"Nog niet helemaal! Hier is het juiste antwoord:"),r&&(r.textContent="Het juiste antwoord is: "+t.target.answer),t.extra_info&&l){let e=!1;if(t.extra_info.rule&&c&&d?(c.style.display="block",d.textContent=t.extra_info.rule,e=!0):c&&(c.style.display="none"),t.extra_info.tip&&u&&p?(u.style.display="block",p.textContent=t.extra_info.tip,e=!0):u&&(u.style.display="none"),t.extra_info.examples&&t.extra_info.examples.length>0&&h&&g){h.style.display="block";const n=t.extra_info.examples.map(e=>`<div style="margin: 4px 0;">â€¢ ${e}</div>`).join("");g.innerHTML=n,e=!0}else h&&(h.style.display="none");l.style.display=e?"block":"none"}else l&&(l.style.display="none");i&&i.classList.remove("hidden"),w&&w.classList.remove("hidden")}nextQuestion(){this.nextItem()?this.showQuestion(this.state.currentIndex):this.showResults()}pauseQuiz(){confirm("Wil je de quiz pauzeren?")&&(window.location.href="index.html")}stopQuiz(){this.showResults()}showResults(){const{quizContainer:e,resultsPage:t}=this.elements;e&&(e.style.display="none"),t&&(t.style.display="block"),window.scrollTo(0,0);const n=this.state.totalQuestions,s=this.state.score,i=this.state.wrongAnswers.length,a=n>0?Math.round(s/n*100):0;this.populateHeroBlock(a,s,i),this.populateSkillsOverview(),this.populateQuestionAccordion()}populateHeroBlock(e,t,n){const s=document.getElementById("resultEmoji"),i=document.getElementById("resultHeadline"),a=document.getElementById("resultSummary"),o=document.getElementById("resultGrowthBadge"),r=document.getElementById("growthText");let l,c;e>=90?(l="ðŸŽ‰",c="Wauw! Geweldig gedaan!"):e>=70?(l="ðŸŒŸ",c="Knap gewerkt!"):e>=50?(l="ðŸ’ª",c="Goed bezig!"):(l="ðŸš€",c="Elke vraag maakt je sterker!"),s&&(s.textContent=l),i&&(i.textContent=c);let d="";if(d=1===t?"Je hebt 1 vraag goed beantwoord!":t>1?`Je hebt ${t} vragen goed beantwoord!`:"Elke vraag is een leerkans!",n>0&&(d+=1===n?" En 1 vraag maakt je weer een beetje sterker!":` En ${n} vragen maken je weer een beetje sterker!`),a&&(a.textContent=d),o)if(n>0){o.style.display="flex";const e=1===n?"1 leerpunt":`${n} leerpunten`;r&&(r.textContent=`Je hebt ${e} verdiend!`)}else o.style.display="none"}populateSkillsOverview(){const e=document.getElementById("skillsChips"),t=document.getElementById("skillsOverview");if(!e||!t)return;const n=Object.keys(this.tagStats);0!==n.length?(t.style.display="block",e.innerHTML="",n.forEach(t=>{const n=this.tagStats[t],s=Math.round(n.correct/n.total*100),i=document.createElement("div");i.className="skill-chip";let a="";a=s>=80?'<span class="status-icon">âœ…</span>':'<span class="status-icon grow">ðŸ’¡</span><span class="grow-text">Hier kun je nog sterker in worden</span>';const o=this.formatTagName(t);i.innerHTML=`\n                <div class="skill-info">\n                    <div class="skill-name">ðŸ“š ${o}</div>\n                    ${a}\n                </div>\n            `,e.appendChild(i)})):t.style.display="none"}formatTagName(e){return{werkwoord_vt:"Verleden tijd",werkwoord_ttt:"Tegenwoordige tijd",voltooid_deelwoord:"Voltooid deelwoord",verlengingsregel:"Verlengingsregel",open_lettergreep:"Open lettergreep",gesloten_lettergreep:"Gesloten lettergreep",tweetekenklank_ui:"Tweeklank ui",tweetekenklank_ou:"Tweeklank ou",lange_klank_aa:"Lange klank aa",cluster_ng:"Lettercluster ng",cluster_nk:"Lettercluster nk",cluster_sch:"Lettercluster sch",cluster_ch:"Lettercluster ch",ei_ij:"ei of ij",au_ou:"au of ou"}[e]||e}populateQuestionAccordion(){const e=document.getElementById("questionAccordion"),t=document.getElementById("questionReviewSection");e&&t&&(0!==this.state.wrongAnswers.length?(t.style.display="block",e.innerHTML="",this.state.wrongAnswers.forEach(t=>{const n=t.item,s=t.index+1,i=document.createElement("div");i.className="accordion-item";const a=document.createElement("div");a.className="accordion-header",a.innerHTML=`\n                <div class="accordion-label">\n                    <span class="grow-icon">ðŸ’¡</span>\n                    <span>Hier kun je nog groeien</span>\n                </div>\n                <div class="accordion-question">Vraag ${s}</div>\n                <i class="material-icons accordion-icon">expand_more</i>\n            `;const o=document.createElement("div");o.className="accordion-content",o.style.display="none";let r="";if(n.extra_info&&(n.extra_info.rule&&(r+=`\n                        <div class="feedback-section-wrapper">\n                            <div class="feedback-section-title">ðŸ“– Spellingregel</div>\n                            <div class="feedback-section-content">${n.extra_info.rule}</div>\n                        </div>\n                    `),n.extra_info.tip&&(r+=`\n                        <div class="feedback-tip">\n                            <div class="feedback-tip-title">\n                                <span>ðŸ’¡</span>\n                                <span>Tip</span>\n                            </div>\n                            <div class="feedback-tip-content">${n.extra_info.tip}</div>\n                        </div>\n                    `),n.extra_info.examples&&n.extra_info.examples.length>0)){r+=`\n                        <div class="feedback-section-wrapper">\n                            <div class="feedback-section-title">âœ¨ Voorbeelden</div>\n                            <div class="feedback-section-content">${n.extra_info.examples.map(e=>`<div style="margin: 4px 0;">â€¢ ${e}</div>`).join("")}</div>\n                        </div>\n                    `}o.innerHTML=`\n                <div class="accordion-answer incorrect">\n                    <strong>Jouw antwoord:</strong> ${t.userAnswer||"(geen antwoord)"}\n                </div>\n                <div class="accordion-answer correct">\n                    <strong>Juiste antwoord:</strong> ${n.target.answer}\n                </div>\n                ${r}\n            `,a.addEventListener("click",()=>{const e="block"===o.style.display;o.style.display=e?"none":"block",a.querySelector(".accordion-icon").textContent=e?"expand_more":"expand_less"}),i.appendChild(a),i.appendChild(o),e.appendChild(i)})):t.style.display="none")}restartQuiz(){storage.remove("autoStartSubject"),storage.remove("selectedGroep"),storage.remove("selectedMoment"),storage.flush(),window.location.reload()}goToLanding(){storage.remove("autoStartSubject"),storage.remove("selectedGroep"),storage.remove("selectedMoment"),storage.flush(),window.location.href="index.html"}showError(e){alert(e),window.location.href="index.html"}}document.addEventListener("DOMContentLoaded",async function(){try{const e=new SpellingDictee;await e.init(),window.spellingDictee=e,window.checkAnswer=()=>e.checkAnswer(),window.nextQuestion=()=>e.nextQuestion(),window.playAudio=()=>e.playAudio(),window.pauseQuiz=()=>e.pauseQuiz(),window.stopQuiz=()=>e.stopQuiz(),window.restartQuiz=()=>e.restartQuiz(),window.goToLanding=()=>e.goToLanding()}catch(e){console.error("Failed to initialize spelling dictee:",e),alert("Kon de quiz niet laden. Probeer het opnieuw."),window.location.href="index.html"}});