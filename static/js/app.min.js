function showFriendlyNotification(e,t="info",n=5e3){const o=document.createElement("div");o.className=`friendly-notification ${t}`,o.setAttribute("role","alert"),o.setAttribute("aria-live","polite");const r={info:"‚ÑπÔ∏è",success:"‚úÖ",warning:"‚ö†Ô∏è",error:"‚ùå"};o.innerHTML=`\n        <span class="notification-icon">${r[t]||r.info}</span>\n        <span class="notification-message">${e}</span>\n        <button class="notification-close" aria-label="Sluiten" onclick="this.parentElement.remove()">√ó</button>\n    `,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10),n>0&&setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},n)}let quizData={};const jsonPath=CONFIG.jsonPath,CACHE_VERSION="1.0.0";let currentQuiz=null,randomizedQuestions=[],currentSubject=null,currentTheme=null,currentQuestionIndex=0,score=0,currentStreak=0,totalQuestions=0,selectedAnswer=null,hasAnswered=!1,wrongAnswers=[],currentQuestionErrors=0,incorrectOptions=new Set,textGroups=[],currentTextIndex=0,currentQuestionInText=0,currentTextGroup=null,useTextGrouping=!1;function renderMathInText(e){if(!e||"string"!=typeof e)return e||"";if("undefined"==typeof katex)return escapeHtml(e);try{let t=e.replace(/\$([^\$]+)\$/g,(e,t)=>{try{return katex.renderToString(t.trim(),{throwOnError:!1,displayMode:!1})}catch(n){return console.warn("KaTeX inline render error:",n,"for:",t),e}});return t=t.replace(/\$\$([^\$]+)\$\$/g,(e,t)=>{try{return katex.renderToString(t.trim(),{throwOnError:!1,displayMode:!0})}catch(n){return console.warn("KaTeX display render error:",n,"for:",t),e}}),t}catch(t){return console.error("Error rendering math:",t),escapeHtml(e)}}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let categoryProgress={},lovaClickCount=0,sessionRewardManager=null,streakAnimationController=null,hintTimer=null;const HINT_DELAY_MS=12e3;function renderVerhoudingstabel(e,t){e.innerHTML="",t&&t.verhoudingstabel&&VerhoudingstabelWidget.render(e,t.verhoudingstabel)}function getHighscoreKey(e,t){return`${CONFIG.storageKeys.highscorePrefix}${e}_${t||"all"}`}function getHighscore(e,t){const n=getHighscoreKey(e,t),o=localStorage.getItem(n);return o?parseInt(o):0}function saveHighscore(e,t,n){const o=getHighscoreKey(e,t);return n>getHighscore(e,t)&&(localStorage.setItem(o,n.toString()),!0)}function getUserName(){let e=localStorage.getItem(CONFIG.storageKeys.userName);return e||(e=prompt(CONFIG.defaults.userPrompt)||CONFIG.defaults.userName,localStorage.setItem(CONFIG.storageKeys.userName,e)),e}function initializeCategoryProgress(e){categoryProgress={};[...new Set(e.map(e=>e.theme).filter(e=>e))].forEach(e=>{categoryProgress[e]={correct:0,incorrect:0,lovaClicks:0}}),updateProgressTrackerDisplay()}function updateCategoryProgress(e,t){e&&categoryProgress[e]&&(t?categoryProgress[e].correct++:categoryProgress[e].incorrect++,updateProgressTrackerDisplay())}function initializeRewardSystem(){let e=4;const t=(new URLSearchParams(window.location.search).get("level")||"").match(/groep(\d)/);t&&(e=parseInt(t[1])),sessionRewardManager=new SessionRewardManager({grade:e,enableLocalStorage:!1}),streakAnimationController=new StreakAnimationController({grade:e})}async function processAnswerWithRewards(e){if(!sessionRewardManager||!streakAnimationController)return e?(score++,currentStreak++):currentStreak=0,void updateProgressTrackerDisplay();const t=sessionRewardManager.processAnswer(e);score=t.score,currentStreak=t.currentStreak,updateProgressTrackerDisplay(),e?await streakAnimationController.playCorrectFeedback(t):await streakAnimationController.playIncorrectFeedback(t);const n=sessionRewardManager.getSessionSummary();return streakAnimationController.updateProgressStar(n.starLevel),t}function checkStreakBonus(){}function showStreakBonus(e,t){}function updateProgressTrackerDisplay(){let e=0,t=0;Object.keys(categoryProgress).sort().forEach(n=>{const o=categoryProgress[n];e+=o.correct,t+=o.incorrect});const n=document.getElementById("totalCorrect");n&&(n.textContent=score);const o=document.getElementById("totalCorrectNew");o&&(o.textContent=score);const r=document.getElementById("lovaClicks");r&&(r.textContent=lovaClickCount)}function shuffleArray(e){const t=[...e];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function createRandomizedQuestions(e){const t=[];return e.forEach(e=>{e.questions&&Array.isArray(e.questions)?e.questions.forEach(n=>{t.push({content:e.content,visual:e.visual,question:n.question,options:n.options,correct:n.correct,originalId:e.id,theme:e.theme,title:e.title,strategy:n.strategy,tips:n.tips,possible_answer:n.possible_answer,extra_info:n.extra_info,lova:n.lova,hint:n.hint})}):e.question&&t.push({content:e.content,visual:e.visual,question:e.question,options:e.options,correct:e.correct,originalId:e.id,theme:e.theme,title:e.title,strategy:e.strategy,tips:e.tips,possible_answer:e.possible_answer,extra_info:e.extra_info,lova:e.lova,hint:e.hint})}),shuffleArray(t)}function createTextGroups(e){const t=[];return e.forEach(e=>{const n={id:e.id,title:e.title,theme:e.theme,text_type:e.text_type,text:e.text||e.content,metadata:e.metadata,questions:[]};e.questions&&Array.isArray(e.questions)&&e.questions.forEach(e=>{n.questions.push({item_id:e.item_id,skill:e.skill,strategy:e.strategy,question:e.question,hint:e.hint,options:e.options,correct:e.correct,extra_info:e.extra_info})}),t.push(n)}),shuffleArray(t)}function getFilePath(e){const t=e.split("-"),n=t[0],o=t[1];if(CONFIG.subjectFilePaths&&CONFIG.subjectFilePaths[n]){const t=CONFIG.subjectFilePaths[n];if(t[e])return t[e];if(o&&o.length>=2){const e=`groep${o.replace(/\D/g,"")||o.substring(1)}`;if(t[e]&&t[e][o])return t[e][o]}if(t.default)return t.default}return"data/templates/"+e+CONFIG.templateFileSuffix}function mergeCoreAndSupport(e,t){if(!e||!t)return console.warn("Missing core or support data for merge"),e;const n={...e};return e.exercises&&t.exercises?(n.exercises=e.exercises.map(e=>{const n=t.exercises.find(t=>t.id===e.id),o=(e.items||[]).map(e=>{const t=n?.items?.find(t=>t.item_id===e.id||t.id===e.id||t.item_id===e.item_id);return t?{...e,feedback:t.feedback??e.feedback,adaptive:t.adaptive??e.adaptive,hints:t.hints??e.hints,learning:t.learning??e.learning}:e});return{...e,items:o}}),n):e.problems&&t.problems?(n.problems=e.problems.map(e=>{const n=t.problems.find(t=>t.id===e.id),o=(e.items||[]).map(e=>{const t=n?.items?.find(t=>t.item_id===e.id||t.id===e.id);return t?{...e,feedback:t.feedback??e.feedback,adaptive:t.adaptive??e.adaptive,hints:t.hints??e.hints}:e});return{...e,items:o}}),n):(e.items&&t.items&&(n.items=e.items.map(e=>{const n=t.items.find(t=>t.item_id===e.id);return n?{...e,feedback:n.feedback,adaptive:n.adaptive,hints:n.hints}:(console.warn(`No support data found for item ${e.id}`),e)})),n)}function transformToLegacyFormat(e,t=""){if(!e||"2.0.0"!==e.schema_version)return e;const n=t?t.split("-")[0]:"";return console.log("Transforming schema 2.0.0 to legacy format for subject:",n||"unknown"),e.exercises?transformReadingComprehension(e):e.problems?transformWordProblems(e):"tl"===e.metadata?.category||"dmt"===n?transformDmtWordList(e):transformMultipleChoice(e)}function transformMultipleChoice(e){return(e.items||[]).map(e=>{const t=e.answer?.correct_index??0,n=(e.options||[]).map((e,n)=>"string"==typeof e?e:{...e,text:e.text||e.label||"",is_correct:void 0!==e.is_correct?e.is_correct:n===t}),o={id:e.id,question:"string"==typeof e.question?e.question:e.question?.text||"",options:n,theme:e.theme||"algemene kennis",correct:t,extra_info:e.feedback?.explanation||e.feedback?.correct?.default||"",feedback:e.feedback,adaptive:e.adaptive,hints:e.hints};return e.content&&(o.content=e.content),e.visual&&(o.visual=e.visual),e.lova&&(o.lova=e.lova),o})}function transformReadingComprehension(e){return(e.exercises||[]).map(e=>{const t=(e.items||[]).map(e=>{const t=e.answer?.correct_index??0,n=(e.options||[]).map((e,n)=>{const o="object"==typeof e?e:{text:e};return{...o,text:o.text||o.label||"",is_correct:void 0!==o.is_correct?o.is_correct:n===t}});return{item_id:e.id||e.item_id,skill:e.skill||e.learning?.skill,strategy:e.strategy||e.learning?.reading_strategies?.[0],question:"string"==typeof e.question?e.question:e.question?.text,hint:e.hint||(Array.isArray(e.hints)?e.hints[0]?.text:void 0),options:n,correct:t,extra_info:e.feedback?.explanation||e.extra_info,lova:e.lova,feedback:e.feedback,adaptive:e.adaptive,hints:e.hints,learning:e.learning}});return{id:e.id,title:e.title,theme:e.theme,text_type:e.content?.text_type||e.text_type,text:e.content?.text||e.text,metadata:e.metadata||e.content?.metadata,questions:t}})}function transformWordProblems(e){const t=[];return(e.problems||[]).forEach(e=>{(e.items||[]).forEach(n=>{const o=n.answer?.correct_index??0,r=(n.options||[]).map((e,t)=>{const n="object"==typeof e?e:{text:e};return{...n,text:n.text||n.label||"",is_correct:void 0!==n.is_correct?n.is_correct:t===o}});t.push({id:n.id,question:"string"==typeof n.question?n.question:n.question?.text,options:r,correct:o,theme:e.theme,content:e.content?.story,extra_info:n.feedback?.explanation||e.content?.context,feedback:n.feedback,adaptive:n.adaptive,hints:n.hints})})}),t}function transformDmtWordList(e){return{list:{words:(e.items||[]).map(e=>"string"==typeof e.question?e.question:e.question?.text||"").map((e,t)=>({id:t+1,word:e}))}}}async function loadSplitFormatExercise(e,t=null){try{const n="enhanced"===(CONFIG.enhancedFormat.supportSource||"enhanced")?e.supportEnhanced:e.support;console.log(`Loading split format: core=${e.core}, support=${n}`);const o=await loadJsonFile(e.core);if(!o)throw new Error("Failed to load core file");const r=await loadJsonFile(n),s=transformToLegacyFormat(mergeCoreAndSupport(o,r),t);return console.log(`Successfully loaded and merged split format exercise: ${o.metadata?.id}`),s}catch(t){if(console.error("Error loading split format exercise:",t),e.legacy)return console.log("Falling back to legacy format"),await loadJsonFile(e.legacy);throw t}}async function loadJsonFile(e,t=null){if("object"==typeof e&&null!==e){const n=t||currentSubject||"",o=n.split("-")[0];if(console.log("Loading exercise for subject:",o,"Enhanced enabled:",CONFIG.enhancedFormat?.enabled[o]),CONFIG.enhancedFormat&&CONFIG.enhancedFormat.enabled[o])return await loadSplitFormatExercise(e,n);if(!(e=e.legacy))throw new Error("No legacy path found and enhanced format not enabled for this subject")}try{const t=`${CONFIG.cache.prefix}${e}_${CONFIG.cache.version}`;if(CONFIG.cache.enabled)try{const n=localStorage.getItem(t);if(n){const t=JSON.parse(n);if(t.timestamp&&Date.now()-t.timestamp<CONFIG.cache.maxAge)return console.log(`Loaded ${e} from cache`),t.data}}catch(e){console.warn("LocalStorage read failed:",e)}console.log(`Fetching ${e} from server`);const n=await fetch(jsonPath+e+`?v=${CONFIG.cache.version}`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();if(CONFIG.cache.enabled)try{const n={data:o,timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(n)),console.log(`Cached ${e} in localStorage`)}catch(e){console.warn("LocalStorage write failed (quota exceeded?):",e);try{const e=Object.keys(localStorage);for(const t of e)t.startsWith(CONFIG.cache.prefix)&&!t.includes(`_${CONFIG.cache.version}`)&&localStorage.removeItem(t);localStorage.setItem(t,JSON.stringify(cacheData))}catch(e){console.warn("Could not cache data even after cleanup")}}return o}catch(e){return console.error("Error loading JSON file:",e),showFriendlyNotification("Oeps! We kunnen de quiz niet laden. Probeer het later nog eens. üòä","error",7e3),null}}function showLevelSelection(e){document.getElementById("landingPage").style.display="none",document.getElementById("levelPage").style.display="block";const t={verhaaltjessommen:{title:"Verhaaltjessommen",icon:"calculate",color:"#FF7F69",description:"Los slimme rekenpuzzels op met contextrijke rekenproblemen"},basisvaardigheden:{title:"Getal & Bewerking",icon:"functions",color:"#FF7F69",description:"Train je rekenkundige basisvaardigheden en word steeds sneller"},woordenschat:{title:"Woordenschat",icon:"local_library",color:"#7FD4A8",description:"Vergroot je woordenkennis en leer nieuwe woorden en hun betekenis"},wereldorientatie:{title:"Wereldori√´ntatie",icon:"public",color:"#5FC5B8",description:"Ontdek alles over de aarde, geschiedenis, natuur en techniek"}}[e]||{title:e,icon:"school",color:"#4A7BA7",description:"Kies jouw niveau om te beginnen"};document.getElementById("levelTitle").textContent=t.title,document.getElementById("levelBreadcrumb").textContent=t.title,document.getElementById("levelDescription").textContent=t.description;const n=document.getElementById("levelSubjectIcon");n.innerHTML=`<i class="material-icons">${t.icon}</i>`,n.style.background=`linear-gradient(135deg, ${t.color} 0%, ${t.color}dd 100%)`;const o=document.getElementById("levelGrid");o.innerHTML="";[{group:4,icon:"üå±",title:"Groep 4",description:"M4 niveau",difficulty:"Basis",subject:e+"-emma"},{group:5,icon:"üìñ",title:"Groep 5",description:"M5 niveau",difficulty:"Midden",subject:e+"-kate"},{group:8,icon:"üèÜ",title:"Groep 8",description:"Eindtoets niveau",difficulty:"CITO",subject:e}].forEach(e=>{const t=document.createElement("div");t.className=`level-card level-${e.group}`,t.onclick=()=>loadSubject(e.subject),t.innerHTML=`\n            <div class="level-badge">${e.group}</div>\n            <h3 class="level-card-title">${e.title}</h3>\n            <p class="level-card-description">${e.description}</p>\n            <div class="level-card-icon">${e.icon}</div>\n            <span class="level-difficulty">${e.difficulty}</span>\n        `,o.appendChild(t)})}async function loadSubject(e){const t=getFilePath(e),n=await loadJsonFile(t,e);if(!n)return;quizData[e]=n,currentSubject=e;const o=[...new Set(n.map(e=>e.theme).filter(e=>e))];console.log("Loaded themes for subject:",e,o),showThemeSelection(e,o,n)}function showThemeSelection(e,t,n){document.getElementById("landingPage").style.display="none",document.getElementById("levelPage").style.display="none",document.getElementById("themePage").style.display="block";const o=CONFIG.subjectTitles[e]||e;document.getElementById("subjectTitle").textContent="Kies wat je wilt oefenen!",document.getElementById("themeBreadcrumb").textContent=o;const r=document.getElementById("themeGrid");r.innerHTML="";let s=0;n.forEach(e=>{Array.isArray(e.questions)?s+=e.questions.length:e.question&&(s+=1)});const i=document.createElement("div");i.className="theme-primary-cta",i.onclick=()=>startQuizWithTheme(e,null);const a=getHighscore(e,null),c=["Klaar om jezelf uit te dagen?","Hoeveel kun jij er goed beantwoorden?","Verdien badges terwijl je oefent!","Elke vraag maakt je wijzer!"],l=c[Math.floor(Math.random()*c.length)];if(i.innerHTML=`\n        <div class="theme-primary-content">\n            <div class="theme-primary-icon">\n                <i class="material-icons">rocket_launch</i>\n            </div>\n            <div class="theme-primary-text">\n                <h2 class="theme-primary-title">üöÄ Complete Mix Mode</h2>\n                <p class="theme-primary-description">${l}</p>\n                <div class="theme-primary-meta">\n                    <span class="theme-primary-badge">\n                        <i class="material-icons">quiz</i>\n                        ${s} vragen klaar!\n                    </span>\n                    ${a>0?`\n                        <span class="theme-primary-badge">\n                            <i class="material-icons">emoji_events</i>\n                            Highscore: ${a}\n                        </span>\n                    `:""}\n                </div>\n            </div>\n        </div>\n    `,r.appendChild(i),t&&t.length>0){const o=document.createElement("div");o.className="theme-subtopics-section";if(e.includes("verhaaltjessommen")||e.includes("basisvaardigheden")){const r=categorizeThemes(t);Object.entries(r).forEach(([t,r])=>{if(0===r.length)return;const s=document.createElement("div");s.className="theme-category-section";const i=document.createElement("div");i.className="theme-category-header",i.innerHTML=`<h3 class="theme-category-title">${t}</h3>`,s.appendChild(i);const a=document.createElement("div");a.className="theme-subtopics-grid",r.forEach((t,o)=>{addThemeCardNew(a,t,n,e,o)}),s.appendChild(a),o.appendChild(s)})}else{const r=document.createElement("div");r.className="theme-subtopics-grid",t.forEach((t,o)=>{addThemeCardNew(r,t,n,e,o)}),o.appendChild(r)}r.appendChild(o)}}function addThemeCardNew(e,t,n,o,r){const s=n.filter(e=>e.theme===t);let i=0;s.forEach(e=>{Array.isArray(e.questions)?i+=e.questions.length:e.question&&(i+=1)});const a=["color-teal","color-blue","color-purple","color-mint","color-coral","color-yellow"],c=a[r%a.length],l={optellen:"‚ûï",aftrekken:"‚ûñ",vermenigvuldigen:"‚úñÔ∏è",delen:"‚ûó",tijd:"‚è∞",geld:"üí∞",gewicht:"‚öñÔ∏è",verhoudingen:"üìä",inhoud:"üì¶",meetkunde:"üìê",oppervlakte:"üìè",omtrek:"üîÑ"}[t.toLowerCase()]||"üìö",d=document.createElement("div");d.className=`theme-subtopic-card ${c}`,d.onclick=()=>startQuizWithTheme(o,t);const u=getHighscore(o,t);d.innerHTML=`\n        <div class="theme-subtopic-header">\n            <span class="theme-subtopic-icon">${l}</span>\n            <h3 class="theme-subtopic-title">${t}</h3>\n        </div>\n        <div class="theme-subtopic-count">\n            <i class="material-icons">quiz</i>\n            <span>${i} vragen</span>\n        </div>\n        ${u>0?`\n            <div class="theme-subtopic-highscore">\n                <i class="material-icons">emoji_events</i>\n                <span>Highscore: ${u}</span>\n            </div>\n        `:""}\n        <div class="theme-subtopic-cta">\n            <span>Start oefenen</span>\n            <i class="material-icons">arrow_forward</i>\n        </div>\n    `,e.appendChild(d)}function addThemeCard(e,t,n,o){const r=n.filter(e=>e.theme===t);let s=0;r.forEach(e=>{Array.isArray(e.questions)?s+=e.questions.length:e.question&&(s+=1)});const i=document.createElement("div");i.className="subject-card theme-card-small",i.onclick=()=>startQuizWithTheme(o,t);const a=getHighscore(o,t);i.innerHTML=`\n        <div class="subject-icon-wrapper">\n            <i class="material-icons subject-icon-material">topic</i>\n        </div>\n        <div style="flex: 1;">\n            <h3>${t}</h3>\n            <p>${s} vragen</p>\n            ${a>0?`\n                <div class="theme-highscore">\n                    <i class="material-icons">emoji_events</i>\n                    <span>Highscore: ${a}</span>\n                </div>\n            `:""}\n        </div>\n    `,e.appendChild(i)}function categorizeThemes(e){const t={"üî¢ Rekenen":[],"üìè Meten & Verhoudingen":[]},n=["optellen","aftrekken","vermenigvuldigen","delen"],o=["tijd","geld","gewicht","verhoudingen","inhoud","meetkunde","oppervlakte","omtrek"];return e.forEach(e=>{const r=e.toLowerCase();n.includes(r)?t["üî¢ Rekenen"].push(e):(o.includes(r),t["üìè Meten & Verhoudingen"].push(e))}),t}function startQuizWithTheme(e,t){currentTheme=t;let n=quizData[e];currentQuiz=t?n.filter(e=>e.theme===t):n,startQuizWithData(e)}function startQuizWithData(e){currentQuestionIndex=0,score=0,hasAnswered=!1,wrongAnswers=[],lovaClickCount=0,resetMilestones();const t=e.split("-")[0];let n;useTextGrouping="begrijpendlezen"===t,useTextGrouping?(textGroups=createTextGroups(currentQuiz),totalQuestions=textGroups.reduce((e,t)=>e+t.questions.length,0),currentTextIndex=0,currentQuestionInText=0,randomizedQuestions=[],textGroups.forEach(e=>{e.questions.forEach(t=>{randomizedQuestions.push({...t,theme:e.theme})})}),initializeCategoryProgress(randomizedQuestions),n={subject:e,currentSubject:currentSubject,currentTheme:currentTheme,currentQuiz:currentQuiz,textGroups:textGroups,useTextGrouping:!0,currentTextIndex:0,currentQuestionInText:0,totalQuestions:totalQuestions,currentQuestionIndex:0,score:0,wrongAnswers:[],lovaClickCount:0,categoryProgress:categoryProgress}):(randomizedQuestions=createRandomizedQuestions(currentQuiz),totalQuestions=randomizedQuestions.length,initializeCategoryProgress(randomizedQuestions),n={subject:e,currentSubject:currentSubject,currentTheme:currentTheme,currentQuiz:currentQuiz,randomizedQuestions:randomizedQuestions,useTextGrouping:!1,totalQuestions:totalQuestions,currentQuestionIndex:0,score:0,wrongAnswers:[],lovaClickCount:0,categoryProgress:categoryProgress}),sessionStorage.setItem("quizState",JSON.stringify(n)),window.location.href="quiz.html"}function updateBreadcrumb(e){const t=document.getElementById("breadcrumbSubject"),n=document.getElementById("breadcrumbLevel"),o=document.getElementById("breadcrumbLevelSep");let r=e,s=null;e.endsWith("-emma")?(r=e.replace("-emma",""),s="Midden Groep 4"):e.endsWith("-kate")?(r=e.replace("-kate",""),s="Midden Groep 5"):["verhaaltjessommen","basisvaardigheden","wereldorientatie","woordenschat"].includes(e)&&(s="Groep 8"),t.textContent=CONFIG.subjectTitles[r]||CONFIG.subjectTitles[e]||e,s?(n.textContent=s,n.style.display="inline",o.style.display="inline"):(n.style.display="none",o.style.display="none");const i=document.getElementById("breadcrumbSubjectNew"),a=document.getElementById("breadcrumbLevelNew"),c=document.getElementById("breadcrumbLevelSepNew");i&&(i.textContent=CONFIG.subjectTitles[r]||CONFIG.subjectTitles[e]||e),a&&c&&(s?(a.textContent=s,a.style.display="inline",c.style.display="inline"):(a.style.display="none",c.style.display="none"))}function renderVisualData(e){if(!e||"table"!==e.type)return"";let t='<div class="table-container">';return t+='<table style="width: 100%; border-collapse: collapse; background-color: white;">',t+="<thead><tr>",e.headers.forEach(e=>{t+=`<th style="border: 2px solid #4A7BA7; padding: 12px; background-color: #4A7BA7; color: white; font-weight: 500; text-align: left; white-space: nowrap;">${e}</th>`}),t+="</tr></thead>",t+="<tbody>",e.rows.forEach((e,n)=>{t+=`<tr style="background-color: ${n%2==0?"#f8f8f8":"#ffffff"};">`,e.forEach(e=>{t+=`<td style="border: 1px solid #e0e0e0; padding: 10px; color: #2C3E50; word-wrap: break-word;">${e}</td>`}),t+="</tr>"}),t+="</tbody></table>",t+="</div>",t}function updateQuizCardHeader(e){const t=document.getElementById("quizSubjectIcon"),n=document.getElementById("quizCardSubjectTitle"),o=document.getElementById("quizCardSubtitle");if(!t||!n||!o)return;let r=e,s=null;e.endsWith("-emma")?(r=e.replace("-emma",""),s="Midden Groep 4"):e.endsWith("-kate")?(r=e.replace("-kate",""),s="Midden Groep 5"):["verhaaltjessommen","basisvaardigheden","wereldorientatie","woordenschat"].includes(e)&&(s="Groep 8");let i=CONFIG.subjectIcons[e]||CONFIG.subjectIcons[r]||"üìö";"üéì"===i&&(i="üìö"),t.textContent=i;const a=CONFIG.subjectTitles[r]||CONFIG.subjectTitles[e]||e;n.textContent=a,o.textContent=s||""}function loadCurrentQuestion(){const e=document.querySelector(".question-card");e&&e.classList.add("transitioning");const t=document.getElementById("questionCardMorph");if(window.cardMorphFeedbackInstance&&t?window.cardMorphFeedbackInstance.reset(t):t&&t.classList.remove("card-flip-out","card-flip-in"),useTextGrouping)return void loadTextGroupQuestion();if(currentQuestionIndex>=randomizedQuestions.length)return void showResults();const n=randomizedQuestions[currentQuestionIndex];currentQuestionErrors=0,incorrectOptions.clear();const o=document.getElementById("hintContainer");o&&(o.innerHTML="");const r=document.getElementById("hintContainerNew");r&&(r.innerHTML="");const s=currentQuestionIndex/totalQuestions*100,i=document.getElementById("progressLabel"),a=document.getElementById("progressPercentage"),c=document.getElementById("progressBarFill");i&&(i.textContent=`Vraag ${currentQuestionIndex+1} van ${totalQuestions}`),a&&(a.textContent=`${Math.round(s)}% voltooid`),c&&(c.style.width=`${s}%`);const l=document.getElementById("progressLabelNew"),d=document.getElementById("progressBarFillNew");l&&(l.textContent=`Vraag ${currentQuestionIndex+1} van ${totalQuestions}`),d&&(d.style.width=`${s}%`);const u=document.getElementById("questionCounter");u&&(u.textContent=`Vraag ${currentQuestionIndex+1} van ${totalQuestions}`),updateQuizCardHeader(currentSubject),updateStarProgress(s),checkMilestone(s);const m=document.getElementById("readingContent"),g=document.getElementById("readingContentNew"),p=document.getElementById("storyBlockWrapper");if(p&&p.classList.remove("hidden"),n.content||n.visual){let e="";if(n.content&&(e+=n.content),n.visual&&(e+=renderVisualData(n.visual)),m.innerHTML=e,m.classList.remove("hidden"),g){g.classList.remove("no-story-content");const t=g.querySelector(".story-text-content");t&&(t.innerHTML=e,t.style.display="");const n=g.querySelector(".story-header-label");n&&(n.style.display="")}}else if(m.classList.add("hidden"),g){g.classList.add("no-story-content");const e=g.querySelector(".story-text-content");e&&(e.innerHTML="",e.style.display="none");const t=g.querySelector(".story-header-label");t&&(t.style.display="none")}document.getElementById("questionText").textContent=n.question;const h=document.getElementById("questionTextNew");h&&(h.textContent=n.question);const y=n.lova&&n.lova.stap1_lezen,f=document.getElementById("lovaHelpButton"),v=document.getElementById("lovaHelpButtonNew"),w=document.getElementById("lovaHelpPanel");y?(f.style.display="flex",v&&(v.style.display="inline-flex"),loadLovaHelpData(n),lovaHelpPanelExpanded=!1,w.classList.remove("expanded"),w.classList.add("hidden")):(f.style.display="none",v&&(v.style.display="none"),w.classList.add("hidden"));const b=document.getElementById("optionsContainer"),x=document.getElementById("textareaAnswer"),I=document.getElementById("feedbackSection"),k=document.getElementById("optionsContainerNew"),E=document.getElementById("textareaAnswerNew"),C=document.getElementById("feedbackSectionNew");if(I.classList.add("hidden"),I.classList.remove("correct","incorrect"),document.getElementById("correctAnswerDisplay").classList.add("hidden"),document.getElementById("extraInfoDisplay").classList.add("hidden"),document.getElementById("verhoudingstabelContainer").innerHTML="",document.getElementById("strategyAndTips").classList.add("hidden"),C){C.classList.add("hidden"),C.classList.remove("correct","incorrect");const e=document.getElementById("correctAnswerDisplayNew"),t=document.getElementById("extraInfoDisplayNew"),n=document.getElementById("verhoudingstabelContainerNew"),o=document.getElementById("strategyAndTipsNew");e&&e.classList.add("hidden"),t&&t.classList.add("hidden"),n&&(n.innerHTML=""),o&&o.classList.add("hidden")}if(n.options){b.classList.remove("hidden"),x.classList.add("hidden"),k&&k.classList.remove("hidden"),E&&E.classList.add("hidden"),b.innerHTML="",k&&(k.innerHTML="");shuffleArray(n.options).forEach((e,t)=>{const o=["A","B","C","D","E","F"][t]||String.fromCharCode(65+t);let r=!1;"string"==typeof e?r=e===n.options[n.correct]:void 0!==e.is_correct&&(r=e.is_correct);const s=document.createElement("div");if(s.className="option",s.setAttribute("data-correct",r),"object"==typeof e&&s.setAttribute("data-option",JSON.stringify(e)),s.textContent="string"==typeof e?e:e.text,s.onclick=()=>selectOption(t),b.appendChild(s),k){const n=document.createElement("div");n.className="option",n.setAttribute("data-letter",o),n.setAttribute("data-correct",r),"object"==typeof e&&n.setAttribute("data-option",JSON.stringify(e)),n.textContent="string"==typeof e?e:e.text,n.onclick=()=>selectOption(t),k.appendChild(n)}})}else b.classList.add("hidden"),x.classList.remove("hidden"),x.value="",k&&k.classList.add("hidden"),E&&(E.classList.remove("hidden"),E.value="");selectedAnswer=null,hasAnswered=!1;const T=document.getElementById("submitBtn");T&&(T.style.display="block",T.classList.remove("hidden")),document.getElementById("nextBtn").classList.add("hidden"),document.querySelectorAll(".inline-check-btn").forEach(e=>e.remove()),clearHintTimer(),startHintTimer()}function loadTextGroupQuestion(){if(currentTextIndex>=textGroups.length)return void showResults();if(currentTextGroup=textGroups[currentTextIndex],currentQuestionInText>=currentTextGroup.questions.length)return currentTextIndex++,currentQuestionInText=0,saveTextGroupProgress(),void loadTextGroupQuestion();const e=currentTextGroup.questions[currentQuestionInText];currentQuestionErrors=0,incorrectOptions.clear();const t=(calculateQuestionsCompleted()+currentQuestionInText+1)/totalQuestions*100,n=document.getElementById("progressLabelNew"),o=document.getElementById("progressBarFillNew");n&&(n.textContent=`Vraag ${currentQuestionInText+1}/${currentTextGroup.questions.length} van "${currentTextGroup.title}"`),o&&(o.style.width=`${t}%`),displayReadingText(currentTextGroup),displayQuestionMetadata(e);const r=document.getElementById("questionTextNew");r&&(r.innerHTML=renderMathInText(e.question));const s=document.getElementById("hintContainerNew");s&&(s.innerHTML="",s.classList.add("hidden"));const i=document.getElementById("hintPillBtn"),a=document.getElementById("hintDisplay"),c=document.getElementById("hintDisplayText");e.hint&&i&&a&&c?(c.innerHTML=renderMathInText(e.hint),a.style.display="none",i.classList.remove("show-hint")):i&&a&&(i.classList.remove("show-hint"),a.style.display="none"),renderAnswerOptions(e);const l=document.getElementById("feedbackSectionNew");l&&l.classList.add("hidden");const d=document.getElementById("submitBtn");d&&(d.style.display="block",d.classList.remove("hidden")),document.getElementById("nextBtn").classList.add("hidden"),selectedAnswer=null,hasAnswered=!1,document.querySelectorAll(".inline-check-btn").forEach(e=>e.remove()),clearHintTimer(),startHintTimer(),setTimeout(()=>{const e=document.querySelector(".question-card");e&&e.classList.remove("transitioning")},50)}function calculateQuestionsCompleted(){let e=0;for(let t=0;t<currentTextIndex;t++)e+=textGroups[t].questions.length;return e}function displayReadingText(e){const t=document.getElementById("storyBlockWrapper"),n=document.querySelector(".story-text-content"),o=document.getElementById("readingContentNew");if(!t||!o)return;t.classList.remove("hidden"),n&&(n.innerHTML=`<p>${e.text}</p>`);const r=o.querySelector(".story-header-label span:nth-child(2)");r&&(r.textContent=e.title)}function displayQuestionMetadata(e){const t=document.getElementById("skillBadge"),n=document.getElementById("skillType"),o=document.getElementById("strategyBadge"),r=document.getElementById("strategyType");e.skill&&t&&n?(t.style.display="inline-flex",n.textContent=capitalizeFirst(e.skill)):t&&(t.style.display="none"),e.strategy&&o&&r?(o.style.display="inline-flex",r.textContent=capitalizeFirst(e.strategy)):o&&(o.style.display="none")}function renderAnswerOptions(e){const t=document.getElementById("optionsContainerNew");if(!t)return;t.innerHTML="",t.classList.remove("hidden");shuffleArray(e.options).forEach((n,o)=>{const r=document.createElement("div");let s,i,a;r.className="option","string"==typeof n?(s=n,i=String.fromCharCode(65+o),a=n===e.options[e.correct]):(s=n.text,i=String.fromCharCode(65+o),a=n.is_correct),r.setAttribute("data-letter",i),r.setAttribute("data-index",o),r.setAttribute("data-correct",a),"object"==typeof n&&r.setAttribute("data-option",JSON.stringify(n)),r.innerHTML=renderMathInText(s),r.onclick=()=>selectOption(o),t.appendChild(r)})}function capitalizeFirst(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}function toggleHint(){const e=document.getElementById("hintDisplay"),t=document.getElementById("hintPillBtn");"none"===e.style.display?(e.style.display="block",t.classList.add("active")):(e.style.display="none",t.classList.remove("active"))}function saveTextGroupProgress(){if(!window.location.pathname.endsWith("quiz.html"))return;const e=JSON.parse(sessionStorage.getItem("quizState")||"{}");e.currentTextIndex=currentTextIndex,e.currentQuestionInText=currentQuestionInText,e.score=score,e.wrongAnswers=wrongAnswers,e.lovaClickCount=lovaClickCount,e.categoryProgress=categoryProgress,sessionStorage.setItem("quizState",JSON.stringify(e))}function selectOption(e){if(hasAnswered)return;if(incorrectOptions.has(e))return;document.querySelectorAll(".option").forEach(e=>{e.classList.remove("selected")});const t=document.querySelector(".inline-check-btn");t&&t.remove();document.querySelectorAll(".option")[e].classList.add("selected"),selectedAnswer=e,resetHintTimer(),showInlineCheckButton();const n=document.getElementById("submitBtn");n&&(n.style.display="none")}function showInlineCheckButton(){const e=document.querySelector(".option.selected");if(!e)return;const t=document.createElement("button");t.className="inline-check-btn",t.innerHTML="<span>‚úì</span><span>Check mijn antwoord!</span>",t.onclick=submitAnswer;const n=e.parentElement;n&&(e.nextSibling?n.insertBefore(t,e.nextSibling):n.appendChild(t))}function startHintTimer(){hintTimer&&(clearTimeout(hintTimer),hintTimer=null);const e=document.getElementById("hintPillBtn");if(!e)return;const t=document.getElementById("hintDisplayText");t&&t.textContent&&(hintTimer=setTimeout(()=>{e.classList.add("show-hint")},12e3))}function resetHintTimer(){const e=document.getElementById("hintPillBtn");e&&e.classList.remove("show-hint"),hintTimer&&(clearTimeout(hintTimer),hintTimer=null),startHintTimer()}function clearHintTimer(){const e=document.getElementById("hintPillBtn");e&&e.classList.remove("show-hint"),hintTimer&&(clearTimeout(hintTimer),hintTimer=null)}function showCardMorphFeedback(e,t,n=null,o=null){const r=document.getElementById("questionCardMorph"),s=document.getElementById("nextBtn");if(!r)return void console.error("Question card morph wrapper not found");let i;i=e?InsightGenerator.generateCorrectInsight(t):InsightGenerator.generateIncorrectInsight(t,n);const a=InsightGenerator.buildConfirmation(t,o,e);window.cardMorphFeedbackInstance||(window.cardMorphFeedbackInstance=new CardMorphFeedback);const c=document.getElementById("feedbackSectionNew");c&&c.classList.add("hidden"),window.cardMorphFeedbackInstance.morph({isCorrect:e,insight:i,confirmation:a,question:t,selectedOption:n,questionCard:r,nextButton:s,onProceed:()=>{nextQuestion()}}),s&&s.classList.remove("hidden");const l=document.getElementById("submitBtn");l&&l.classList.add("hidden")}function populateEnhancedFeedback(e,t,n=null,o=null){const r=document.getElementById("feedbackSectionNew");if(!r)return;r.classList.remove("hidden","correct","incorrect"),r.classList.add(e?"correct":"incorrect");const s=document.getElementById("feedbackEmojiNew"),i=document.getElementById("feedbackHeadlineNew"),a=document.getElementById("feedbackAnswerConfirmNew"),c=document.getElementById("feedbackWhySection"),l=document.getElementById("feedbackWhySectionTitle"),d=document.getElementById("feedbackWhyContentNew"),u=document.getElementById("feedbackWorkedSection"),m=document.getElementById("feedbackWorkedExampleNew"),g=document.getElementById("feedbackTipSection"),p=document.getElementById("feedbackTipContentNew"),h=currentSubject&&currentSubject.startsWith("woordenschat");if(e)s&&(s.textContent="üéâ"),i&&(i.textContent="Top gedaan!"),a&&(a.textContent="Je hebt het juiste antwoord gekozen! Je bent goed bezig!"),l&&(l.textContent=h?"Zo gebruik je het woord:":"Waarom is dit goed?");else if(s&&(s.textContent="ü§ó"),i&&(i.textContent="Bijna! Probeer het nog een keer!"),l&&(l.textContent=h?"Zo gebruik je het woord:":"Waarom niet?"),a)if(null!==o&&t.options){const e="string"==typeof t.options[o]?t.options[o]:t.options[o].text,n=["A","B","C","D","E","F"][o]||"";a.innerHTML=`Het goede antwoord was ${n} ‚Äì ${renderMathInText(e)}`}else t.possible_answer&&(a.innerHTML=`Een goed antwoord is: ${renderMathInText(t.possible_answer)}`);if(c&&d&&(t.extra_info?"string"==typeof t.extra_info?(c.style.display="block",d.innerHTML=t.extra_info):t.extra_info.concept?(c.style.display="block",d.textContent=t.extra_info.concept):c.style.display="none":c.style.display="none"),u&&m&&t.extra_info?.berekening){u.style.display="block";const e=Array.isArray(t.extra_info.berekening)?t.extra_info.berekening.join("\n"):t.extra_info.berekening;m.textContent=e}else u&&(u.style.display="none");if(g&&p)if(e)g.style.display="none";else{let e="";if(n&&"object"==typeof n&&n.foutanalyse){e=n.foutanalyse.split("ü§î")[0].trim(),e=e.replace(/\*\*/g,"")}else e=t.extra_info?.tips&&Array.isArray(t.extra_info.tips)&&t.extra_info.tips.length>0?t.extra_info.tips[0]:t.theme&&t.theme.includes("tafels")?"Oefen de tafels regelmatig om ze beter te onthouden!":t.theme&&t.theme.includes("geld")?"Let goed op de komma bij geldbedragen!":"Lees de vraag nog een keer goed door. Wat wordt er precies gevraagd?";e?(g.style.display="block",p.textContent=e):g.style.display="none"}}function submitAnswer(){if(hasAnswered)return;let e;e=useTextGrouping?currentTextGroup.questions[currentQuestionInText]:randomizedQuestions[currentQuestionIndex];const t=document.getElementById("feedbackSection"),n=document.getElementById("feedbackTitle"),o=document.getElementById("feedbackMessage"),r=document.getElementById("correctAnswerDisplay"),s=document.getElementById("extraInfoDisplay"),i=document.getElementById("verhoudingstabelContainer"),a=document.getElementById("strategyAndTips"),c=document.getElementById("strategyText"),l=document.getElementById("tipsList");t.classList.remove("hidden");const d=document.getElementById("feedbackSectionNew");if(d&&d.classList.remove("hidden"),e.options){if(null===selectedAnswer)return showFriendlyNotification("Kies eerst een antwoord voordat je controleert! üòä","info",4e3),t.classList.add("hidden"),void(d&&d.classList.add("hidden"));const n=document.querySelectorAll(".option"),o=n[selectedAnswer],r=o&&"true"===o.getAttribute("data-correct");let a=null;if(o){const t=o.getAttribute("data-option");t?a=JSON.parse(t):"string"==typeof e.options[selectedAnswer]&&(a=e.options[selectedAnswer])}let c=e.options.findIndex(e=>!("object"!=typeof e||!e.hasOwnProperty("is_correct"))&&!0===e.is_correct);if(-1===c&&null!==e.correct&&void 0!==e.correct&&(c=e.correct),-1===c){const o=e.options.some(e=>"object"==typeof e&&e.text),r=e.options.some(e=>"object"==typeof e&&"is_correct"in e);return o&&!r?(console.error("Incomplete question data - missing is_correct field",{questionId:e.originalId,title:e.title,question:e.question}),alert(`Deze vraag is nog niet compleet bijgewerkt in het systeem (ID: ${e.originalId}).\n\nGa door naar de volgende vraag.`)):(console.error("Error: Could not determine correct answer index",{correctIndex:c,optionsLength:n.length,questionId:e.originalId}),alert("Er is een fout opgetreden bij het controleren van het antwoord. Probeer opnieuw of neem contact op met de beheerder.")),t.classList.add("hidden"),hasAnswered=!0,document.getElementById("submitBtn").classList.add("hidden"),void document.getElementById("nextBtn").classList.remove("hidden")}if(r){n[selectedAnswer].classList.add("correct");const o=document.querySelectorAll(".quiz-answers-wrapper .option");o[selectedAnswer]&&o[selectedAnswer].classList.add("is-correct"),processAnswerWithRewards(!0),updateCategoryProgress(e.theme,!0);if("verhaaltjessommen"===currentSubject&&e.lova&&e.extra_info){const t=wrongAnswers.findIndex(t=>t.question.originalId===e.originalId);-1!==t&&wrongAnswers.splice(t,1)}t.classList.add("hidden"),showCardMorphFeedback(!0,e,null,c)}else{currentQuestionErrors++,processAnswerWithRewards(!1),updateCategoryProgress(e.theme,!1);const o="object"==typeof a&&a.foutanalyse?a.foutanalyse:"",r="verhaaltjessommen"===currentSubject&&a.error_type&&e.extra_info;console.log("Incorrect answer check:",{currentSubject:currentSubject,hasErrorType:!!a.error_type,hasExtraInfo:!!e.extra_info,isVerhaaltjessom:r}),n[selectedAnswer].classList.add("incorrect");const l=document.querySelectorAll(".quiz-answers-wrapper .option");l[selectedAnswer]&&l[selectedAnswer].classList.add("is-incorrect");const d=Array.from(n).find(e=>"true"===e.getAttribute("data-correct"));d&&d.classList.add("correct");const u=Array.from(l).find(e=>"true"===e.getAttribute("data-correct"));u&&u.classList.add("is-correct"),t.classList.add("hidden"),showCardMorphFeedback(!1,e,a,c);if(!wrongAnswers.some(t=>t.question.originalId===e.originalId)){const t="string"==typeof a?a:a.text,n="string"==typeof e.options[c]?e.options[c]:e.options[c].text;wrongAnswers.push({question:e,userAnswer:t,correctAnswer:n,explanation:o||"Zie uitleg voor details",questionType:r?"verhaaltjessom":"multiple-choice"}),console.log("‚úì Tracked wrong answer. Total wrongAnswers:",wrongAnswers.length)}if(e.extra_info)if(renderVerhoudingstabel(i,e.extra_info),"string"==typeof e.extra_info)s.innerHTML=`<h4>Achtergrondinfo:</h4><p>${renderMathInText(e.extra_info)}</p>`,s.classList.remove("hidden");else if(e.extra_info.concept||e.extra_info.berekening){let t="";e.extra_info.concept&&(t+=`<h4>Concept:</h4><p>${renderMathInText(e.extra_info.concept)}</p>`),e.extra_info.berekening&&e.extra_info.berekening.length>0&&(t+="<h4>Berekening:</h4><ul>",e.extra_info.berekening.forEach(e=>{t+=`<li>${renderMathInText(e)}</li>`}),t+="</ul>"),s.innerHTML=t,s.classList.remove("hidden")}else if(e.extra_info.tips){let t="<h4>Extra Tips:</h4><ul>";e.extra_info.tips.forEach(e=>{t+=`<li>${renderMathInText(e)}</li>`}),t+="</ul>",s.innerHTML=t,s.classList.remove("hidden")}else s.classList.add("hidden");else s.classList.add("hidden"),i.innerHTML=""}}else{const u=document.getElementById("textareaAnswer").value.trim();if(!u)return alert(CONFIG.feedback.noAnswer.openEnded),t.classList.add("hidden"),void(d&&d.classList.add("hidden"));const m=e.possible_answer?e.possible_answer.toLowerCase().trim():"";if(u.toLowerCase()===m)score++,currentStreak++,checkStreakBonus(),t.classList.add("correct"),n.textContent=CONFIG.feedback.correct.title,o.textContent=CONFIG.feedback.correct.message,r.classList.add("hidden"),s.classList.add("hidden"),i.innerHTML="",a.classList.add("hidden"),showCardMorphFeedback(!0,e,null,0),updateCategoryProgress(e.theme,!0);else{currentQuestionErrors++,currentStreak=0,t.classList.add("incorrect"),n.textContent=CONFIG.feedback.incorrect.title,o.textContent=CONFIG.feedback.incorrect.messageWithTips;const d={text:e.possible_answer,foutanalyse:`Het antwoord was: "${e.possible_answer}". Probeer het nog een keer!`};showCardMorphFeedback(!1,e,d,0),updateCategoryProgress(e.theme,!1),1===currentQuestionErrors&&e.hint&&showHintButton(e.hint),r.innerHTML=`Voorbeeld antwoord: "${renderMathInText(e.possible_answer)}"`,r.classList.remove("hidden"),wrongAnswers.push({question:e,userAnswer:u,correctAnswer:e.possible_answer,explanation:o.textContent,questionType:"open-ended"}),e.strategy||e.tips&&e.tips.length>0?(a.classList.remove("hidden"),c.innerHTML=renderMathInText(e.strategy||"Geen specifieke strategie beschikbaar."),l.innerHTML="",e.tips&&e.tips.length>0?e.tips.forEach(e=>{const t=document.createElement("li");t.innerHTML=renderMathInText(e),l.appendChild(t)}):l.innerHTML="<li>Geen specifieke tips beschikbaar.</li>"):a.classList.add("hidden"),e.extra_info?(renderVerhoudingstabel(i,e.extra_info),s.innerHTML=`Achtergrondinfo: ${renderMathInText(e.extra_info)}`,s.classList.remove("hidden")):(s.classList.add("hidden"),i.innerHTML="")}}hasAnswered=!0,document.getElementById("submitBtn").classList.add("hidden");const u=currentSubject&&currentSubject.startsWith("woordenschat"),m=document.getElementById("nextBtn");u&&e.extra_info?(m.classList.add("hidden"),setTimeout(()=>{showWoordenschatModal(e.extra_info)},1500),setTimeout(()=>{m.classList.remove("hidden")},8e3)):m.classList.remove("hidden")}function showWoordenschatModal(e){const t=document.getElementById("woordenschatModal"),n=document.getElementById("woordenschatModalSentence");t&&n&&(n.innerHTML=e,t.classList.remove("hidden","fade-out"),setTimeout(()=>{t.classList.add("fade-out"),setTimeout(()=>{t.classList.add("hidden"),t.classList.remove("fade-out")},800)},5e3))}function nextQuestion(){closeSuccessModaal(),closeFoutanalyseModaal(),"function"==typeof resetAttemptTracking&&resetAttemptTracking();const e=document.getElementById("hintContainer");if(e&&(e.innerHTML=""),useTextGrouping)return currentQuestionInText++,saveTextGroupProgress(),void loadCurrentQuestion();if(currentQuestionIndex++,window.location.pathname.endsWith("quiz.html")){const e=JSON.parse(sessionStorage.getItem("quizState")||"{}");e.currentQuestionIndex=currentQuestionIndex,e.score=score,e.wrongAnswers=wrongAnswers,e.lovaClickCount=lovaClickCount,e.categoryProgress=categoryProgress,sessionStorage.setItem("quizState",JSON.stringify(e))}currentQuestionIndex>=randomizedQuestions.length?showResults():loadCurrentQuestion()}function showResults(){document.getElementById("quizPage").style.display="none",document.getElementById("resultsPage").style.display="block";const e=saveHighscore(currentSubject,currentTheme,score);let t=0;Object.keys(categoryProgress).forEach(e=>{t+=categoryProgress[e].correct});const n=totalQuestions>0?Math.round(t/totalQuestions*100):0,o=wrongAnswers.length,r=t;populateHeroBlock(n,r,o,e,score),populateSkillsOverview(),populateStickerCollection(),populateQuestionAccordion(),updateGamificationProgress(n,r,o)}function updateGamificationProgress(e,t,n){if("undefined"!=typeof gamificationManager&&gamificationManager)if("undefined"!=typeof gamificationUI&&gamificationUI)try{const o={totalQuestions:totalQuestions,correctCount:t,incorrectCount:n,percentage:e,score:score,categoryProgress:categoryProgress,isPerfect:0===n,exerciseId:currentSubject||"unknown",category:currentTheme||"general"};console.log("üìä Updating gamification with results:",o);const r=gamificationManager.completeExercise(o);console.log("üéÆ Gamification feedback:",r),setTimeout(()=>{r.xpEarned>0&&gamificationUI.showXPGain(r.xpEarned,`${t} vragen goed!`),r.leveledUp&&setTimeout(()=>{gamificationUI.showLevelUp(r.newLevel)},1500),r.newAchievements&&r.newAchievements.length>0&&r.newAchievements.forEach((e,t)=>{setTimeout(()=>{gamificationUI.showAchievementUnlock(e)},2e3+3500*t)}),r.completedChallenges&&r.completedChallenges.length>0&&r.completedChallenges.forEach((e,t)=>{setTimeout(()=>{gamificationUI.showChallengeComplete(e)},3e3+3500*t)}),gamificationUI.renderMiniProfile("gamification-mini-profile")},500)}catch(e){console.error("‚ùå Error updating gamification:",e)}else console.log("Gamification UI not available");else console.log("Gamification manager not available")}function populateStickerCollection(){if(!sessionRewardManager||!streakAnimationController){const e=document.getElementById("stickerCollection");return void(e&&(e.style.display="none"))}const e=sessionRewardManager.getSessionSummary().stickers;streakAnimationController.renderStickers(e,e=>sessionRewardManager.getStickerMetadata(e))}function populateHeroBlock(e,t,n,o,r){const s=document.getElementById("resultEmoji"),i=document.getElementById("resultHeadline"),a=document.getElementById("resultSummary"),c=document.getElementById("resultGrowthBadge"),l=document.getElementById("growthText");let d,u;e>=90?(d="üéâ",u=o?"Nieuw record! Fantastisch!":"Wauw! Geweldig gedaan!"):e>=70?(d="üåü",u="Knap gewerkt!"):e>=50?(d="üí™",u="Goed bezig!"):(d="üöÄ",u="Elke vraag maakt je sterker!"),s.textContent=d,i.textContent=u;let m="";if(m=1===t?"Je hebt 1 vraag goed beantwoord!":t>1?`Je hebt ${t} vragen goed beantwoord!`:"Elke vraag is een leerkans!",r>t){m+=` (${r} punten inclusief ${r-t} bonuspunten!)`}if(n>0&&(m+=1===n?" En 1 vraag maakt je weer een beetje sterker!":` En ${n} vragen maken je weer een beetje sterker!`),a.textContent=m,n>0){c.style.display="flex";const e=1===n?"1 leerpunt":`${n} leerpunten`;l.textContent=`Je hebt ${e} verdiend!`}else c.style.display="none"}function populateSkillsOverview(){const e=document.getElementById("skillsChips"),t=document.getElementById("skillsOverview"),n=Object.keys(categoryProgress);0!==n.length?(t.style.display="block",e.innerHTML="",n.forEach(t=>{const n=categoryProgress[t],o=n.correct+n.incorrect,r=o>0?Math.round(n.correct/o*100):0,s=document.createElement("div");let i,a,c;s.className="skill-chip",r>=80?(i="‚≠ê",a="Goed gedaan!",c="skill-chip-excellent"):r>=50?(i="üëç",a="Lekker bezig!",c="skill-chip-good"):(i="üí°",a="Hier kun je nog sterker in worden",c="skill-chip-growth"),s.classList.add(c);const l={optellen:"‚ûï",aftrekken:"‚ûñ",vermenigvuldigen:"‚úñÔ∏è",delen:"‚ûó",breuken:"¬Ω",procenten:"%",meten:"üìè",tijd:"‚è∞",geld:"üí∞","basis-rekenen":"üî¢","omrekenen-eenheden":"‚öñÔ∏è",kommagetallen:"0.0",getallenlijn:"üìä",verhoudingstabellen:"üìà"}[t.toLowerCase()]||"üìö";s.innerHTML=`\n            <span class="skill-chip-icon">${l}</span>\n            <span class="skill-chip-label">${t}</span>\n            <span class="skill-chip-status">${i} ${a}</span>\n        `,e.appendChild(s)})):t.style.display="none"}function populateQuestionAccordion(){const e=document.getElementById("questionAccordion"),t=document.getElementById("questionReviewSection");0!==wrongAnswers.length?(t.style.display="block",e.innerHTML="",wrongAnswers.forEach((t,n)=>{const o=document.createElement("div");o.className="accordion-item";const r=document.createElement("div");r.className="accordion-header",r.innerHTML=`\n            <span class="accordion-status status-growth">üí° Hier kun je nog groeien</span>\n            <span class="accordion-title">Vraag ${n+1}</span>\n            <span class="accordion-icon">‚ñº</span>\n        `;const s=document.createElement("div");s.className="accordion-content",s.style.display="none";let i="";t.question.content&&t.question.content.trim()&&(i+=`\n                <div class="verhaaltje-box">\n                    <div class="verhaaltje-label">üìñ Verhaaltje</div>\n                    <p>${t.question.content}</p>\n                </div>\n            `),i+=`<div class="question-text-review"><strong>Vraag:</strong> ${t.question.question}</div>`;i+=`\n            <div class="answer-comparison">\n                <div class="answer-box answer-user">\n                    <div class="answer-label">Jouw antwoord:</div>\n                    <div class="answer-value">${t.userAnswer||"Niet beantwoord"}</div>\n                </div>\n                <div class="answer-box answer-correct">\n                    <div class="answer-label">Goede antwoord:</div>\n                    <div class="answer-value">‚úì ${t.correctAnswer||"Onbekend"}</div>\n                </div>\n            </div>\n        `,i+='<div class="explanation-section">',t.question.extra_info&&t.question.extra_info.concept&&(i+=`\n                <div class="explanation-block">\n                    <h4 class="explanation-heading">üß† Waarom?</h4>\n                    <p>${t.question.extra_info.concept}</p>\n                </div>\n            `),t.question.extra_info&&t.question.extra_info.strategy&&(i+=`\n                <div class="explanation-block">\n                    <h4 class="explanation-heading">‚û°Ô∏è Zo werkt het:</h4>\n                    <p>${t.question.extra_info.strategy}</p>\n                </div>\n            `),t.question.extra_info&&t.question.extra_info.tips&&t.question.extra_info.tips.length>0&&(i+=`\n                <div class="explanation-block">\n                    <h4 class="explanation-heading">üí° Tip voor de volgende keer:</h4>\n                    <p>${t.question.extra_info.tips[0]}</p>\n                </div>\n            `),i+="</div>",s.innerHTML=i,r.onclick=function(){const e="block"===s.style.display;s.style.display=e?"none":"block",r.querySelector(".accordion-icon").textContent=e?"‚ñº":"‚ñ≤",o.classList.toggle("active",!e)},o.appendChild(r),o.appendChild(s),e.appendChild(o)})):t.style.display="none"}function restartQuiz(){currentQuestionIndex=0,score=0,hasAnswered=!1,wrongAnswers=[],lovaClickCount=0,currentQuestionErrors=0,incorrectOptions.clear(),initializeCategoryProgress(randomizedQuestions),document.getElementById("resultsPage").style.display="none",document.getElementById("quizPage").style.display="block",loadCurrentQuestion()}function goToLanding(){if(localStorage.removeItem("autoStartSubject"),localStorage.removeItem("autoStartTheme"),window.location.pathname.endsWith("quiz.html"))return sessionStorage.removeItem("quizState"),void(window.location.href="index.html");document.getElementById("landingPage")&&(document.getElementById("landingPage").style.display="block"),document.getElementById("levelPage")&&(document.getElementById("levelPage").style.display="none"),document.getElementById("themePage")&&(document.getElementById("themePage").style.display="none"),document.getElementById("quizPage")&&(document.getElementById("quizPage").style.display="none"),document.getElementById("resultsPage")&&(document.getElementById("resultsPage").style.display="none"),document.getElementById("reviewPage")&&(document.getElementById("reviewPage").style.display="none"),currentQuiz=null,randomizedQuestions=[],currentSubject=null,currentTheme=null,currentQuestionIndex=0,score=0,totalQuestions=0,selectedAnswer=null,hasAnswered=!1,wrongAnswers=[],lovaClickCount=0,lovaHelpPanelExpanded=!1,"function"==typeof checkForPausedQuiz&&checkForPausedQuiz()}function toggleFocusMode(){const e=document.body,t=document.getElementById("focusModeToggle"),n=t.querySelector("i");e.classList.toggle("focus-mode"),e.classList.contains("focus-mode")?(n.textContent="visibility",t.title="Exit Focus Modus"):(n.textContent="visibility_off",t.title="Focus Modus")}function pauseQuiz(){const e={subject:currentSubject,theme:currentTheme,quiz:currentQuiz,randomizedQuestions:randomizedQuestions,currentQuestionIndex:currentQuestionIndex,score:score,totalQuestions:totalQuestions,wrongAnswers:wrongAnswers,categoryProgress:categoryProgress,lovaClickCount:lovaClickCount,timestamp:Date.now()};localStorage.setItem("pausedQuiz",JSON.stringify(e)),showFriendlyNotification("Quiz gepauzeerd! Je kunt later doorgaan waar je gebleven bent. üëç","success",5e3),setTimeout(()=>goToLanding(),1e3)}function checkForPausedQuiz(){const e=localStorage.getItem("pausedQuiz"),t=document.getElementById("resumeBanner"),n=document.getElementById("resumeDetails");if(e)try{const o=JSON.parse(e),r=CONFIG.subjectTitles[o.subject]||o.subject,s=`${o.currentQuestionIndex} van ${o.totalQuestions} vragen`;n.textContent=`${r} - ${s} beantwoord`,t.style.display="flex"}catch(e){console.error("Error parsing paused quiz:",e),localStorage.removeItem("pausedQuiz")}else t.style.display="none"}function resumePausedQuiz(){const e=localStorage.getItem("pausedQuiz");if(e)try{const t=JSON.parse(e);currentSubject=t.subject,currentTheme=t.theme,currentQuiz=t.quiz,randomizedQuestions=t.randomizedQuestions,currentQuestionIndex=t.currentQuestionIndex,score=t.score,totalQuestions=t.totalQuestions,wrongAnswers=t.wrongAnswers,categoryProgress=t.categoryProgress,lovaClickCount=t.lovaClickCount||0,hasAnswered=!1,selectedAnswer=null,document.getElementById("landingPage").style.display="none",document.getElementById("quizPage").style.display="block",document.getElementById("quizTitle").textContent=CONFIG.subjectTitles[currentSubject]||"Quiz",updateBreadcrumb(currentSubject),loadCurrentQuestion(),localStorage.removeItem("pausedQuiz")}catch(e){console.error("Error resuming quiz:",e),showFriendlyNotification("Helaas kunnen we je quiz niet hervatten. Probeer een nieuwe quiz te starten! üîÑ","warning",6e3),localStorage.removeItem("pausedQuiz")}else alert("Geen gepauzeerde quiz gevonden.")}function clearPausedQuiz(){confirm("Weet je zeker dat je de gepauzeerde quiz wilt verwijderen?")&&(localStorage.removeItem("pausedQuiz"),document.getElementById("resumeBanner").style.display="none")}function stopQuiz(){console.log("Stop button clicked. wrongAnswers:",wrongAnswers.length,wrongAnswers);totalQuestions=currentQuestionIndex+(hasAnswered?1:0),showResults()}function generateProgressTrackerTable(){let e='\n        <div style="margin: 20px 0; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">\n            <h3 style="color: var(--primary-color); margin-bottom: 15px; font-size: 1.2em;">üìä Voortgang Overzicht</h3>\n            <div style="overflow-x: auto;">\n                <table style="width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">\n                    <thead>\n                        <tr style="background-color: var(--primary-color); color: white;">\n                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Categorie</th>\n                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">‚úì Goed</th>\n                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">‚úó Fout</th>\n                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">üìã L.O.V.A.</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n    ';const t=Object.keys(categoryProgress).sort();let n=0,o=0,r=0,s=0;return t.forEach(t=>{const i=categoryProgress[t];if(n+=i.correct,o+=i.incorrect,r+=i.lovaClicks,0===i.correct&&0===i.incorrect&&0===i.lovaClicks)return;e+=`\n            <tr style="background-color: ${s%2==0?"#f8f8f8":"#ffffff"};">\n                <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;">${t}</td>\n                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #28a745; font-weight: bold;">${i.correct}</td>\n                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #dc3545; font-weight: bold;">${i.incorrect}</td>\n                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--secondary-color); font-weight: bold;">${i.lovaClicks}</td>\n            </tr>\n        `,s++}),e+=`\n                        <tr style="background-color: var(--primary-color); color: white; font-weight: bold;">\n                            <td style="padding: 12px; border: 1px solid #ddd;">Totaal</td>\n                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${n}</td>\n                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${o}</td>\n                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${r}</td>\n                        </tr>\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    `,e}function showReviewPage(e){document.getElementById("quizPage").style.display="none",document.getElementById("reviewPage").style.display="block";const t=e-wrongAnswers.length;document.getElementById("reviewScore").textContent=`${t}/${e}`,1===wrongAnswers.length?document.getElementById("reviewMessage").textContent=CONFIG.reviewMessages.single:document.getElementById("reviewMessage").textContent=CONFIG.reviewMessages.multiple(wrongAnswers.length);const n=document.getElementById("wrongAnswersContainer");n.innerHTML="";const o=document.createElement("div");o.innerHTML=generateProgressTrackerTable(),n.appendChild(o),wrongAnswers.forEach((e,t)=>{const o=document.createElement("div");o.className="review-item";let r="";e.question.content&&(r+=`<div class="review-content">${e.question.content}</div>`),e.question.visual&&(r+=`<div class="review-content">${renderVisualData(e.question.visual)}</div>`),o.innerHTML=`\n            <div class="review-item-header">Vraag ${t+1}</div>\n            ${r}\n            <div class="review-question">${e.question.question}</div>\n\n            <div class="review-answer-section">\n                <span class="review-label">Jouw antwoord:</span>\n                <span class="review-your-answer">${e.userAnswer}</span>\n            </div>\n\n            <div class="review-answer-section">\n                <span class="review-label">Juiste antwoord:</span>\n                <span class="review-correct-answer">${e.correctAnswer}</span>\n            </div>\n\n            ${e.explanation?`<div class="review-explanation"><strong>Uitleg:</strong> ${e.explanation}</div>`:""}\n\n            ${e.question.extra_info?generateExtraInfoHtml(e.question.extra_info):""}\n\n            ${"open-ended"===e.questionType&&(e.question.strategy||e.question.tips)?generateStrategyTipsHtml(e.question):""}\n        `,n.appendChild(o)})}function generateExtraInfoHtml(e){let t='<div class="review-explanation">';return"string"==typeof e?t+=`<strong>Achtergrondinfo:</strong> ${e}`:e.concept||e.berekening?(e.concept&&(t+=`<strong>Concept:</strong> ${e.concept}<br><br>`),e.berekening&&e.berekening.length>0&&(t+="<strong>Berekening:</strong><ul>",e.berekening.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>")):e.tips&&(t+="<strong>Extra Tips:</strong><ul>",e.tips.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>"),t+="</div>",t}function generateStrategyTipsHtml(e){let t='<div class="review-explanation">';return e.strategy&&(t+=`<strong>Strategie:</strong> ${e.strategy}<br><br>`),e.tips&&e.tips.length>0&&(t+="<strong>Tips:</strong><ul>",e.tips.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>"),t+="</div>",t}let lovaHelpPanelExpanded=!1;function toggleLovaPanel(){lovaHelpPanelExpanded=!lovaHelpPanelExpanded;const e=document.getElementById("lovaHelpPanel");if(lovaHelpPanelExpanded){e.classList.add("expanded"),e.classList.remove("hidden"),lovaClickCount++,document.getElementById("lovaClicks").textContent=lovaClickCount;const t=randomizedQuestions[currentQuestionIndex];t&&t.theme&&categoryProgress[t.theme]&&categoryProgress[t.theme].lovaClicks++}else e.classList.remove("expanded"),setTimeout(()=>{lovaHelpPanelExpanded||e.classList.add("hidden")},CONFIG.lova.panelTransitionDuration)}function loadLovaHelpData(e){if(!e||!e.lova)return;const t=e.lova;if(t.stap1_lezen){document.getElementById("lovaHelpHoofdvraag").textContent=t.stap1_lezen.hoofdvraag;const e=document.getElementById("lovaHelpRuis");e.innerHTML="",t.stap1_lezen.ruis.forEach(t=>{const n=document.createElement("li");n.textContent=t,e.appendChild(n)});const n=document.getElementById("lovaHelpTussenstappen");n.innerHTML="",t.stap1_lezen.tussenstappen.forEach(e=>{const t=document.createElement("li");t.textContent=e,n.appendChild(t)})}if(t.stap2_ordenen){const e=document.getElementById("lovaHelpGetallen");e.innerHTML="",Object.entries(t.stap2_ordenen.relevante_getallen).forEach(([t,n])=>{const o=document.createElement("li");o.innerHTML=`<strong>${t}:</strong> ${n}`,e.appendChild(o)}),document.getElementById("lovaHelpTool").textContent=t.stap2_ordenen.tool}if(t.stap3_vormen&&t.stap3_vormen.bewerkingen){const e=document.getElementById("lovaHelpBewerkingen");e.innerHTML="",t.stap3_vormen.bewerkingen.forEach((t,n)=>{const o=document.createElement("div");o.className="lova-help-bewerking",o.innerHTML=`\n                <div class="lova-help-bewerking-stap">${n+1}. ${t.stap}</div>\n                <div class="lova-help-bewerking-uitleg">${t.uitleg}</div>\n                <div class="lova-help-bewerking-calc">${t.berekening} = ${t.resultaat}</div>\n            `,e.appendChild(o)})}t.stap4_antwoorden&&(document.getElementById("lovaHelpEenheid").textContent=t.stap4_antwoorden.verwachte_eenheid,document.getElementById("lovaHelpLogica").textContent=t.stap4_antwoorden.logica_check)}let lastMilestone=0;function updateStarProgress(e){const t=document.querySelectorAll(".star-icon"),n=Math.floor(e/100*5);t.forEach((e,t)=>{t<n?e.classList.contains("filled")||setTimeout(()=>{e.textContent="star",e.classList.add("filled")},100*t):(e.textContent="star_border",e.classList.remove("filled"))})}function checkMilestone(e){const t=document.getElementById("milestoneCelebration"),n=document.getElementById("milestoneMessage"),o=[{threshold:25,message:"üéâ Yes! Je bent al een kwart! Knap hoor!"},{threshold:50,message:"üí™ Wow! Je bent al op de helft! Ga zo door!"},{threshold:75,message:"üåü Top! Nog een klein stukje en je hebt het! üöÄ"},{threshold:100,message:"üèÜ Fantastisch! Je hebt alles gemaakt! Trots op jou!"}].find(t=>e>=t.threshold&&lastMilestone<t.threshold);o&&(lastMilestone=o.threshold,n.textContent=o.message,t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},3e3))}function resetMilestones(){lastMilestone=0}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("[App] Service Worker registered:",e.scope)}).catch(e=>{console.log("[App] Service Worker registration failed:",e)})});let mobileInteractionsInstance=null;function initializeMobileInteractions(){mobileInteractionsInstance||("undefined"!=typeof MobileInteractions?(mobileInteractionsInstance=new MobileInteractions({onSwipeNext:()=>{hasAnswered&&currentQuestionIndex<totalQuestions-1&&(console.log("[App] Swipe next detected"),nextQuestion())},onSwipePrevious:()=>{console.log("[App] Swipe previous detected (disabled)")}}),console.log("[App] Mobile interactions initialized")):console.warn("[App] MobileInteractions class not loaded"))}document.addEventListener("DOMContentLoaded",function(){if(window.location.pathname.endsWith("quiz.html")&&initializeMobileInteractions(),window.location.pathname.endsWith("quiz.html")){const e=sessionStorage.getItem("quizState");if(!e)return alert("Geen quiz data gevonden. Je wordt teruggestuurd naar de homepagina."),void(window.location.href="index.html");const t=JSON.parse(e);return currentSubject=t.currentSubject,currentTheme=t.currentTheme,currentQuiz=t.currentQuiz,randomizedQuestions=t.randomizedQuestions||[],totalQuestions=t.totalQuestions,currentQuestionIndex=t.currentQuestionIndex,score=t.score,wrongAnswers=t.wrongAnswers,lovaClickCount=t.lovaClickCount,categoryProgress=t.categoryProgress,hasAnswered=!1,selectedAnswer=null,useTextGrouping=t.useTextGrouping||!1,useTextGrouping&&(textGroups=t.textGroups||[],currentTextIndex=t.currentTextIndex||0,currentQuestionInText=t.currentQuestionInText||0,textGroups.length>currentTextIndex&&(currentTextGroup=textGroups[currentTextIndex])),document.getElementById("quizTitle")&&(document.getElementById("quizTitle").textContent=CONFIG.subjectTitles[t.subject]||"Quiz"),updateBreadcrumb(t.subject),initializeRewardSystem(),document.getElementById("quizPage")&&(document.getElementById("quizPage").style.display="block"),document.getElementById("resultsPage")&&(document.getElementById("resultsPage").style.display="none"),document.getElementById("reviewPage")&&(document.getElementById("reviewPage").style.display="none"),void loadCurrentQuestion()}checkForPausedQuiz();const e=localStorage.getItem("autoStartSubject"),t=localStorage.getItem("autoStartTheme");e&&(localStorage.removeItem("autoStartSubject"),localStorage.removeItem("autoStartTheme"),setTimeout(async()=>{const n=getFilePath(e),o=await loadJsonFile(n,e);o?(quizData[e]=o,currentSubject=e,t?(currentTheme=t,currentQuiz=o.filter(e=>e.theme===t)):(currentTheme=null,currentQuiz=o),startQuizWithData(e)):alert("Kon quiz data niet laden.")},100))}),window.addEventListener("pageshow",function(e){(e.persisted||window.performance&&2===window.performance.navigation.type)&&(window.location.pathname.endsWith("quiz.html")||(localStorage.removeItem("autoStartSubject"),localStorage.removeItem("autoStartTheme")))});const isTouchDevice=()=>"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;function addTouchFeedback(e){if(!e)return;let t=0,n=!1;e.addEventListener("touchstart",function(e){t=Date.now(),n=!1,this.classList.add("touch-active")},{passive:!0}),e.addEventListener("touchmove",function(e){n=!0,this.classList.remove("touch-active")},{passive:!0}),e.addEventListener("touchend",function(e){const o=Date.now()-t;this.classList.remove("touch-active"),!n&&o<500&&navigator.vibrate&&navigator.vibrate(10)},{passive:!0}),e.addEventListener("touchcancel",function(e){this.classList.remove("touch-active")},{passive:!0})}function initializeTouchInteractions(){document.querySelectorAll("button, .btn, .subject-card, .level-card, .theme-subtopic-card").forEach(e=>{addTouchFeedback(e)})}isTouchDevice()&&document.body.classList.add("touch-device"),document.addEventListener("touchstart",function(){},{passive:!0}),document.addEventListener("touchmove",function(){},{passive:!0}),isTouchDevice()&&document.addEventListener("DOMContentLoaded",function(){initializeTouchInteractions();const e=new MutationObserver(function(e){e.forEach(function(e){e.addedNodes.forEach(function(e){1===e.nodeType&&(e.matches(".option, button, .btn")&&addTouchFeedback(e),e.querySelectorAll(".option, button, .btn").forEach(addTouchFeedback))})})}),t=document.getElementById("quizPage");t&&e.observe(t,{childList:!0,subtree:!0})}),window.addEventListener("orientationchange",function(){setTimeout(function(){window.matchMedia("(orientation: landscape)").matches?(document.body.classList.add("landscape-mode"),document.body.classList.remove("portrait-mode")):(document.body.classList.add("portrait-mode"),document.body.classList.remove("landscape-mode")),document.body.style.display="none",document.body.offsetHeight,document.body.style.display=""},100)}),window.matchMedia("(orientation: landscape)").matches?document.body.classList.add("landscape-mode"):document.body.classList.add("portrait-mode"),document.addEventListener("DOMContentLoaded",function(){let e=0;document.addEventListener("touchend",function(t){const n=Date.now();n-e<=300&&t.target.matches("button, .btn, .option, .subject-card")&&t.preventDefault(),e=n},{passive:!1})});