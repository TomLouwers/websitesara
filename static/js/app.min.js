let quizData={};const jsonPath=CONFIG.jsonPath,CACHE_VERSION="1.0.0";let currentQuiz=null,randomizedQuestions=[],currentSubject=null,currentTheme=null,currentQuestionIndex=0,score=0,currentStreak=0,totalQuestions=0,selectedAnswer=null,hasAnswered=!1,wrongAnswers=[],currentQuestionErrors=0,incorrectOptions=new Set,textGroups=[],currentTextIndex=0,currentQuestionInText=0,currentTextGroup=null,useTextGrouping=!1,categoryProgress={},lovaClickCount=0;function renderVerhoudingstabel(e,t){e.innerHTML="",t&&t.verhoudingstabel&&VerhoudingstabelWidget.render(e,t.verhoudingstabel)}function getHighscoreKey(e,t){return`${CONFIG.storageKeys.highscorePrefix}${e}_${t||"all"}`}function getHighscore(e,t){const n=getHighscoreKey(e,t),o=localStorage.getItem(n);return o?parseInt(o):0}function saveHighscore(e,t,n){const o=getHighscoreKey(e,t);return n>getHighscore(e,t)&&(localStorage.setItem(o,n.toString()),!0)}function getUserName(){let e=localStorage.getItem(CONFIG.storageKeys.userName);return e||(e=prompt(CONFIG.defaults.userPrompt)||CONFIG.defaults.userName,localStorage.setItem(CONFIG.storageKeys.userName,e)),e}function initializeCategoryProgress(e){categoryProgress={};[...new Set(e.map(e=>e.theme).filter(e=>e))].forEach(e=>{categoryProgress[e]={correct:0,incorrect:0,lovaClicks:0}}),updateProgressTrackerDisplay()}function updateCategoryProgress(e,t){e&&categoryProgress[e]&&(t?categoryProgress[e].correct++:categoryProgress[e].incorrect++,updateProgressTrackerDisplay())}function checkStreakBonus(){let e=0,t=0;3===currentStreak?(e=2,t=3):5===currentStreak?(e=3,t=5):10===currentStreak&&(e=5,t=10),e>0&&(score+=e,showStreakBonus(t,e),updateProgressTrackerDisplay())}function showStreakBonus(e,t){const n=document.getElementById("streakBonus");n&&(n.innerHTML=`\n        <div class="streak-bonus-content">\n            <div class="streak-bonus-icon">üî•</div>\n            <div class="streak-bonus-text">${e}-STREAK BONUS!</div>\n            <div class="streak-bonus-points">+${t} punten!</div>\n        </div>\n    `,n.classList.remove("hidden"),n.classList.add("show"),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>{n.classList.add("hidden")},300)},2500))}function updateProgressTrackerDisplay(){let e=0,t=0;Object.keys(categoryProgress).sort().forEach(n=>{const o=categoryProgress[n];e+=o.correct,t+=o.incorrect});const n=document.getElementById("totalCorrect");n&&(n.textContent=score);const o=document.getElementById("totalCorrectNew");o&&(o.textContent=score);const s=document.getElementById("lovaClicks");s&&(s.textContent=lovaClickCount)}function shuffleArray(e){const t=[...e];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function createRandomizedQuestions(e){const t=[];return e.forEach(e=>{e.questions&&Array.isArray(e.questions)?e.questions.forEach(n=>{t.push({content:e.content,visual:e.visual,question:n.question,options:n.options,correct:n.correct,originalId:e.id,theme:e.theme,title:e.title,strategy:n.strategy,tips:n.tips,possible_answer:n.possible_answer,extra_info:n.extra_info,lova:n.lova,hint:n.hint})}):e.question&&t.push({content:e.content,visual:e.visual,question:e.question,options:e.options,correct:e.correct,originalId:e.id,theme:e.theme,title:e.title,strategy:e.strategy,tips:e.tips,possible_answer:e.possible_answer,extra_info:e.extra_info,lova:e.lova,hint:e.hint})}),shuffleArray(t)}function createTextGroups(e){const t=[];return e.forEach(e=>{const n={id:e.id,title:e.title,theme:e.theme,text_type:e.text_type,text:e.text||e.content,metadata:e.metadata,questions:[]};e.questions&&Array.isArray(e.questions)&&e.questions.forEach(e=>{n.questions.push({item_id:e.item_id,skill:e.skill,strategy:e.strategy,question:e.question,hint:e.hint,options:e.options,correct:e.correct,extra_info:e.extra_info})}),t.push(n)}),shuffleArray(t)}function getFilePath(e){const t=e.split("-"),n=t[0],o=t[1];if(CONFIG.subjectFilePaths&&CONFIG.subjectFilePaths[n]){const e=CONFIG.subjectFilePaths[n];if(o&&o.length>=2){const t=`groep${o.substring(1)}`;if(e[t]&&e[t][o])return e[t][o]}}const s={"basisvaardigheden-m3":"exercises/gb/gb_groep3_m3.json","basisvaardigheden-e3":"exercises/gb/gb_groep3_e3.json","basisvaardigheden-m4":"exercises/gb/gb_groep4_m4.json","basisvaardigheden-e4":"exercises/gb/gb_groep4_e4.json","basisvaardigheden-m5":"exercises/gb/gb_groep5_m5.json","basisvaardigheden-e5":"exercises/gb/gb_groep5_e5.json","basisvaardigheden-m6":"exercises/gb/gb_groep6_m6.json","basisvaardigheden-e6":"exercises/gb/gb_groep6_e6.json","basisvaardigheden-m7":"exercises/gb/gb_groep7_m7.json","basisvaardigheden-e7":"exercises/gb/gb_groep7_e7.json","basisvaardigheden-e8":"exercises/gb/gb_groep8_e8.json"};return s[e]?s[e]:"data/templates/"+e+CONFIG.templateFileSuffix}async function loadJsonFile(e){try{const t=`quiz_cache_${e}_v1.0.0`;try{const n=localStorage.getItem(t);if(n)return console.log(`Loaded ${e} from cache`),JSON.parse(n)}catch(e){console.warn("LocalStorage read failed:",e)}console.log(`Fetching ${e} from server`);const n=await fetch(jsonPath+e+"?v=1.0.0");if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();try{localStorage.setItem(t,JSON.stringify(o)),console.log(`Cached ${e} in localStorage`)}catch(e){console.warn("LocalStorage write failed (quota exceeded?):",e);try{const e=Object.keys(localStorage);for(const t of e)t.startsWith("quiz_cache_")&&!t.includes("_v1.0.0")&&localStorage.removeItem(t);localStorage.setItem(t,JSON.stringify(o))}catch(e){console.warn("Could not cache data even after cleanup")}}return o}catch(e){return console.error("Error loading JSON file:",e),alert("Fout bij het laden van het bestand. Controleer of de bestanden beschikbaar zijn."),null}}function showLevelSelection(e){document.getElementById("landingPage").style.display="none",document.getElementById("levelPage").style.display="block";const t={verhaaltjessommen:{title:"Verhaaltjessommen",icon:"calculate",color:"#FF7F69",description:"Los slimme rekenpuzzels op met contextrijke rekenproblemen"},basisvaardigheden:{title:"Getal & Bewerking",icon:"functions",color:"#FF7F69",description:"Train je rekenkundige basisvaardigheden en word steeds sneller"},woordenschat:{title:"Woordenschat",icon:"local_library",color:"#7FD4A8",description:"Vergroot je woordenkennis en leer nieuwe woorden en hun betekenis"},wereldorientatie:{title:"Wereldori√´ntatie",icon:"public",color:"#5FC5B8",description:"Ontdek alles over de aarde, geschiedenis, natuur en techniek"}}[e]||{title:e,icon:"school",color:"#4A7BA7",description:"Kies jouw niveau om te beginnen"};document.getElementById("levelTitle").textContent=t.title,document.getElementById("levelBreadcrumb").textContent=t.title,document.getElementById("levelDescription").textContent=t.description;const n=document.getElementById("levelSubjectIcon");n.innerHTML=`<i class="material-icons">${t.icon}</i>`,n.style.background=`linear-gradient(135deg, ${t.color} 0%, ${t.color}dd 100%)`;const o=document.getElementById("levelGrid");o.innerHTML="";[{group:4,icon:"üå±",title:"Groep 4",description:"M4 niveau",difficulty:"Basis",subject:e+"-emma"},{group:5,icon:"üìñ",title:"Groep 5",description:"M5 niveau",difficulty:"Midden",subject:e+"-kate"},{group:8,icon:"üèÜ",title:"Groep 8",description:"Eindtoets niveau",difficulty:"CITO",subject:e}].forEach(e=>{const t=document.createElement("div");t.className=`level-card level-${e.group}`,t.onclick=()=>loadSubject(e.subject),t.innerHTML=`\n            <div class="level-badge">${e.group}</div>\n            <h3 class="level-card-title">${e.title}</h3>\n            <p class="level-card-description">${e.description}</p>\n            <div class="level-card-icon">${e.icon}</div>\n            <span class="level-difficulty">${e.difficulty}</span>\n        `,o.appendChild(t)})}async function loadSubject(e){const t=getFilePath(e),n=await loadJsonFile(t);if(!n)return;quizData[e]=n,currentSubject=e;const o=[...new Set(n.map(e=>e.theme).filter(e=>e))];console.log("Loaded themes for subject:",e,o),showThemeSelection(e,o,n)}function showThemeSelection(e,t,n){document.getElementById("landingPage").style.display="none",document.getElementById("levelPage").style.display="none",document.getElementById("themePage").style.display="block";const o=CONFIG.subjectTitles[e]||e;document.getElementById("subjectTitle").textContent="Kies wat je wilt oefenen!",document.getElementById("themeBreadcrumb").textContent=o;const s=document.getElementById("themeGrid");s.innerHTML="";let r=0;n.forEach(e=>{Array.isArray(e.questions)?r+=e.questions.length:e.question&&(r+=1)});const i=document.createElement("div");i.className="theme-primary-cta",i.onclick=()=>startQuizWithTheme(e,null);const a=getHighscore(e,null),c=["Klaar om jezelf uit te dagen?","Hoeveel kun jij er goed beantwoorden?","Verdien badges terwijl je oefent!","Elke vraag maakt je wijzer!"],d=c[Math.floor(Math.random()*c.length)];if(i.innerHTML=`\n        <div class="theme-primary-content">\n            <div class="theme-primary-icon">\n                <i class="material-icons">rocket_launch</i>\n            </div>\n            <div class="theme-primary-text">\n                <h2 class="theme-primary-title">üöÄ Complete Mix Mode</h2>\n                <p class="theme-primary-description">${d}</p>\n                <div class="theme-primary-meta">\n                    <span class="theme-primary-badge">\n                        <i class="material-icons">quiz</i>\n                        ${r} vragen klaar!\n                    </span>\n                    ${a>0?`\n                        <span class="theme-primary-badge">\n                            <i class="material-icons">emoji_events</i>\n                            Highscore: ${a}\n                        </span>\n                    `:""}\n                </div>\n            </div>\n        </div>\n    `,s.appendChild(i),t&&t.length>0){const o=document.createElement("div");o.className="theme-subtopics-section";if(e.includes("verhaaltjessommen")||e.includes("basisvaardigheden")){const s=categorizeThemes(t);Object.entries(s).forEach(([t,s])=>{if(0===s.length)return;const r=document.createElement("div");r.className="theme-category-section";const i=document.createElement("div");i.className="theme-category-header",i.innerHTML=`<h3 class="theme-category-title">${t}</h3>`,r.appendChild(i);const a=document.createElement("div");a.className="theme-subtopics-grid",s.forEach((t,o)=>{addThemeCardNew(a,t,n,e,o)}),r.appendChild(a),o.appendChild(r)})}else{const s=document.createElement("div");s.className="theme-subtopics-grid",t.forEach((t,o)=>{addThemeCardNew(s,t,n,e,o)}),o.appendChild(s)}s.appendChild(o)}}function addThemeCardNew(e,t,n,o,s){const r=n.filter(e=>e.theme===t);let i=0;r.forEach(e=>{Array.isArray(e.questions)?i+=e.questions.length:e.question&&(i+=1)});const a=["color-teal","color-blue","color-purple","color-mint","color-coral","color-yellow"],c=a[s%a.length],d={optellen:"‚ûï",aftrekken:"‚ûñ",vermenigvuldigen:"‚úñÔ∏è",delen:"‚ûó",tijd:"‚è∞",geld:"üí∞",gewicht:"‚öñÔ∏è",verhoudingen:"üìä",inhoud:"üì¶",meetkunde:"üìê",oppervlakte:"üìè",omtrek:"üîÑ"}[t.toLowerCase()]||"üìö",l=document.createElement("div");l.className=`theme-subtopic-card ${c}`,l.onclick=()=>startQuizWithTheme(o,t);const u=getHighscore(o,t);l.innerHTML=`\n        <div class="theme-subtopic-header">\n            <span class="theme-subtopic-icon">${d}</span>\n            <h3 class="theme-subtopic-title">${t}</h3>\n        </div>\n        <div class="theme-subtopic-count">\n            <i class="material-icons">quiz</i>\n            <span>${i} vragen</span>\n        </div>\n        ${u>0?`\n            <div class="theme-subtopic-highscore">\n                <i class="material-icons">emoji_events</i>\n                <span>Highscore: ${u}</span>\n            </div>\n        `:""}\n        <div class="theme-subtopic-cta">\n            <span>Start oefenen</span>\n            <i class="material-icons">arrow_forward</i>\n        </div>\n    `,e.appendChild(l)}function addThemeCard(e,t,n,o){const s=n.filter(e=>e.theme===t);let r=0;s.forEach(e=>{Array.isArray(e.questions)?r+=e.questions.length:e.question&&(r+=1)});const i=document.createElement("div");i.className="subject-card theme-card-small",i.onclick=()=>startQuizWithTheme(o,t);const a=getHighscore(o,t);i.innerHTML=`\n        <div class="subject-icon-wrapper">\n            <i class="material-icons subject-icon-material">topic</i>\n        </div>\n        <div style="flex: 1;">\n            <h3>${t}</h3>\n            <p>${r} vragen</p>\n            ${a>0?`\n                <div class="theme-highscore">\n                    <i class="material-icons">emoji_events</i>\n                    <span>Highscore: ${a}</span>\n                </div>\n            `:""}\n        </div>\n    `,e.appendChild(i)}function categorizeThemes(e){const t={"üî¢ Rekenen":[],"üìè Meten & Verhoudingen":[]},n=["optellen","aftrekken","vermenigvuldigen","delen"],o=["tijd","geld","gewicht","verhoudingen","inhoud","meetkunde","oppervlakte","omtrek"];return e.forEach(e=>{const s=e.toLowerCase();n.includes(s)?t["üî¢ Rekenen"].push(e):(o.includes(s),t["üìè Meten & Verhoudingen"].push(e))}),t}function startQuizWithTheme(e,t){currentTheme=t;let n=quizData[e];currentQuiz=t?n.filter(e=>e.theme===t):n,startQuizWithData(e)}function startQuizWithData(e){currentQuestionIndex=0,score=0,hasAnswered=!1,wrongAnswers=[],lovaClickCount=0,resetMilestones();const t=e.split("-")[0];let n;useTextGrouping="begrijpendlezen"===t,useTextGrouping?(textGroups=createTextGroups(currentQuiz),totalQuestions=textGroups.reduce((e,t)=>e+t.questions.length,0),currentTextIndex=0,currentQuestionInText=0,randomizedQuestions=[],textGroups.forEach(e=>{e.questions.forEach(t=>{randomizedQuestions.push({...t,theme:e.theme})})}),initializeCategoryProgress(randomizedQuestions),n={subject:e,currentSubject:currentSubject,currentTheme:currentTheme,currentQuiz:currentQuiz,textGroups:textGroups,useTextGrouping:!0,currentTextIndex:0,currentQuestionInText:0,totalQuestions:totalQuestions,currentQuestionIndex:0,score:0,wrongAnswers:[],lovaClickCount:0,categoryProgress:categoryProgress}):(randomizedQuestions=createRandomizedQuestions(currentQuiz),totalQuestions=randomizedQuestions.length,initializeCategoryProgress(randomizedQuestions),n={subject:e,currentSubject:currentSubject,currentTheme:currentTheme,currentQuiz:currentQuiz,randomizedQuestions:randomizedQuestions,useTextGrouping:!1,totalQuestions:totalQuestions,currentQuestionIndex:0,score:0,wrongAnswers:[],lovaClickCount:0,categoryProgress:categoryProgress}),sessionStorage.setItem("quizState",JSON.stringify(n)),window.location.href="quiz.html"}function updateBreadcrumb(e){const t=document.getElementById("breadcrumbSubject"),n=document.getElementById("breadcrumbLevel"),o=document.getElementById("breadcrumbLevelSep");let s=e,r=null;e.endsWith("-emma")?(s=e.replace("-emma",""),r="Midden Groep 4"):e.endsWith("-kate")?(s=e.replace("-kate",""),r="Midden Groep 5"):["verhaaltjessommen","basisvaardigheden","wereldorientatie","woordenschat"].includes(e)&&(r="Groep 8"),t.textContent=CONFIG.subjectTitles[s]||CONFIG.subjectTitles[e]||e,r?(n.textContent=r,n.style.display="inline",o.style.display="inline"):(n.style.display="none",o.style.display="none");const i=document.getElementById("breadcrumbSubjectNew"),a=document.getElementById("breadcrumbLevelNew"),c=document.getElementById("breadcrumbLevelSepNew");i&&(i.textContent=CONFIG.subjectTitles[s]||CONFIG.subjectTitles[e]||e),a&&c&&(r?(a.textContent=r,a.style.display="inline",c.style.display="inline"):(a.style.display="none",c.style.display="none"))}function renderVisualData(e){if(!e||"table"!==e.type)return"";let t='<div class="table-container">';return t+='<table style="width: 100%; border-collapse: collapse; background-color: white;">',t+="<thead><tr>",e.headers.forEach(e=>{t+=`<th style="border: 2px solid #4A7BA7; padding: 12px; background-color: #4A7BA7; color: white; font-weight: 500; text-align: left; white-space: nowrap;">${e}</th>`}),t+="</tr></thead>",t+="<tbody>",e.rows.forEach((e,n)=>{t+=`<tr style="background-color: ${n%2==0?"#f8f8f8":"#ffffff"};">`,e.forEach(e=>{t+=`<td style="border: 1px solid #e0e0e0; padding: 10px; color: #2C3E50; word-wrap: break-word;">${e}</td>`}),t+="</tr>"}),t+="</tbody></table>",t+="</div>",t}function updateQuizCardHeader(e){const t=document.getElementById("quizSubjectIcon"),n=document.getElementById("quizCardSubjectTitle"),o=document.getElementById("quizCardSubtitle");if(!t||!n||!o)return;let s=e,r=null;e.endsWith("-emma")?(s=e.replace("-emma",""),r="Midden Groep 4"):e.endsWith("-kate")?(s=e.replace("-kate",""),r="Midden Groep 5"):["verhaaltjessommen","basisvaardigheden","wereldorientatie","woordenschat"].includes(e)&&(r="Groep 8");let i=CONFIG.subjectIcons[e]||CONFIG.subjectIcons[s]||"üìö";"üéì"===i&&(i="üìö"),t.textContent=i;const a=CONFIG.subjectTitles[s]||CONFIG.subjectTitles[e]||e;n.textContent=a,o.textContent=r||""}function loadCurrentQuestion(){const e=document.getElementById("questionCardMorph");if(window.cardMorphFeedbackInstance&&e?window.cardMorphFeedbackInstance.reset(e):e&&e.classList.remove("card-flip-out","card-flip-in"),useTextGrouping)return void loadTextGroupQuestion();if(currentQuestionIndex>=randomizedQuestions.length)return void showResults();const t=randomizedQuestions[currentQuestionIndex];currentQuestionErrors=0,incorrectOptions.clear();const n=document.getElementById("hintContainer");n&&(n.innerHTML="");const o=document.getElementById("hintContainerNew");o&&(o.innerHTML="");const s=currentQuestionIndex/totalQuestions*100,r=document.getElementById("progressLabel"),i=document.getElementById("progressPercentage"),a=document.getElementById("progressBarFill");r&&(r.textContent=`Vraag ${currentQuestionIndex+1} van ${totalQuestions}`),i&&(i.textContent=`${Math.round(s)}% voltooid`),a&&(a.style.width=`${s}%`);const c=document.getElementById("progressLabelNew"),d=document.getElementById("progressBarFillNew");c&&(c.textContent=`Vraag ${currentQuestionIndex+1} van ${totalQuestions}`),d&&(d.style.width=`${s}%`);const l=document.getElementById("questionCounter");l&&(l.textContent=`Vraag ${currentQuestionIndex+1} van ${totalQuestions}`),updateQuizCardHeader(currentSubject),updateStarProgress(s),checkMilestone(s);const u=document.getElementById("readingContent"),g=document.getElementById("readingContentNew"),m=document.getElementById("storyBlockWrapper");if(t.content||t.visual){let e="";if(t.content&&(e+=t.content),t.visual&&(e+=renderVisualData(t.visual)),u.innerHTML=e,u.classList.remove("hidden"),g){const t=g.querySelector(".story-text-content");t&&(t.innerHTML=e)}m&&m.classList.remove("hidden")}else u.classList.add("hidden"),m&&m.classList.add("hidden");document.getElementById("questionText").textContent=t.question;const p=document.getElementById("questionTextNew");p&&(p.textContent=t.question);const h=t.lova&&t.lova.stap1_lezen,y=document.getElementById("lovaHelpButton"),f=document.getElementById("lovaHelpButtonNew"),v=document.getElementById("lovaHelpPanel");h?(y.style.display="flex",f&&(f.style.display="inline-flex"),loadLovaHelpData(t),lovaHelpPanelExpanded=!1,v.classList.remove("expanded"),v.classList.add("hidden")):(y.style.display="none",f&&(f.style.display="none"),v.classList.add("hidden"));const b=document.getElementById("optionsContainer"),w=document.getElementById("textareaAnswer"),x=document.getElementById("feedbackSection"),I=document.getElementById("optionsContainerNew"),E=document.getElementById("textareaAnswerNew"),k=document.getElementById("feedbackSectionNew");if(x.classList.add("hidden"),x.classList.remove("correct","incorrect"),document.getElementById("correctAnswerDisplay").classList.add("hidden"),document.getElementById("extraInfoDisplay").classList.add("hidden"),document.getElementById("verhoudingstabelContainer").innerHTML="",document.getElementById("strategyAndTips").classList.add("hidden"),k){k.classList.add("hidden"),k.classList.remove("correct","incorrect");const e=document.getElementById("correctAnswerDisplayNew"),t=document.getElementById("extraInfoDisplayNew"),n=document.getElementById("verhoudingstabelContainerNew"),o=document.getElementById("strategyAndTipsNew");e&&e.classList.add("hidden"),t&&t.classList.add("hidden"),n&&(n.innerHTML=""),o&&o.classList.add("hidden")}if(t.options){b.classList.remove("hidden"),w.classList.add("hidden"),I&&I.classList.remove("hidden"),E&&E.classList.add("hidden"),b.innerHTML="",I&&(I.innerHTML="");shuffleArray(t.options).forEach((e,n)=>{const o=["A","B","C","D","E","F"][n]||String.fromCharCode(65+n);let s=!1;"string"==typeof e?s=e===t.options[t.correct]:void 0!==e.is_correct&&(s=e.is_correct);const r=document.createElement("div");if(r.className="option",r.setAttribute("data-correct",s),"object"==typeof e&&r.setAttribute("data-option",JSON.stringify(e)),r.textContent="string"==typeof e?e:e.text,r.onclick=()=>selectOption(n),b.appendChild(r),I){const t=document.createElement("div");t.className="option",t.setAttribute("data-letter",o),t.setAttribute("data-correct",s),"object"==typeof e&&t.setAttribute("data-option",JSON.stringify(e)),t.textContent="string"==typeof e?e:e.text,t.onclick=()=>selectOption(n),I.appendChild(t)}})}else b.classList.add("hidden"),w.classList.remove("hidden"),w.value="",I&&I.classList.add("hidden"),E&&(E.classList.remove("hidden"),E.value="");selectedAnswer=null,hasAnswered=!1,document.getElementById("submitBtn").classList.remove("hidden"),document.getElementById("nextBtn").classList.add("hidden")}function loadTextGroupQuestion(){if(currentTextIndex>=textGroups.length)return void showResults();if(currentTextGroup=textGroups[currentTextIndex],currentQuestionInText>=currentTextGroup.questions.length)return currentTextIndex++,currentQuestionInText=0,saveTextGroupProgress(),void loadTextGroupQuestion();const e=currentTextGroup.questions[currentQuestionInText];currentQuestionErrors=0,incorrectOptions.clear();const t=(calculateQuestionsCompleted()+currentQuestionInText+1)/totalQuestions*100,n=document.getElementById("progressLabelNew"),o=document.getElementById("progressBarFillNew");n&&(n.textContent=`Vraag ${currentQuestionInText+1}/${currentTextGroup.questions.length} van "${currentTextGroup.title}"`),o&&(o.style.width=`${t}%`),displayReadingText(currentTextGroup),displayQuestionMetadata(e);const s=document.getElementById("questionTextNew");s&&(s.textContent=e.question);const r=document.getElementById("hintContainerNew");r&&(r.innerHTML="",r.classList.add("hidden"));const i=document.getElementById("hintPillBtn"),a=document.getElementById("hintDisplay"),c=document.getElementById("hintDisplayText");e.hint&&i&&a&&c?(i.style.display="inline-flex",c.textContent=e.hint,a.style.display="none"):i&&a&&(i.style.display="none",a.style.display="none"),renderAnswerOptions(e);const d=document.getElementById("feedbackSectionNew");d&&d.classList.add("hidden"),document.getElementById("submitBtn").classList.remove("hidden"),document.getElementById("nextBtn").classList.add("hidden"),selectedAnswer=null,hasAnswered=!1}function calculateQuestionsCompleted(){let e=0;for(let t=0;t<currentTextIndex;t++)e+=textGroups[t].questions.length;return e}function displayReadingText(e){const t=document.getElementById("storyBlockWrapper"),n=document.querySelector(".story-text-content"),o=document.getElementById("readingContentNew");if(!t||!o)return;t.classList.remove("hidden"),n&&(n.innerHTML=`<p>${e.text}</p>`);const s=o.querySelector(".story-header-label span:nth-child(2)");s&&(s.textContent=e.title)}function displayQuestionMetadata(e){const t=document.getElementById("skillBadge"),n=document.getElementById("skillType"),o=document.getElementById("strategyBadge"),s=document.getElementById("strategyType");e.skill&&t&&n?(t.style.display="inline-flex",n.textContent=capitalizeFirst(e.skill)):t&&(t.style.display="none"),e.strategy&&o&&s?(o.style.display="inline-flex",s.textContent=capitalizeFirst(e.strategy)):o&&(o.style.display="none")}function renderAnswerOptions(e){const t=document.getElementById("optionsContainerNew");if(!t)return;t.innerHTML="",t.classList.remove("hidden");shuffleArray(e.options).forEach((n,o)=>{const s=document.createElement("div");let r,i,a;s.className="option","string"==typeof n?(r=n,i=String.fromCharCode(65+o),a=n===e.options[e.correct]):(r=n.text,i=String.fromCharCode(65+o),a=n.is_correct),s.setAttribute("data-letter",i),s.setAttribute("data-index",o),s.setAttribute("data-correct",a),"object"==typeof n&&s.setAttribute("data-option",JSON.stringify(n)),s.textContent=r,s.onclick=()=>selectOption(o),t.appendChild(s)})}function capitalizeFirst(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}function toggleHint(){const e=document.getElementById("hintDisplay"),t=document.getElementById("hintPillBtn");"none"===e.style.display?(e.style.display="block",t.classList.add("active")):(e.style.display="none",t.classList.remove("active"))}function saveTextGroupProgress(){if(!window.location.pathname.endsWith("quiz.html"))return;const e=JSON.parse(sessionStorage.getItem("quizState")||"{}");e.currentTextIndex=currentTextIndex,e.currentQuestionInText=currentQuestionInText,e.score=score,e.wrongAnswers=wrongAnswers,e.lovaClickCount=lovaClickCount,e.categoryProgress=categoryProgress,sessionStorage.setItem("quizState",JSON.stringify(e))}function selectOption(e){hasAnswered||incorrectOptions.has(e)||(document.querySelectorAll(".option").forEach(e=>{e.classList.remove("selected")}),document.querySelectorAll(".option")[e].classList.add("selected"),selectedAnswer=e)}function showCardMorphFeedback(e,t,n=null,o=null){const s=document.getElementById("questionCardMorph"),r=document.getElementById("nextBtn");if(!s)return void console.error("Question card morph wrapper not found");let i;i=e?InsightGenerator.generateCorrectInsight(t):InsightGenerator.generateIncorrectInsight(t,n);const a=InsightGenerator.buildConfirmation(t,o,e);window.cardMorphFeedbackInstance||(window.cardMorphFeedbackInstance=new CardMorphFeedback);const c=document.getElementById("feedbackSectionNew");c&&c.classList.add("hidden"),window.cardMorphFeedbackInstance.morph({isCorrect:e,insight:i,confirmation:a,questionCard:s,nextButton:r,onProceed:()=>{nextQuestion()}}),r&&r.classList.remove("hidden");const d=document.getElementById("submitBtn");d&&d.classList.add("hidden")}function populateEnhancedFeedback(e,t,n=null,o=null){const s=document.getElementById("feedbackSectionNew");if(!s)return;s.classList.remove("hidden","correct","incorrect"),s.classList.add(e?"correct":"incorrect");const r=document.getElementById("feedbackEmojiNew"),i=document.getElementById("feedbackHeadlineNew"),a=document.getElementById("feedbackAnswerConfirmNew"),c=document.getElementById("feedbackWhySection"),d=document.getElementById("feedbackWhySectionTitle"),l=document.getElementById("feedbackWhyContentNew"),u=document.getElementById("feedbackWorkedSection"),g=document.getElementById("feedbackWorkedExampleNew"),m=document.getElementById("feedbackTipSection"),p=document.getElementById("feedbackTipContentNew"),h=currentSubject&&currentSubject.startsWith("woordenschat");if(e)r&&(r.textContent="üéâ"),i&&(i.textContent="Top gedaan!"),a&&(a.textContent="Je hebt het juiste antwoord gekozen! Je bent goed bezig!"),d&&(d.textContent=h?"Zo gebruik je het woord:":"Waarom is dit goed?");else if(r&&(r.textContent="ü§ó"),i&&(i.textContent="Bijna! Probeer het nog een keer!"),d&&(d.textContent=h?"Zo gebruik je het woord:":"Waarom niet?"),a)if(null!==o&&t.options){const e="string"==typeof t.options[o]?t.options[o]:t.options[o].text,n=["A","B","C","D","E","F"][o]||"";a.textContent=`Het goede antwoord was ${n} ‚Äì ${e}`}else t.possible_answer&&(a.textContent=`Een goed antwoord is: ${t.possible_answer}`);if(c&&l&&(t.extra_info?"string"==typeof t.extra_info?(c.style.display="block",l.innerHTML=t.extra_info):t.extra_info.concept?(c.style.display="block",l.textContent=t.extra_info.concept):c.style.display="none":c.style.display="none"),u&&g&&t.extra_info?.berekening){u.style.display="block";const e=Array.isArray(t.extra_info.berekening)?t.extra_info.berekening.join("\n"):t.extra_info.berekening;g.textContent=e}else u&&(u.style.display="none");if(m&&p)if(e)m.style.display="none";else{let e="";if(n&&"object"==typeof n&&n.foutanalyse){e=n.foutanalyse.split("ü§î")[0].trim(),e=e.replace(/\*\*/g,"")}else e=t.extra_info?.tips&&Array.isArray(t.extra_info.tips)&&t.extra_info.tips.length>0?t.extra_info.tips[0]:t.theme&&t.theme.includes("tafels")?"Oefen de tafels regelmatig om ze beter te onthouden!":t.theme&&t.theme.includes("geld")?"Let goed op de komma bij geldbedragen!":"Lees de vraag nog een keer goed door. Wat wordt er precies gevraagd?";e?(m.style.display="block",p.textContent=e):m.style.display="none"}}function submitAnswer(){if(hasAnswered)return;let e;e=useTextGrouping?currentTextGroup.questions[currentQuestionInText]:randomizedQuestions[currentQuestionIndex];const t=document.getElementById("feedbackSection"),n=document.getElementById("feedbackTitle"),o=document.getElementById("feedbackMessage"),s=document.getElementById("correctAnswerDisplay"),r=document.getElementById("extraInfoDisplay"),i=document.getElementById("verhoudingstabelContainer"),a=document.getElementById("strategyAndTips"),c=document.getElementById("strategyText"),d=document.getElementById("tipsList");t.classList.remove("hidden");const l=document.getElementById("feedbackSectionNew");if(l&&l.classList.remove("hidden"),e.options){if(null===selectedAnswer)return alert(CONFIG.feedback.noAnswer.multipleChoice),t.classList.add("hidden"),void(l&&l.classList.add("hidden"));const n=document.querySelectorAll(".option"),o=n[selectedAnswer],s=o&&"true"===o.getAttribute("data-correct");let a=null;if(o){const t=o.getAttribute("data-option");t?a=JSON.parse(t):"string"==typeof e.options[selectedAnswer]&&(a=e.options[selectedAnswer])}let c=e.options.findIndex(e=>!("object"!=typeof e||!e.hasOwnProperty("is_correct"))&&!0===e.is_correct);if(-1===c&&null!==e.correct&&void 0!==e.correct&&(c=e.correct),-1===c){const o=e.options.some(e=>"object"==typeof e&&e.text),s=e.options.some(e=>"object"==typeof e&&"is_correct"in e);return o&&!s?(console.error("Incomplete question data - missing is_correct field",{questionId:e.originalId,title:e.title,question:e.question}),alert(`Deze vraag is nog niet compleet bijgewerkt in het systeem (ID: ${e.originalId}).\n\nGa door naar de volgende vraag.`)):(console.error("Error: Could not determine correct answer index",{correctIndex:c,optionsLength:n.length,questionId:e.originalId}),alert("Er is een fout opgetreden bij het controleren van het antwoord. Probeer opnieuw of neem contact op met de beheerder.")),t.classList.add("hidden"),hasAnswered=!0,document.getElementById("submitBtn").classList.add("hidden"),void document.getElementById("nextBtn").classList.remove("hidden")}if(s){n[selectedAnswer].classList.add("correct");const o=document.querySelectorAll(".quiz-answers-wrapper .option");o[selectedAnswer]&&o[selectedAnswer].classList.add("is-correct"),score++,currentStreak++,checkStreakBonus(),updateCategoryProgress(e.theme,!0);if("verhaaltjessommen"===currentSubject&&e.lova&&e.extra_info){const t=wrongAnswers.findIndex(t=>t.question.originalId===e.originalId);-1!==t&&wrongAnswers.splice(t,1)}t.classList.add("hidden"),showCardMorphFeedback(!0,e,null,c)}else{currentQuestionErrors++,currentStreak=0,updateCategoryProgress(e.theme,!1);const o="object"==typeof a&&a.foutanalyse?a.foutanalyse:"",s="verhaaltjessommen"===currentSubject&&a.error_type&&e.extra_info;console.log("Incorrect answer check:",{currentSubject:currentSubject,hasErrorType:!!a.error_type,hasExtraInfo:!!e.extra_info,isVerhaaltjessom:s}),n[selectedAnswer].classList.add("incorrect");const d=document.querySelectorAll(".quiz-answers-wrapper .option");d[selectedAnswer]&&d[selectedAnswer].classList.add("is-incorrect");const l=Array.from(n).find(e=>"true"===e.getAttribute("data-correct"));l&&l.classList.add("correct");const u=Array.from(d).find(e=>"true"===e.getAttribute("data-correct"));u&&u.classList.add("is-correct"),t.classList.add("hidden"),showCardMorphFeedback(!1,e,a,c);if(!wrongAnswers.some(t=>t.question.originalId===e.originalId)){const t="string"==typeof a?a:a.text,n="string"==typeof e.options[c]?e.options[c]:e.options[c].text;wrongAnswers.push({question:e,userAnswer:t,correctAnswer:n,explanation:o||"Zie uitleg voor details",questionType:s?"verhaaltjessom":"multiple-choice"}),console.log("‚úì Tracked wrong answer. Total wrongAnswers:",wrongAnswers.length)}if(e.extra_info)if(renderVerhoudingstabel(i,e.extra_info),"string"==typeof e.extra_info)r.innerHTML=`<h4>Achtergrondinfo:</h4><p>${e.extra_info}</p>`,r.classList.remove("hidden");else if(e.extra_info.concept||e.extra_info.berekening){let t="";e.extra_info.concept&&(t+=`<h4>Concept:</h4><p>${e.extra_info.concept}</p>`),e.extra_info.berekening&&e.extra_info.berekening.length>0&&(t+="<h4>Berekening:</h4><ul>",e.extra_info.berekening.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>"),r.innerHTML=t,r.classList.remove("hidden")}else if(e.extra_info.tips){let t="<h4>Extra Tips:</h4><ul>";e.extra_info.tips.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>",r.innerHTML=t,r.classList.remove("hidden")}else r.classList.add("hidden");else r.classList.add("hidden"),i.innerHTML=""}}else{const u=document.getElementById("textareaAnswer").value.trim();if(!u)return alert(CONFIG.feedback.noAnswer.openEnded),t.classList.add("hidden"),void(l&&l.classList.add("hidden"));const g=e.possible_answer?e.possible_answer.toLowerCase().trim():"";if(u.toLowerCase()===g)score++,currentStreak++,checkStreakBonus(),t.classList.add("correct"),n.textContent=CONFIG.feedback.correct.title,o.textContent=CONFIG.feedback.correct.message,s.classList.add("hidden"),r.classList.add("hidden"),i.innerHTML="",a.classList.add("hidden"),showCardMorphFeedback(!0,e,null,0),updateCategoryProgress(e.theme,!0);else{currentQuestionErrors++,currentStreak=0,t.classList.add("incorrect"),n.textContent=CONFIG.feedback.incorrect.title,o.textContent=CONFIG.feedback.incorrect.messageWithTips;const l={text:e.possible_answer,foutanalyse:`Het antwoord was: "${e.possible_answer}". Probeer het nog een keer!`};showCardMorphFeedback(!1,e,l,0),updateCategoryProgress(e.theme,!1),1===currentQuestionErrors&&e.hint&&showHintButton(e.hint),s.textContent=`Voorbeeld antwoord: "${e.possible_answer}"`,s.classList.remove("hidden"),wrongAnswers.push({question:e,userAnswer:u,correctAnswer:e.possible_answer,explanation:o.textContent,questionType:"open-ended"}),e.strategy||e.tips&&e.tips.length>0?(a.classList.remove("hidden"),c.textContent=e.strategy||"Geen specifieke strategie beschikbaar.",d.innerHTML="",e.tips&&e.tips.length>0?e.tips.forEach(e=>{const t=document.createElement("li");t.textContent=e,d.appendChild(t)}):d.innerHTML="<li>Geen specifieke tips beschikbaar.</li>"):a.classList.add("hidden"),e.extra_info?(renderVerhoudingstabel(i,e.extra_info),r.textContent=`Achtergrondinfo: ${e.extra_info}`,r.classList.remove("hidden")):(r.classList.add("hidden"),i.innerHTML="")}}hasAnswered=!0,document.getElementById("submitBtn").classList.add("hidden");const u=currentSubject&&currentSubject.startsWith("woordenschat"),g=document.getElementById("nextBtn");u&&e.extra_info?(g.classList.add("hidden"),setTimeout(()=>{showWoordenschatModal(e.extra_info)},1500),setTimeout(()=>{g.classList.remove("hidden")},8e3)):g.classList.remove("hidden")}function showWoordenschatModal(e){const t=document.getElementById("woordenschatModal"),n=document.getElementById("woordenschatModalSentence");t&&n&&(n.innerHTML=e,t.classList.remove("hidden","fade-out"),setTimeout(()=>{t.classList.add("fade-out"),setTimeout(()=>{t.classList.add("hidden"),t.classList.remove("fade-out")},800)},5e3))}function nextQuestion(){closeSuccessModaal(),closeFoutanalyseModaal(),"function"==typeof resetAttemptTracking&&resetAttemptTracking();const e=document.getElementById("hintContainer");if(e&&(e.innerHTML=""),useTextGrouping)return currentQuestionInText++,saveTextGroupProgress(),void loadCurrentQuestion();if(currentQuestionIndex++,window.location.pathname.endsWith("quiz.html")){const e=JSON.parse(sessionStorage.getItem("quizState")||"{}");e.currentQuestionIndex=currentQuestionIndex,e.score=score,e.wrongAnswers=wrongAnswers,e.lovaClickCount=lovaClickCount,e.categoryProgress=categoryProgress,sessionStorage.setItem("quizState",JSON.stringify(e))}currentQuestionIndex>=randomizedQuestions.length?showResults():loadCurrentQuestion()}function showResults(){document.getElementById("quizPage").style.display="none",document.getElementById("resultsPage").style.display="block";const e=saveHighscore(currentSubject,currentTheme,score);let t=0;Object.keys(categoryProgress).forEach(e=>{t+=categoryProgress[e].correct});const n=totalQuestions>0?Math.round(t/totalQuestions*100):0,o=wrongAnswers.length;populateHeroBlock(n,t,o,e,score),populateSkillsOverview(),populateQuestionAccordion()}function populateHeroBlock(e,t,n,o,s){const r=document.getElementById("resultEmoji"),i=document.getElementById("resultHeadline"),a=document.getElementById("resultSummary"),c=document.getElementById("resultGrowthBadge"),d=document.getElementById("growthText");let l,u;e>=90?(l="üéâ",u=o?"Nieuw record! Fantastisch!":"Wauw! Geweldig gedaan!"):e>=70?(l="üåü",u="Knap gewerkt!"):e>=50?(l="üí™",u="Goed bezig!"):(l="üöÄ",u="Elke vraag maakt je sterker!"),r.textContent=l,i.textContent=u;let g="";if(g=1===t?"Je hebt 1 vraag goed beantwoord!":t>1?`Je hebt ${t} vragen goed beantwoord!`:"Elke vraag is een leerkans!",s>t){g+=` (${s} punten inclusief ${s-t} bonuspunten!)`}if(n>0&&(g+=1===n?" En 1 vraag maakt je weer een beetje sterker!":` En ${n} vragen maken je weer een beetje sterker!`),a.textContent=g,n>0){c.style.display="flex";const e=1===n?"1 leerpunt":`${n} leerpunten`;d.textContent=`Je hebt ${e} verdiend!`}else c.style.display="none"}function populateSkillsOverview(){const e=document.getElementById("skillsChips"),t=document.getElementById("skillsOverview"),n=Object.keys(categoryProgress);0!==n.length?(t.style.display="block",e.innerHTML="",n.forEach(t=>{const n=categoryProgress[t],o=n.correct+n.incorrect,s=o>0?Math.round(n.correct/o*100):0,r=document.createElement("div");let i,a,c;r.className="skill-chip",s>=80?(i="‚≠ê",a="Goed gedaan!",c="skill-chip-excellent"):s>=50?(i="üëç",a="Lekker bezig!",c="skill-chip-good"):(i="üí°",a="Hier kun je nog sterker in worden",c="skill-chip-growth"),r.classList.add(c);const d={optellen:"‚ûï",aftrekken:"‚ûñ",vermenigvuldigen:"‚úñÔ∏è",delen:"‚ûó",breuken:"¬Ω",procenten:"%",meten:"üìè",tijd:"‚è∞",geld:"üí∞","basis-rekenen":"üî¢","omrekenen-eenheden":"‚öñÔ∏è",kommagetallen:"0.0",getallenlijn:"üìä",verhoudingstabellen:"üìà"}[t.toLowerCase()]||"üìö";r.innerHTML=`\n            <span class="skill-chip-icon">${d}</span>\n            <span class="skill-chip-label">${t}</span>\n            <span class="skill-chip-status">${i} ${a}</span>\n        `,e.appendChild(r)})):t.style.display="none"}function populateQuestionAccordion(){const e=document.getElementById("questionAccordion"),t=document.getElementById("questionReviewSection");0!==wrongAnswers.length?(t.style.display="block",e.innerHTML="",wrongAnswers.forEach((t,n)=>{const o=document.createElement("div");o.className="accordion-item";const s=document.createElement("div");s.className="accordion-header",s.innerHTML=`\n            <span class="accordion-status status-growth">üí° Hier kun je nog groeien</span>\n            <span class="accordion-title">Vraag ${n+1}</span>\n            <span class="accordion-icon">‚ñº</span>\n        `;const r=document.createElement("div");r.className="accordion-content",r.style.display="none";let i="";t.question.content&&t.question.content.trim()&&(i+=`\n                <div class="verhaaltje-box">\n                    <div class="verhaaltje-label">üìñ Verhaaltje</div>\n                    <p>${t.question.content}</p>\n                </div>\n            `),i+=`<div class="question-text-review"><strong>Vraag:</strong> ${t.question.question}</div>`;i+=`\n            <div class="answer-comparison">\n                <div class="answer-box answer-user">\n                    <div class="answer-label">Jouw antwoord:</div>\n                    <div class="answer-value">${t.userAnswer||"Niet beantwoord"}</div>\n                </div>\n                <div class="answer-box answer-correct">\n                    <div class="answer-label">Goede antwoord:</div>\n                    <div class="answer-value">‚úì ${t.correctAnswer||"Onbekend"}</div>\n                </div>\n            </div>\n        `,i+='<div class="explanation-section">',t.question.extra_info&&t.question.extra_info.concept&&(i+=`\n                <div class="explanation-block">\n                    <h4 class="explanation-heading">üß† Waarom?</h4>\n                    <p>${t.question.extra_info.concept}</p>\n                </div>\n            `),t.question.extra_info&&t.question.extra_info.strategy&&(i+=`\n                <div class="explanation-block">\n                    <h4 class="explanation-heading">‚û°Ô∏è Zo werkt het:</h4>\n                    <p>${t.question.extra_info.strategy}</p>\n                </div>\n            `),t.question.extra_info&&t.question.extra_info.tips&&t.question.extra_info.tips.length>0&&(i+=`\n                <div class="explanation-block">\n                    <h4 class="explanation-heading">üí° Tip voor de volgende keer:</h4>\n                    <p>${t.question.extra_info.tips[0]}</p>\n                </div>\n            `),i+="</div>",r.innerHTML=i,s.onclick=function(){const e="block"===r.style.display;r.style.display=e?"none":"block",s.querySelector(".accordion-icon").textContent=e?"‚ñº":"‚ñ≤",o.classList.toggle("active",!e)},o.appendChild(s),o.appendChild(r),e.appendChild(o)})):t.style.display="none"}function restartQuiz(){currentQuestionIndex=0,score=0,hasAnswered=!1,wrongAnswers=[],lovaClickCount=0,currentQuestionErrors=0,incorrectOptions.clear(),initializeCategoryProgress(randomizedQuestions),document.getElementById("resultsPage").style.display="none",document.getElementById("quizPage").style.display="block",loadCurrentQuestion()}function goToLanding(){if(localStorage.removeItem("autoStartSubject"),localStorage.removeItem("autoStartTheme"),window.location.pathname.endsWith("quiz.html"))return sessionStorage.removeItem("quizState"),void(window.location.href="index.html");document.getElementById("landingPage")&&(document.getElementById("landingPage").style.display="block"),document.getElementById("levelPage")&&(document.getElementById("levelPage").style.display="none"),document.getElementById("themePage")&&(document.getElementById("themePage").style.display="none"),document.getElementById("quizPage")&&(document.getElementById("quizPage").style.display="none"),document.getElementById("resultsPage")&&(document.getElementById("resultsPage").style.display="none"),document.getElementById("reviewPage")&&(document.getElementById("reviewPage").style.display="none"),currentQuiz=null,randomizedQuestions=[],currentSubject=null,currentTheme=null,currentQuestionIndex=0,score=0,totalQuestions=0,selectedAnswer=null,hasAnswered=!1,wrongAnswers=[],lovaClickCount=0,lovaHelpPanelExpanded=!1,"function"==typeof checkForPausedQuiz&&checkForPausedQuiz()}function toggleFocusMode(){const e=document.body,t=document.getElementById("focusModeToggle"),n=t.querySelector("i");e.classList.toggle("focus-mode"),e.classList.contains("focus-mode")?(n.textContent="visibility",t.title="Exit Focus Modus"):(n.textContent="visibility_off",t.title="Focus Modus")}function pauseQuiz(){const e={subject:currentSubject,theme:currentTheme,quiz:currentQuiz,randomizedQuestions:randomizedQuestions,currentQuestionIndex:currentQuestionIndex,score:score,totalQuestions:totalQuestions,wrongAnswers:wrongAnswers,categoryProgress:categoryProgress,lovaClickCount:lovaClickCount,timestamp:Date.now()};localStorage.setItem("pausedQuiz",JSON.stringify(e)),alert("Quiz gepauzeerd! Je kunt later doorgaan waar je gebleven bent."),goToLanding()}function checkForPausedQuiz(){const e=localStorage.getItem("pausedQuiz"),t=document.getElementById("resumeBanner"),n=document.getElementById("resumeDetails");if(e)try{const o=JSON.parse(e),s=CONFIG.subjectTitles[o.subject]||o.subject,r=`${o.currentQuestionIndex} van ${o.totalQuestions} vragen`;n.textContent=`${s} - ${r} beantwoord`,t.style.display="flex"}catch(e){console.error("Error parsing paused quiz:",e),localStorage.removeItem("pausedQuiz")}else t.style.display="none"}function resumePausedQuiz(){const e=localStorage.getItem("pausedQuiz");if(e)try{const t=JSON.parse(e);currentSubject=t.subject,currentTheme=t.theme,currentQuiz=t.quiz,randomizedQuestions=t.randomizedQuestions,currentQuestionIndex=t.currentQuestionIndex,score=t.score,totalQuestions=t.totalQuestions,wrongAnswers=t.wrongAnswers,categoryProgress=t.categoryProgress,lovaClickCount=t.lovaClickCount||0,hasAnswered=!1,selectedAnswer=null,document.getElementById("landingPage").style.display="none",document.getElementById("quizPage").style.display="block",document.getElementById("quizTitle").textContent=CONFIG.subjectTitles[currentSubject]||"Quiz",updateBreadcrumb(currentSubject),loadCurrentQuestion(),localStorage.removeItem("pausedQuiz")}catch(e){console.error("Error resuming quiz:",e),alert("Fout bij het hervatten van de quiz. De opgeslagen data is mogelijk beschadigd."),localStorage.removeItem("pausedQuiz")}else alert("Geen gepauzeerde quiz gevonden.")}function clearPausedQuiz(){confirm("Weet je zeker dat je de gepauzeerde quiz wilt verwijderen?")&&(localStorage.removeItem("pausedQuiz"),document.getElementById("resumeBanner").style.display="none")}function stopQuiz(){console.log("Stop button clicked. wrongAnswers:",wrongAnswers.length,wrongAnswers);totalQuestions=currentQuestionIndex+(hasAnswered?1:0),showResults()}function generateProgressTrackerTable(){let e='\n        <div style="margin: 20px 0; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">\n            <h3 style="color: var(--primary-color); margin-bottom: 15px; font-size: 1.2em;">üìä Voortgang Overzicht</h3>\n            <div style="overflow-x: auto;">\n                <table style="width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">\n                    <thead>\n                        <tr style="background-color: var(--primary-color); color: white;">\n                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Categorie</th>\n                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">‚úì Goed</th>\n                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">‚úó Fout</th>\n                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">üìã L.O.V.A.</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n    ';const t=Object.keys(categoryProgress).sort();let n=0,o=0,s=0,r=0;return t.forEach(t=>{const i=categoryProgress[t];if(n+=i.correct,o+=i.incorrect,s+=i.lovaClicks,0===i.correct&&0===i.incorrect&&0===i.lovaClicks)return;e+=`\n            <tr style="background-color: ${r%2==0?"#f8f8f8":"#ffffff"};">\n                <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;">${t}</td>\n                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #28a745; font-weight: bold;">${i.correct}</td>\n                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #dc3545; font-weight: bold;">${i.incorrect}</td>\n                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--secondary-color); font-weight: bold;">${i.lovaClicks}</td>\n            </tr>\n        `,r++}),e+=`\n                        <tr style="background-color: var(--primary-color); color: white; font-weight: bold;">\n                            <td style="padding: 12px; border: 1px solid #ddd;">Totaal</td>\n                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${n}</td>\n                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${o}</td>\n                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${s}</td>\n                        </tr>\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    `,e}function showReviewPage(e){document.getElementById("quizPage").style.display="none",document.getElementById("reviewPage").style.display="block";const t=e-wrongAnswers.length;document.getElementById("reviewScore").textContent=`${t}/${e}`,1===wrongAnswers.length?document.getElementById("reviewMessage").textContent=CONFIG.reviewMessages.single:document.getElementById("reviewMessage").textContent=CONFIG.reviewMessages.multiple(wrongAnswers.length);const n=document.getElementById("wrongAnswersContainer");n.innerHTML="";const o=document.createElement("div");o.innerHTML=generateProgressTrackerTable(),n.appendChild(o),wrongAnswers.forEach((e,t)=>{const o=document.createElement("div");o.className="review-item";let s="";e.question.content&&(s+=`<div class="review-content">${e.question.content}</div>`),e.question.visual&&(s+=`<div class="review-content">${renderVisualData(e.question.visual)}</div>`),o.innerHTML=`\n            <div class="review-item-header">Vraag ${t+1}</div>\n            ${s}\n            <div class="review-question">${e.question.question}</div>\n\n            <div class="review-answer-section">\n                <span class="review-label">Jouw antwoord:</span>\n                <span class="review-your-answer">${e.userAnswer}</span>\n            </div>\n\n            <div class="review-answer-section">\n                <span class="review-label">Juiste antwoord:</span>\n                <span class="review-correct-answer">${e.correctAnswer}</span>\n            </div>\n\n            ${e.explanation?`<div class="review-explanation"><strong>Uitleg:</strong> ${e.explanation}</div>`:""}\n\n            ${e.question.extra_info?generateExtraInfoHtml(e.question.extra_info):""}\n\n            ${"open-ended"===e.questionType&&(e.question.strategy||e.question.tips)?generateStrategyTipsHtml(e.question):""}\n        `,n.appendChild(o)})}function generateExtraInfoHtml(e){let t='<div class="review-explanation">';return"string"==typeof e?t+=`<strong>Achtergrondinfo:</strong> ${e}`:e.concept||e.berekening?(e.concept&&(t+=`<strong>Concept:</strong> ${e.concept}<br><br>`),e.berekening&&e.berekening.length>0&&(t+="<strong>Berekening:</strong><ul>",e.berekening.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>")):e.tips&&(t+="<strong>Extra Tips:</strong><ul>",e.tips.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>"),t+="</div>",t}function generateStrategyTipsHtml(e){let t='<div class="review-explanation">';return e.strategy&&(t+=`<strong>Strategie:</strong> ${e.strategy}<br><br>`),e.tips&&e.tips.length>0&&(t+="<strong>Tips:</strong><ul>",e.tips.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>"),t+="</div>",t}let lovaHelpPanelExpanded=!1;function toggleLovaPanel(){lovaHelpPanelExpanded=!lovaHelpPanelExpanded;const e=document.getElementById("lovaHelpPanel");if(lovaHelpPanelExpanded){e.classList.add("expanded"),e.classList.remove("hidden"),lovaClickCount++,document.getElementById("lovaClicks").textContent=lovaClickCount;const t=randomizedQuestions[currentQuestionIndex];t&&t.theme&&categoryProgress[t.theme]&&categoryProgress[t.theme].lovaClicks++}else e.classList.remove("expanded"),setTimeout(()=>{lovaHelpPanelExpanded||e.classList.add("hidden")},CONFIG.lova.panelTransitionDuration)}function loadLovaHelpData(e){if(!e||!e.lova)return;const t=e.lova;if(t.stap1_lezen){document.getElementById("lovaHelpHoofdvraag").textContent=t.stap1_lezen.hoofdvraag;const e=document.getElementById("lovaHelpRuis");e.innerHTML="",t.stap1_lezen.ruis.forEach(t=>{const n=document.createElement("li");n.textContent=t,e.appendChild(n)});const n=document.getElementById("lovaHelpTussenstappen");n.innerHTML="",t.stap1_lezen.tussenstappen.forEach(e=>{const t=document.createElement("li");t.textContent=e,n.appendChild(t)})}if(t.stap2_ordenen){const e=document.getElementById("lovaHelpGetallen");e.innerHTML="",Object.entries(t.stap2_ordenen.relevante_getallen).forEach(([t,n])=>{const o=document.createElement("li");o.innerHTML=`<strong>${t}:</strong> ${n}`,e.appendChild(o)}),document.getElementById("lovaHelpTool").textContent=t.stap2_ordenen.tool}if(t.stap3_vormen&&t.stap3_vormen.bewerkingen){const e=document.getElementById("lovaHelpBewerkingen");e.innerHTML="",t.stap3_vormen.bewerkingen.forEach((t,n)=>{const o=document.createElement("div");o.className="lova-help-bewerking",o.innerHTML=`\n                <div class="lova-help-bewerking-stap">${n+1}. ${t.stap}</div>\n                <div class="lova-help-bewerking-uitleg">${t.uitleg}</div>\n                <div class="lova-help-bewerking-calc">${t.berekening} = ${t.resultaat}</div>\n            `,e.appendChild(o)})}t.stap4_antwoorden&&(document.getElementById("lovaHelpEenheid").textContent=t.stap4_antwoorden.verwachte_eenheid,document.getElementById("lovaHelpLogica").textContent=t.stap4_antwoorden.logica_check)}let lastMilestone=0;function updateStarProgress(e){const t=document.querySelectorAll(".star-icon"),n=Math.floor(e/100*5);t.forEach((e,t)=>{t<n?e.classList.contains("filled")||setTimeout(()=>{e.textContent="star",e.classList.add("filled")},100*t):(e.textContent="star_border",e.classList.remove("filled"))})}function checkMilestone(e){const t=document.getElementById("milestoneCelebration"),n=document.getElementById("milestoneMessage"),o=[{threshold:25,message:"üéâ Yes! Je bent al een kwart! Knap hoor!"},{threshold:50,message:"üí™ Wow! Je bent al op de helft! Ga zo door!"},{threshold:75,message:"üåü Top! Nog een klein stukje en je hebt het! üöÄ"},{threshold:100,message:"üèÜ Fantastisch! Je hebt alles gemaakt! Trots op jou!"}].find(t=>e>=t.threshold&&lastMilestone<t.threshold);o&&(lastMilestone=o.threshold,n.textContent=o.message,t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},3e3))}function resetMilestones(){lastMilestone=0}document.addEventListener("DOMContentLoaded",function(){if(window.location.pathname.endsWith("quiz.html")){const e=sessionStorage.getItem("quizState");if(!e)return alert("Geen quiz data gevonden. Je wordt teruggestuurd naar de homepagina."),void(window.location.href="index.html");const t=JSON.parse(e);return currentSubject=t.currentSubject,currentTheme=t.currentTheme,currentQuiz=t.currentQuiz,randomizedQuestions=t.randomizedQuestions||[],totalQuestions=t.totalQuestions,currentQuestionIndex=t.currentQuestionIndex,score=t.score,wrongAnswers=t.wrongAnswers,lovaClickCount=t.lovaClickCount,categoryProgress=t.categoryProgress,hasAnswered=!1,selectedAnswer=null,useTextGrouping=t.useTextGrouping||!1,useTextGrouping&&(textGroups=t.textGroups||[],currentTextIndex=t.currentTextIndex||0,currentQuestionInText=t.currentQuestionInText||0,textGroups.length>currentTextIndex&&(currentTextGroup=textGroups[currentTextIndex])),document.getElementById("quizTitle")&&(document.getElementById("quizTitle").textContent=CONFIG.subjectTitles[t.subject]||"Quiz"),updateBreadcrumb(t.subject),document.getElementById("quizPage")&&(document.getElementById("quizPage").style.display="block"),document.getElementById("resultsPage")&&(document.getElementById("resultsPage").style.display="none"),document.getElementById("reviewPage")&&(document.getElementById("reviewPage").style.display="none"),void loadCurrentQuestion()}checkForPausedQuiz();const e=localStorage.getItem("autoStartSubject"),t=localStorage.getItem("autoStartTheme");e&&(localStorage.removeItem("autoStartSubject"),localStorage.removeItem("autoStartTheme"),setTimeout(async()=>{const n=getFilePath(e),o=await loadJsonFile(n);o?(quizData[e]=o,currentSubject=e,t?(currentTheme=t,currentQuiz=o.filter(e=>e.theme===t)):(currentTheme=null,currentQuiz=o),startQuizWithData(e)):alert("Kon quiz data niet laden.")},100))}),window.addEventListener("pageshow",function(e){(e.persisted||window.performance&&2===window.performance.navigation.type)&&(window.location.pathname.endsWith("quiz.html")||(localStorage.removeItem("autoStartSubject"),localStorage.removeItem("autoStartTheme")))});