class SessionRewardManager{constructor(e={}){this.options={grade:e.grade||4,enableLocalStorage:e.enableLocalStorage||!1,...e},this.state={score:0,bonusPoints:0,currentStreak:0,bestStreak:0,correctAnswers:0,totalAnswers:0,milestonesReached:{3:!1,5:!1,10:!1},shieldAvailable:!1,shieldUsed:!1,shieldEarnedAt:null,multiplierActive:!1,multiplierValue:1,lastStreakBeforeMiss:0,stickersUnlocked:[],starLevel:"empty",sessionStartTime:Date.now(),sessionId:this._generateSessionId()},this.STREAK_THRESHOLDS={3:{bonus:2,emoji:"üî•",title:"Op dreef!",tier:"encouraging"},5:{bonus:3,emoji:"üîç",title:"Super-speurder!",tier:"skill"},10:{bonus:5,emoji:"üöÄ",title:"Onverslaanbaar vandaag!",tier:"celebration"}},this.features=this._initializeFeatures(),this.storage=this.options.enableLocalStorage?new SessionStorage:null}_initializeFeatures(){const e=this.options.grade;return{streakCards:e>=3,starAnimations:e>=3,simpleCelebrations:e>=3,comboMultipliers:e>=6,shieldMechanic:e>=6,complexAnimations:e>=6}}_generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}processAnswer(e){return this.state.totalAnswers++,e?this._handleCorrectAnswer():this._handleIncorrectAnswer()}_handleCorrectAnswer(){this.state.correctAnswers++,this.state.currentStreak++,this.state.currentStreak>this.state.bestStreak&&(this.state.bestStreak=this.state.currentStreak);this.state.score+=1;const e=this._checkStreakMilestone(),t=this._checkShieldUnlock(),s={type:"correct",basePoints:1,bonusPoints:0,totalPointsEarned:1,currentStreak:this.state.currentStreak,streakMilestone:null,shieldUnlocked:t,shieldAvailable:this.state.shieldAvailable,multiplierActive:this.state.multiplierActive,multiplierValue:this.state.multiplierValue,score:this.state.score,correctAnswers:this.state.correctAnswers,totalAnswers:this.state.totalAnswers};if(e){const t=this.STREAK_THRESHOLDS[e.threshold];let r=t.bonus;this.features.comboMultipliers&&this.state.multiplierActive&&(r*=this.state.multiplierValue),this.state.bonusPoints+=r,this.state.score+=r,s.bonusPoints=r,s.totalPointsEarned=1+r,s.streakMilestone={threshold:e.threshold,emoji:t.emoji,title:t.title,tier:t.tier,bonusPoints:r,multiplierApplied:this.state.multiplierActive},this.features.comboMultipliers&&3===e.threshold&&(this.state.multiplierActive=!0,this.state.multiplierValue=2)}return this._updateMetaRewards(),this._saveToStorage(),s}_handleIncorrectAnswer(){const e=4===this.state.currentStreak,t=this._tryUseShield(),s={type:"incorrect",basePoints:0,bonusPoints:0,totalPointsEarned:0,streakBeforeMiss:this.state.currentStreak,currentStreak:t?this.state.currentStreak:0,streakProtected:t,nearMiss:e,nearMissMessage:e?"Bijna! Nog √©√©n goede en je zit weer in de bonus.":null,shieldUsed:t,shieldAvailable:this.state.shieldAvailable,score:this.state.score,correctAnswers:this.state.correctAnswers,totalAnswers:this.state.totalAnswers};return t||(this.state.lastStreakBeforeMiss=this.state.currentStreak,this.state.currentStreak=0,this.state.multiplierActive&&(this.state.multiplierActive=!1,this.state.multiplierValue=1)),this._saveToStorage(),s}_checkStreakMilestone(){const e=this.state.currentStreak;for(const t of[10,5,3])if(e===t&&!this.state.milestonesReached[t])return this.state.milestonesReached[t]=!0,{threshold:t};return null}_checkShieldUnlock(){return!!this.features.shieldMechanic&&(5===this.state.correctAnswers&&!this.state.shieldEarnedAt&&!this.state.shieldUsed&&(this.state.shieldAvailable=!0,this.state.shieldEarnedAt=Date.now(),!0))}_tryUseShield(){return!!this.features.shieldMechanic&&(!(!(this.state.shieldAvailable&&this.state.currentStreak>=3)||this.state.shieldUsed)&&(this.state.shieldAvailable=!1,this.state.shieldUsed=!0,!0))}_updateMetaRewards(){this._updateStickers(),this._updateStarLevel()}_updateStickers(){const e=this.state.stickersUnlocked;this.state.currentStreak>=3&&!e.includes("streak_3")&&e.push("streak_3"),this.state.currentStreak>=5&&!e.includes("streak_5")&&e.push("streak_5"),this.state.currentStreak>=10&&!e.includes("streak_10")&&e.push("streak_10"),5!==this.state.totalAnswers||5!==this.state.correctAnswers||e.includes("perfect_start")||e.push("perfect_start"),this.state.shieldUsed&&!e.includes("shield_hero")&&e.push("shield_hero")}_updateStarLevel(){if(this.state.totalAnswers<5)return void(this.state.starLevel="empty");const e=this.state.correctAnswers/this.state.totalAnswers;this.state.starLevel=e>=.9?"gold":e>=.75?"silver":e>=.5?"bronze":"empty"}getSessionSummary(){const e=this.state.totalAnswers>0?this.state.correctAnswers/this.state.totalAnswers:0;return{totalScore:this.state.score,basePoints:this.state.correctAnswers,bonusPoints:this.state.bonusPoints,bestStreak:this.state.bestStreak,milestonesReached:Object.keys(this.state.milestonesReached).filter(e=>this.state.milestonesReached[e]).map(e=>parseInt(e)),correctAnswers:this.state.correctAnswers,totalAnswers:this.state.totalAnswers,accuracy:e,stickers:this.state.stickersUnlocked,starLevel:this.state.starLevel,shieldUsed:this.state.shieldUsed,sessionDuration:Date.now()-this.state.sessionStartTime,sessionId:this.state.sessionId}}getStickerMetadata(e){return{streak_3:{emoji:"üî•",title:"Op dreef!",description:"3 goede antwoorden op rij"},streak_5:{emoji:"üîç",title:"Super-speurder!",description:"5 goede antwoorden op rij"},streak_10:{emoji:"üöÄ",title:"Onverslaanbaar!",description:"10 goede antwoorden op rij"},perfect_start:{emoji:"‚≠ê",title:"Perfect begin",description:"Eerste 5 vragen allemaal goed"},shield_hero:{emoji:"üõ°Ô∏è",title:"Schild-held",description:"Je bonus gered met het schild"}}[e]||null}reset(){this.options.grade;this.state={score:0,bonusPoints:0,currentStreak:0,bestStreak:0,correctAnswers:0,totalAnswers:0,milestonesReached:{3:!1,5:!1,10:!1},shieldAvailable:!1,shieldUsed:!1,shieldEarnedAt:null,multiplierActive:!1,multiplierValue:1,lastStreakBeforeMiss:0,stickersUnlocked:[],starLevel:"empty",sessionStartTime:Date.now(),sessionId:this._generateSessionId()},this._saveToStorage()}_saveToStorage(){if(this.storage)try{this.storage.saveSession(this.state)}catch(e){console.warn("Local storage save failed (this is OK):",e)}}loadFromStorage(){if(!this.storage)return!1;try{const e=this.storage.loadSession();if(e)return this.state={...this.state,...e},!0}catch(e){console.warn("Local storage load failed (this is OK):",e)}return!1}}class SessionStorage{constructor(){this.key="sara_session_rewards"}saveSession(e){if(!this._isAvailable())return!1;try{const t={state:e,savedAt:Date.now(),disclaimer:"Blijft bewaard op dit apparaat. Kan verloren gaan bij refresh of op gedeelde apparaten."};return localStorage.setItem(this.key,JSON.stringify(t)),!0}catch(e){return!1}}loadSession(){if(!this._isAvailable())return null;try{const e=localStorage.getItem(this.key);if(!e)return null;const t=JSON.parse(e),s=Date.now()-36e5;return t.savedAt<s?(this.clearSession(),null):t.state}catch(e){return null}}clearSession(){if(this._isAvailable())try{localStorage.removeItem(this.key)}catch(e){}}_isAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}}"undefined"!=typeof module&&module.exports&&(module.exports={SessionRewardManager:SessionRewardManager,SessionStorage:SessionStorage});