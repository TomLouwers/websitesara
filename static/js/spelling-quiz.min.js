let spellingData=[],currentWordIndex=0,score=0,currentWord=null,hasAnswered=!1,attemptCount=0;async function loadSpellingData(){try{localStorage.getItem("autoStartSubject");const e=localStorage.getItem("autoStartTheme"),t=localStorage.getItem("autoStartLevel")||"groep4";document.getElementById("breadcrumbLevel").textContent=formatLevel(t);const n=`spelling-${t}.json`,o=await fetch(n);if(!o.ok)throw new Error(`Could not load ${n}`);spellingData=await o.json(),e&&(spellingData=spellingData.filter(t=>t.theme===e)),shuffleArray(spellingData),spellingData.length>0?showWord(0):(alert("Geen spellingwoorden gevonden voor dit niveau."),window.location.href="index.html")}catch(e){console.error("Error loading spelling data:",e),alert("Kon de spellingdata niet laden. Probeer het opnieuw."),window.location.href="index.html"}}function showWord(e){e>=spellingData.length?showResults():(currentWordIndex=e,currentWord=spellingData[e],hasAnswered=!1,attemptCount=0,updateProgress(),resetUI(),loadAudio(),document.getElementById("spellingInput").focus())}function loadAudio(){const e=document.getElementById("wordAudio");currentWord.audio_url?e.src=currentWord.audio_url:currentWord.audio_file?e.src=`audio/spelling/${currentWord.audio_file}`:console.log("No audio file provided, will use text-to-speech")}function playWordAudio(){const e=document.getElementById("wordAudio"),t=document.getElementById("audioPlayButton"),n=document.getElementById("playIcon");if(e.src&&e.src!==window.location.href)t.classList.add("playing"),n.textContent="volume_up",e.play(),e.onended=function(){t.classList.remove("playing")};else if("speechSynthesis"in window){const e=new SpeechSynthesisUtterance(currentWord.word);e.lang="nl-NL",e.rate=.8,t.classList.add("playing"),e.onend=function(){t.classList.remove("playing")},window.speechSynthesis.speak(e)}else alert("Audio niet beschikbaar. Het woord is: "+currentWord.word)}function checkSpellingAnswer(){if(hasAnswered)return;const e=document.getElementById("spellingInput").value.trim();if(!e)return void alert("Vul eerst een antwoord in!");attemptCount++;e.toLowerCase()===currentWord.word.toLowerCase()?handleCorrectAnswer():handleIncorrectAnswer(e)}function handleCorrectAnswer(){hasAnswered=!0,1===attemptCount&&(score++,updateScore());const e=document.getElementById("spellingInput");e.classList.add("correct"),e.disabled=!0,document.getElementById("checkButton").disabled=!0,showFeedback(!0)}function handleIncorrectAnswer(e){const t=document.getElementById("spellingInput");attemptCount>=3?(hasAnswered=!0,t.classList.add("incorrect"),t.disabled=!0,document.getElementById("checkButton").disabled=!0,showFeedback(!1)):(t.classList.add("incorrect"),t.style.animation="shake 0.4s",setTimeout(()=>{t.style.animation="",t.classList.remove("incorrect")},400),1===attemptCount?alert("Probeer het nog een keer! Luister goed naar het woord."):2===attemptCount&&alert("Nog Ã©Ã©n kans! Let goed op alle letters."),t.select())}function showFeedback(e){const t=document.getElementById("feedbackSection"),n=document.getElementById("feedbackIcon"),o=document.getElementById("feedbackTitle"),l=document.getElementById("correctSpellingDisplay"),r=document.getElementById("explanationContent"),a=document.getElementById("visualExplanation");e?(t.className="feedback-section show correct",n.textContent="ðŸŽ‰",o.textContent=1===attemptCount?"Perfect! Helemaal goed!":"Goed gedaan!"):(t.className="feedback-section show incorrect",n.textContent="ðŸ’¡",o.textContent="Bijna! Hier is de juiste spelling:"),l.textContent=currentWord.word,currentWord.visual_explanation?(a.style.display="block",r.innerHTML=formatExplanation(currentWord.visual_explanation)):a.style.display="none"}function formatExplanation(e){if("string"==typeof e)return`<p>${e}</p>`;if(Array.isArray(e))return"<ul>"+e.map(e=>`<li>${e}</li>`).join("")+"</ul>";if("object"==typeof e){let t="";return e.rule&&(t+=`<p><strong>Regel:</strong> ${e.rule}</p>`),e.examples&&(t+="<p><strong>Voorbeelden:</strong></p>",t+="<ul>"+e.examples.map(e=>`<li>${e}</li>`).join("")+"</ul>"),e.tip&&(t+=`<p><strong>ðŸ’¡ Tip:</strong> ${e.tip}</p>`),t}return""}function nextWord(){showWord(currentWordIndex+1)}function resetUI(){const e=document.getElementById("spellingInput");e.value="",e.className="spelling-input",e.disabled=!1;document.getElementById("checkButton").disabled=!1;document.getElementById("feedbackSection").classList.remove("show");document.getElementById("audioPlayButton").classList.remove("playing")}function updateProgress(){const e=document.getElementById("progressLabel"),t=document.getElementById("progressBarFill"),n=spellingData.length,o=currentWordIndex+1,l=o/n*100;e.textContent=`Woord ${o} van ${n}`,t.style.width=`${l}%`}function updateScore(){document.getElementById("totalCorrect").textContent=score}function showResults(){const e=Math.round(score/spellingData.length*100);localStorage.setItem("spellingQuizScore",score),localStorage.setItem("spellingQuizTotal",spellingData.length),localStorage.setItem("spellingQuizPercentage",e),alert(`Quiz voltooid!\n\nScore: ${score} / ${spellingData.length} (${e}%)`),window.location.href="index.html"}function pauseSpellingQuiz(){confirm("Wil je de quiz pauzeren? Je kunt later verdergaan.")&&(localStorage.setItem("spellingQuizState",JSON.stringify({data:spellingData,currentIndex:currentWordIndex,score:score})),window.location.href="index.html")}function stopSpellingQuiz(){confirm("Weet je zeker dat je wilt stoppen? Je voortgang gaat verloren.")&&(localStorage.removeItem("spellingQuizState"),window.location.href="index.html")}function formatLevel(e){return e.replace("groep","Groep ").replace("-"," ")}function shuffleArray(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}document.addEventListener("DOMContentLoaded",function(){loadSpellingData()}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("spellingInput");e&&e.addEventListener("keypress",function(e){"Enter"!==e.key||hasAnswered||checkSpellingAnswer()})});const style=document.createElement("style");style.textContent="\n    @keyframes shake {\n        0%, 100% { transform: translateX(0); }\n        25% { transform: translateX(-10px); }\n        75% { transform: translateX(10px); }\n    }\n",document.head.appendChild(style);