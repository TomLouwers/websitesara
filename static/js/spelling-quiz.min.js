class SpellingQuiz extends BaseQuizModule{constructor(){super({storagePrefix:"spelling_quiz_",enableProgressTracking:!0}),this.attemptCount=0,this.maxAttempts=3,this.currentAudioPath=null}async init(){try{this.cacheElements({spellingInput:"spellingInput",checkButton:"checkButton",audioPlayButton:"audioPlayButton",playIcon:"playIcon",nextButton:"nextButton",feedbackSection:"feedbackSection",feedbackIcon:"feedbackIcon",feedbackTitle:"feedbackTitle",correctSpellingDisplay:"correctSpellingDisplay",explanationContent:"explanationContent",visualExplanation:"visualExplanation",progressLabel:"progressLabel",progressBarFill:"progressBarFill",scoreDisplay:"scoreDisplay",breadcrumbLevel:"breadcrumbLevel"}),await this.loadSpellingData(),this.attachEventListeners(),this.showWord(0)}catch(t){console.error("Error initializing spelling quiz:",t),this.showError("Kon de spellingquiz niet laden. Probeer het opnieuw.")}}async loadSpellingData(){try{storage.get("autoStartSubject");const t=storage.get("autoStartTheme"),e=storage.get("autoStartLevel","groep4");this.elements.breadcrumbLevel&&(this.elements.breadcrumbLevel.textContent=this.formatLevel(e));const s=`spelling-${e}.json`,n=await fetch(s);if(!n.ok)throw new Error(`HTTP ${n.status}: Could not load ${s}`);let o=await n.json();if(!Array.isArray(o)||0===o.length)throw new Error("Invalid or empty spelling data");if(t&&(o=o.filter(e=>e.theme===t)),this.shuffleArray(o),this.initialize(o),0===o.length)throw new Error("No spelling words found for this level/theme")}catch(t){throw console.error("Error loading spelling data:",t),t}}attachEventListeners(){const{spellingInput:t,checkButton:e,audioPlayButton:s,nextButton:n}=this.elements;e&&e.addEventListener("click",()=>this.checkAnswer()),t&&t.addEventListener("keypress",t=>{"Enter"!==t.key||this.state.hasAnswered||this.checkAnswer()}),s&&s.addEventListener("click",()=>this.playAudio()),n&&n.addEventListener("click",()=>this.next())}showWord(t){t>=this.state.totalQuestions?this.showResults():(this.state.currentIndex=t,this.loadCurrentItem(),this.attemptCount=0,this.updateProgress(),this.resetWordUI(),this.loadAudioPath(),this.elements.spellingInput?.focus())}loadAudioPath(){const t=this.state.currentItem;t&&(t.audio_url?this.currentAudioPath=t.audio_url:t.audio_file?this.currentAudioPath=`audio/spelling/${t.audio_file}`:this.currentAudioPath=null)}async playAudio(){const{audioPlayButton:t,playIcon:e}=this.elements,s=this.state.currentItem;if(s)try{t&&t.classList.add("playing"),e&&(e.textContent="volume_up"),await audioManager.playAudio(this.currentAudioPath,s.word,{timeout:CONFIG.ui.audioTimeout,onProgress:null}),t&&t.classList.remove("playing"),e&&(e.textContent="play_arrow")}catch(e){console.warn("Audio playback error:",e),t&&t.classList.remove("playing"),"speechSynthesis"in window||alert(`Audio niet beschikbaar. Het woord is: ${s.word}`)}}checkAnswer(){if(this.state.hasAnswered)return;const{spellingInput:t}=this.elements,e=t?.value.trim();if(!e)return void alert(CONFIG.feedback.noAnswer.openEnded);this.attemptCount++;const s=this.state.currentItem;this.checkAnswerLogic(e,s.word,!1)?this.handleCorrectAnswer():this.handleIncorrectAnswer(e)}checkAnswerLogic(t,e,s=!1){return(s?t.trim():t.trim().toLowerCase())===(s?e.trim():e.trim().toLowerCase())}handleCorrectAnswer(){this.state.hasAnswered=!0,1===this.attemptCount&&(this.state.score++,this.updateScore());const{spellingInput:t,checkButton:e}=this.elements;t&&(t.classList.add("correct"),t.disabled=!0),e&&(e.disabled=!0),this.showFeedback(!0)}handleIncorrectAnswer(t){const{spellingInput:e,checkButton:s}=this.elements;if(this.attemptCount>=this.maxAttempts)this.state.hasAnswered=!0,e&&(e.classList.add("incorrect"),e.disabled=!0),s&&(s.disabled=!0),this.showFeedback(!1),this.state.wrongAnswers||(this.state.wrongAnswers=[]),this.state.wrongAnswers.push({word:this.state.currentItem.word,userAnswer:t,attemptCount:this.attemptCount});else{e&&(e.classList.add("incorrect"),e.style.animation="shake 0.4s",setTimeout(()=>{e.style.animation="",e.classList.remove("incorrect")},400),e.select());const t=[null,"Probeer het nog een keer! Luister goed naar het woord.","Nog Ã©Ã©n kans! Let goed op alle letters."];t[this.attemptCount]&&alert(t[this.attemptCount])}}showFeedback(t){const{feedbackSection:e,feedbackIcon:s,feedbackTitle:n,correctSpellingDisplay:o,explanationContent:r,visualExplanation:i}=this.elements;if(!e)return;const a=this.state.currentItem;t?(e.className="feedback-section show correct",s&&(s.textContent="ðŸŽ‰"),n&&(n.textContent=1===this.attemptCount?"Perfect! Helemaal goed!":"Goed gedaan!")):(e.className="feedback-section show incorrect",s&&(s.textContent="ðŸ’¡"),n&&(n.textContent="Bijna! Hier is de juiste spelling:")),o&&(o.textContent=a.word),a.visual_explanation&&i&&r?(i.style.display="block",r.innerHTML=this.formatExplanation(a.visual_explanation)):i&&(i.style.display="none")}formatExplanation(t){if("string"==typeof t)return`<p>${t}</p>`;if(Array.isArray(t))return"<ul>"+t.map(t=>`<li>${t}</li>`).join("")+"</ul>";if("object"==typeof t){let e="";return t.rule&&(e+=`<p><strong>Regel:</strong> ${t.rule}</p>`),t.examples&&(e+="<p><strong>Voorbeelden:</strong></p>",e+="<ul>"+t.examples.map(t=>`<li>${t}</li>`).join("")+"</ul>"),t.tip&&(e+=`<p><strong>ðŸ’¡ Tip:</strong> ${t.tip}</p>`),e}return""}next(){this.nextItem()?this.showWord(this.state.currentIndex):this.showResults()}resetWordUI(){DOMUtils.resetFormElements(["spellingInput","checkButton"]);const{feedbackSection:t,audioPlayButton:e}=this.elements;t&&t.classList.remove("show"),e&&e.classList.remove("playing")}updateProgress(){const{progressLabel:t,progressBarFill:e}=this.elements,s=this.state.currentIndex+1,n=this.state.totalQuestions,o=s/n*100;t&&(t.textContent=`${s} / ${n}`),e&&(e.style.width=`${o}%`)}updateScore(){const{scoreDisplay:t}=this.elements;t&&(t.textContent=`Score: ${this.state.score} / ${this.state.totalQuestions}`)}showResults(){const t=this.getResults();storage.set("spelling_quiz_results",t),alert(`Quiz voltooid!\n\nScore: ${t.score} / ${t.total} (${t.percentage}%)`),window.location.href="index.html"}showError(t){alert(t),window.location.href="index.html"}formatLevel(t){return{groep3:"Groep 3",groep4:"Groep 4",groep5:"Groep 5",groep6:"Groep 6",groep7:"Groep 7",groep8:"Groep 8"}[t]||t}shuffleArray(t){for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}}document.addEventListener("DOMContentLoaded",async function(){const t=new SpellingQuiz;await t.init(),window.spellingQuiz=t});