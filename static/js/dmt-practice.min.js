class DMTPractice{constructor(){this.config={baseTempos:{A:720,B:1e3,C:1350},tempoMultipliers:{rustig:1.25,normaal:1,snel:.8},rampUp:{warmupWords:10,transitionWords:5,warmupSlowdown:.15},lengthAdjustments:{medium:{minLength:12,adjustment:150},long:{minLength:16,adjustment:300}}},this.state={selectedList:null,selectedTempo:null,selectedGrade:null,words:[],currentIndex:0,isRunning:!1,isPaused:!1,startTime:null,totalWordsSeen:0,timeRemaining:60},this.intervalId=null,this.countdownTimerId=null,this.wordLists={},this.normingData=null,this.init()}async init(){await this.loadData(),this.setupEventListeners(),this.checkURLParams()}checkURLParams(){const t=new URLSearchParams(window.location.search),e=t.get("list"),s=t.get("tempo");e&&s&&(this.state.selectedList=e.toUpperCase(),this.state.selectedTempo=s.toLowerCase(),this.wordLists[this.state.selectedList]&&this.config.tempoMultipliers[this.state.selectedTempo]?this.showPracticeScreen():(console.error("Invalid URL parameters:",{list:e,tempo:s}),alert("Ongeldige parameters. Kies opnieuw je lijst en tempo.")))}async loadData(){try{const t=CONFIG.subjectFilePaths?.dmt,e=[{key:"A",config:t?.listA},{key:"B",config:t?.listB},{key:"C",config:t?.listC}];if(!t||e.some(t=>!t.config))throw new Error("DMT paden niet gevonden in configuratie");const s=await Promise.all(e.map(({config:t})=>fetch(t.core))),n=await Promise.all(e.map(({config:t})=>fetch(t.support))),a=[...s,...n].find(t=>!t.ok);if(a)throw new Error(`Failed to load file: ${a.url} (${a.status})`);const i=await Promise.all(s.map(t=>t.json())),d=await Promise.all(n.map(t=>t.json()));this.wordLists={A:this.transformDmtList(i[0],d[0]),B:this.transformDmtList(i[1],d[1]),C:this.transformDmtList(i[2],d[2])},this.normingData=null,console.log("DMT data loaded:",{A:this.wordLists.A.length,B:this.wordLists.B.length,C:this.wordLists.C.length})}catch(t){console.error("Error loading DMT data:",t),alert("Er is een fout opgetreden bij het laden van de woordenlijsten.")}}transformDmtList(t,e){return(t.items||[]).map(t=>{const s=e?.items?.find(e=>e.item_id===t.id||e.id===t.id);return{...t,feedback:s?.feedback??t.feedback,adaptive:s?.adaptive??t.adaptive,hints:s?.hints??t.hints}}).map(t=>{const e=t.question;return"string"==typeof e?e:e?.text||""})}setupEventListeners(){this.state.selectedTempo="normaal",document.querySelectorAll(".dmt-list-btn").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".dmt-list-btn").forEach(t=>{t.classList.remove("selected","intensity-1","intensity-2","intensity-3")}),t.classList.add("selected");const e=t.dataset.intensity;e&&t.classList.add(`intensity-${e}`),this.state.selectedList=t.dataset.list,this.updateStartButton(),this.updateSummary()})}),document.querySelectorAll(".dmt-tempo-btn").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".dmt-tempo-btn").forEach(t=>t.classList.remove("selected")),t.classList.add("selected"),this.state.selectedTempo=t.dataset.tempo,this.updateStartButton(),this.updateSummary()})});const t=document.getElementById("speedSlider");t&&t.addEventListener("input",t=>{this.handleSliderChange(parseInt(t.target.value))}),document.querySelectorAll(".dmt-speed-marker").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".dmt-speed-marker").forEach(t=>t.classList.remove("selected")),t.classList.add("selected"),this.state.selectedTempo=t.dataset.tempo,document.querySelectorAll(".dmt-tempo-btn").forEach(e=>{e.dataset.tempo===t.dataset.tempo?e.classList.add("selected"):e.classList.remove("selected")}),this.updateStartButton(),this.updateSummary()})}),document.getElementById("startBtn").addEventListener("click",()=>{this.showPracticeScreen()}),document.getElementById("wordStartBtn").addEventListener("click",()=>{this.startPractice()}),document.querySelectorAll(".dmt-grade-btn").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".dmt-grade-btn").forEach(t=>t.classList.remove("selected")),t.classList.add("selected"),this.state.selectedGrade=parseInt(t.dataset.grade),this.updateWordStartButton()})}),document.getElementById("pauseBtn").addEventListener("click",()=>{this.togglePause()}),document.getElementById("tempoBtn").addEventListener("click",()=>{this.showTempoModal()}),document.getElementById("stopBtn").addEventListener("click",()=>{this.stopPractice()}),document.querySelectorAll(".dmt-tempo-modal-btn").forEach(t=>{t.addEventListener("click",()=>{this.changeTempo(t.dataset.tempo)})}),document.getElementById("tempoModalClose").addEventListener("click",()=>{this.hideTempoModal()}),document.getElementById("restartBtn").addEventListener("click",()=>{this.restart()}),document.getElementById("homeBtn").addEventListener("click",()=>{window.location.href="index.html"})}updateStartButton(){const t=document.getElementById("startBtn");this.state.selectedList&&this.state.selectedTempo?t.disabled=!1:t.disabled=!0}handleSliderChange(t){const e=["rustig","normaal","snel"],s=["Schildpad","Haas","Raket"];this.state.selectedTempo=e[t];const n=document.getElementById("currentSpeed");n&&(n.textContent=s[t]);const a=["labelSlow","labelNormal","labelFast"];["emojiSlow","emojiNormal","emojiFast"].forEach((e,s)=>{const n=document.getElementById(e),i=document.getElementById(a[s]);n&&i&&(s===t?(n.classList.add("active"),i.classList.add("active")):(n.classList.remove("active"),i.classList.remove("active")))}),document.querySelectorAll(".dmt-tempo-btn").forEach(s=>{s.dataset.tempo===e[t]?s.classList.add("selected"):s.classList.remove("selected")}),this.updateStartButton(),this.updateSummary()}updateSummary(){const t=document.getElementById("summarySentence");if(!t)return;if(!this.state.selectedList||!this.state.selectedTempo)return void t.classList.remove("show");const e={A:"Start-woorden",B:"Groei-woorden",C:"Knappe woorden"}[this.state.selectedList],s={rustig:"op het tempo Rustig aan",normaal:"op het tempo Gaat goed",snel:"op het tempo Gas erop"}[this.state.selectedTempo];t.textContent=`Je gaat ${e} lezen ${s}!`,t.classList.add("show")}updateWordStartButton(){const t=document.getElementById("wordStartBtn");this.state.selectedGrade?t.disabled=!1:t.disabled=!0}showPracticeScreen(){this.state.words=[...this.wordLists[this.state.selectedList]],this.state.currentIndex=0,this.state.totalWordsSeen=0,this.state.timeRemaining=60,document.getElementById("setupScreen").style.display="none",document.getElementById("practiceScreen").style.display="block",this.updateBreadcrumb(),this.updateTempoIndicator(),document.getElementById("wordStartBtn").classList.add("show"),document.getElementById("wordDisplay").style.display="none",document.getElementById("pauseBtn").disabled=!0,document.getElementById("tempoBtn").disabled=!0,document.getElementById("stopBtn").disabled=!0}startPractice(){this.state.startTime=Date.now(),this.state.isRunning=!0,this.state.isPaused=!1,document.getElementById("wordStartBtn").classList.remove("show"),document.getElementById("gradeSelector").classList.add("hidden"),document.getElementById("wordDisplay").style.display="block",document.getElementById("pauseBtn").disabled=!1,document.getElementById("tempoBtn").disabled=!1,document.getElementById("stopBtn").disabled=!1,this.startCountdownTimer(),this.showNextWord(),this.scheduleNextWord()}startCountdownTimer(){this.updateTimerDisplay(),this.countdownTimerId=setInterval(()=>{this.state.isPaused||(this.state.timeRemaining--,this.updateTimerDisplay(),this.state.timeRemaining<=0&&this.stopPractice())},1e3)}updateTimerDisplay(){const t=document.getElementById("timerDisplay");t&&(t.textContent=`${this.state.timeRemaining}s`)}updateBreadcrumb(){const t={rustig:"Rustig aan",normaal:"Gaat goed",snel:"Gas erop"},e=document.getElementById("breadcrumbInfo");e&&(e.textContent=`Lijst ${this.state.selectedList} - ${t[this.state.selectedTempo]}`)}showNextWord(){if(this.state.currentIndex>=this.state.words.length)return void this.showResults();const t=this.state.words[this.state.currentIndex];document.getElementById("wordDisplay").textContent=t,this.state.totalWordsSeen++,document.getElementById("wordCount").textContent=this.state.totalWordsSeen}scheduleNextWord(){if(!this.state.isRunning||this.state.isPaused)return;const t=this.calculateInterval(this.state.currentIndex);this.intervalId=setTimeout(()=>{this.state.currentIndex++,this.showNextWord(),this.scheduleNextWord()},t)}calculateInterval(t){let e=this.config.baseTempos[this.state.selectedList]*this.config.tempoMultipliers[this.state.selectedTempo];const{warmupWords:s,transitionWords:n,warmupSlowdown:a}=this.config.rampUp;if(t<s)e*=1+a;else if(t<s+n){const i=e*(1+a);e=i+(e-i)*((t-s)/n)}const i=this.state.words[t].length;return i>=this.config.lengthAdjustments.long.minLength?e+=this.config.lengthAdjustments.long.adjustment:i>=this.config.lengthAdjustments.medium.minLength&&(e+=this.config.lengthAdjustments.medium.adjustment),Math.round(e)}togglePause(){this.state.isPaused=!this.state.isPaused;document.getElementById("pauseBtn");const t=document.getElementById("pauseBtnIcon"),e=document.getElementById("pauseBtnText"),s=document.getElementById("pausedOverlay");this.state.isPaused?(this.intervalId&&(clearTimeout(this.intervalId),this.intervalId=null),t.textContent="â–¶",e.textContent="Hervatten",s.classList.add("show")):(t.textContent="â¸",e.textContent="Pauze",s.classList.remove("show"),this.scheduleNextWord())}showTempoModal(){this.state.isRunning&&!this.state.isPaused&&this.togglePause(),document.getElementById("tempoModal").classList.add("show"),document.querySelectorAll(".dmt-tempo-modal-btn").forEach(t=>{t.dataset.tempo===this.state.selectedTempo?t.classList.add("selected"):t.classList.remove("selected")})}hideTempoModal(){document.getElementById("tempoModal").classList.remove("show"),this.state.isRunning&&this.state.isPaused&&this.togglePause()}changeTempo(t){this.state.selectedTempo=t,this.updateTempoIndicator(),this.hideTempoModal()}updateTempoIndicator(){document.getElementById("tempoEmoji").textContent={rustig:"ðŸ¢",normaal:"ðŸ™‚",snel:"ðŸš€"}[this.state.selectedTempo],document.getElementById("tempoLabel").textContent={rustig:"Rustig aan",normaal:"Gaat goed",snel:"Gas erop"}[this.state.selectedTempo]}stopPractice(){this.state.isRunning=!1,this.intervalId&&(clearTimeout(this.intervalId),this.intervalId=null),this.countdownTimerId&&(clearInterval(this.countdownTimerId),this.countdownTimerId=null),this.showResults()}showResults(){this.state.isRunning=!1,this.intervalId&&(clearTimeout(this.intervalId),this.intervalId=null),this.countdownTimerId&&(clearInterval(this.countdownTimerId),this.countdownTimerId=null);const t=this.state.totalWordsSeen,e=this.state.startTime?(Date.now()-this.state.startTime)/1e3:0,s=e>0?Math.round(t/e*60):0;document.getElementById("totalWordsResult").textContent=t,document.getElementById("wordsPerMinuteResult").textContent=s,this.displayNorming(s),document.getElementById("practiceScreen").style.display="none",document.getElementById("resultsScreen").style.display="block"}displayNorming(t){if(!this.state.selectedGrade||!this.normingData)return;const e=`group_${this.state.selectedGrade}`,s=this.state.selectedList,n=this.normingData.norms[s];if(!n||!n[e])return;const a=n[e];let i="average",d="Goed bezig!",o="average";t<=a.weak_max?(i="developing",d="Je bent aan het groeien! ðŸŒ±",o="developing"):t>=a.good_min+20?(i="excellent",d="Supergoed! ðŸŒŸ",o="excellent"):t>=a.good_min&&(i="good",d="Knap gedaan! ðŸ‘",o="good");const l=document.getElementById("normingBand");l.textContent=d,l.className=`dmt-norming-band ${o}`;let r="";"developing"===i?r="Je bent goed bezig met oefenen! Met meer oefening word je steeds sneller en beter. Je kunt het! ðŸ’ª":"average"===i?r=`Je leest lekker door! Je score ligt binnen het gemiddelde voor jouw leeftijd (${a.average_min}-${a.average_max} woorden/min). Ga zo door! ðŸ‘`:"good"===i?r="Wat lees je goed! Je score ligt boven het gemiddelde voor jouw leeftijd. Geweldig gedaan! ðŸŽ‰":"excellent"===i&&(r="Wauw! Je bent een super snelle lezer! Je score is fantastisch voor jouw leeftijd. Heel knap! ðŸŒŸâ­"),document.getElementById("normingExplanation").textContent=r}restart(){window.location.href="level-selector.html?subject=dmt"}}document.addEventListener("DOMContentLoaded",()=>{window.dmtPractice=new DMTPractice});